<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - LSPU Emergency Response</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Professional Dashboard Layout */
        body {
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Header */
        .dashboard-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: #fbbf24;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 18px;
        }
        
        .company-name {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }
        
        .header-center {
            flex: 1;
            max-width: 400px;
            margin: 0 40px;
        }
        
        .search-bar {
            width: 100%;
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: #f9fafb;
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .notification-badge {
            position: relative;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #fbbf24;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 32px;
            height: 32px;
            background: #6b7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* Sidebar */
        .sidebar {
            width: 250px;
            background: #f8f9fa;
            padding: 80px 0 20px 0;
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid #e5e7eb;
        }
        
        .nav-item {
            display: block;
            width: 100%;
            padding: 12px 20px;
            text-align: left;
            background: transparent;
            border: none;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 0;
            margin: 0;
            font-size: 14px;
        }
        
        .nav-item:hover {
            background: #e5e7eb;
            color: #374151;
        }
        
        .nav-item.active {
            background: #fbbf24;
            color: white;
            border-radius: 8px;
            margin: 4px 16px;
            width: calc(100% - 32px);
        }
        
        .nav-item.active:hover {
            background: #f59e0b;
        }
        
        /* Main Content */
        .main-content {
            margin-left: 250px;
            margin-top: 60px;
            padding: 20px;
            min-height: calc(100vh - 60px);
            background: white;
            width: calc(100vw - 250px - 40px);
            max-width: none;
        }
        
        /* Map Section */
        .map-section {
            width: 100%;
            max-width: none;
        }
        
        .map-container {
            width: 100% !important;
            max-width: none !important;
        }
        
        /* Ensure map section takes full width */
        #map-section .card {
            width: 100%;
            max-width: none;
        }
        
        #map-section .card-header {
            width: 100%;
        }
        
        /* Remove any constraints on the map */
        #map {
            width: 100% !important;
            min-width: 100%;
        }

        /* Responsive Design Enhancements */
        @media (max-width: 768px) {
            .dashboard-container {
                flex-direction: column;
            }
            
            .sidebar {
                position: fixed;
                top: 60px;
                left: -250px;
                width: 250px;
                height: calc(100vh - 60px);
                transition: left 0.3s ease;
                z-index: 999;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .main-content {
                width: 100%;
                margin-left: 0;
                padding: 20px 15px;
            }
            
            .dashboard-header {
                padding: 0 15px;
            }
            
            .header-center {
                display: none;
            }
            
            .nav-item {
                padding: 15px 20px;
                font-size: 16px;
            }
            
            .card {
                margin-bottom: 15px;
            }
            
            .grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .btn {
                padding: 10px 16px;
                font-size: 14px;
            }
            
            .data-table {
                overflow-x: auto;
            }
            
            .data-table table {
                min-width: 600px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 15px 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .nav-item {
                padding: 12px 15px;
                font-size: 14px;
            }
        }

        /* PWA Optimizations */
        @media (display-mode: standalone) {
            .dashboard-header {
                padding-top: env(safe-area-inset-top);
            }
            
            .main-content {
                padding-bottom: env(safe-area-inset-bottom);
            }
        }

        /* Dark theme support */
        @media (prefers-color-scheme: dark) {
            .dark-theme {
                background: #1a1a1a;
                color: #ffffff;
            }
            
            .dark-theme .card {
                background: #2d2d2d;
                border-color: #404040;
            }
            
            .dark-theme .nav-item {
                color: #ffffff;
            }
            
            .dark-theme .nav-item:hover {
                background: #404040;
            }
            
            .dark-theme .nav-item.active {
                background: #fbbf24;
                color: #000000;
            }
        }

        /* Touch optimizations for mobile */
        @media (hover: none) and (pointer: coarse) {
            .btn {
                min-height: 44px;
                min-width: 44px;
            }
            
            .nav-item {
                min-height: 44px;
            }
            
            .btn-action {
                min-height: 44px;
                min-width: 44px;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn {
                border: 2px solid currentColor;
            }
            
            .nav-item.active {
                border: 2px solid #000000;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Print styles */
        @media print {
            .sidebar,
            .dashboard-header,
            .btn,
            .pagination {
                display: none !important;
            }
            
            .main-content {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            .card {
                break-inside: avoid;
                margin-bottom: 20px;
            }
        }
        
        .admin-section {
            display: none;
        }
        
        .admin-section.active {
            display: block;
        }
        
        /* Table Styling */
        .data-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-title {
            font-size: 24px;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }
        
        .table-filters {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background: #f9fafb;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 14px;
        }
        
        .table td {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        
        .table tr:hover {
            background: #f9fafb;
        }
        
        .checkbox {
            width: 16px;
            height: 16px;
            accent-color: #fbbf24;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-action {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .btn-delete {
            background: #ef4444;
            color: white;
        }
        
        .btn-edit {
            background: #fbbf24;
            color: white;
        }
        
        .btn-archive {
            background: #fbbf24;
            color: white;
        }
        
        .btn-view {
            background: #3b82f6;
            color: white;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-top: 1px solid #e5e7eb;
        }
        
        .pagination-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .pagination-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-size {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .page-size button {
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-size button.active {
            background: #fbbf24;
            color: white;
            border-color: #fbbf24;
        }
        
        .page-numbers {
            display: flex;
            gap: 5px;
        }
        
        .page-number {
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        
        .page-number.active {
            background: #fbbf24;
            color: white;
            border-color: #fbbf24;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 14px;
            border-top: 1px solid #e5e7eb;
            margin-top: 40px;
        }
    </style>
</head>
<body>
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-left">
            <div class="logo">üö®</div>
            <div class="company-name">LSPU Emergency Response</div>
        </div>
        <div class="header-center">
            <input type="text" class="search-bar" placeholder="Search">
        </div>
        <div class="header-right">
            <button class="notification-badge">
                üîî
                <span class="notification-count">10</span>
            </button>
            <div class="user-profile">
                <div class="user-avatar">A</div>
                <span>Admin User</span>
            </div>
            <button class="btn btn-sm" onclick="signOut()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                üö™ Sign Out
            </button>
            <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" style="display: none;">
                ‚ò∞
            </button>
        </div>
    </div>

    <!-- Dashboard Container -->
    <div class="dashboard-container">
        <!-- Left Sidebar -->
        <div class="sidebar">
            <nav>
                <button onclick="showSection('dashboard')" class="nav-item active" id="nav-dashboard">
                    üìä Dashboard
                </button>
                <button onclick="showSection('reports')" class="nav-item" id="nav-reports">
                    üìù Reports
                </button>
                <button onclick="showSection('map')" class="nav-item" id="nav-map">
                    üó∫Ô∏è Map View
                </button>
                <button onclick="showSection('archived')" class="nav-item" id="nav-archived">
                    üìÅ Archived
                </button>
                <button onclick="showSection('analytics')" class="nav-item" id="nav-analytics">
                    üìà Analytics
                </button>
                <button onclick="showSection('settings')" class="nav-item" id="nav-settings">
                    ‚öôÔ∏è Settings
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Alerts Container -->
            <div class="alerts-container"></div>

                <!-- Dashboard Section -->
                <div id="dashboard-section" class="admin-section active">
                    <!-- Statistics Overview -->
                    <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
                <div class="text-3xl mb-2">üìä</div>
                <div class="text-2xl font-bold text-blue-600" id="totalReports">0</div>
                <div class="text-sm text-gray-600">Total Reports</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">‚è≥</div>
                <div class="text-2xl font-bold text-yellow-600" id="pendingCount">0</div>
                <div class="text-sm text-gray-600">Pending</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">üîÑ</div>
                <div class="text-2xl font-bold text-blue-600" id="processingCount">0</div>
                <div class="text-sm text-gray-600">Processing</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">‚úÖ</div>
                <div class="text-2xl font-bold text-green-600" id="completedCount">0</div>
                <div class="text-sm text-gray-600">Completed</div>
            </div>
        </section>

        <!-- Emergency Type Distribution -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Emergency Types</h3>
                </div>
                <div id="emergencyTypesChart" class="space-y-2">
                    <!-- Chart will be populated dynamically -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Response Times</h3>
                </div>
                <div id="responseTimesChart" class="space-y-2">
                    <!-- Chart will be populated dynamically -->
                </div>
            </div>
        </section>

        <!-- Recent Activity -->
        <section class="card mb-8">
            <div class="card-header">
                <h3 class="card-title">üïí Recent Activity</h3>
                <p class="card-subtitle">Latest emergency reports and updates</p>
            </div>
            <div class="p-6">
                <div id="recent-activity" class="space-y-3">
                    <!-- Recent activity will be loaded here -->
                </div>
            </div>
        </section>

                </div>
                
                <!-- Reports Section -->
                <div id="reports-section" class="admin-section">
                    <!-- Table Header -->
                    <div class="data-table">
                        <div class="table-header">
                            <h2 class="table-title">Emergency Reports</h2>
                            <div class="table-filters">
                                <div class="filter-group">
                                    <input type="date" class="filter-input" placeholder="Start Date">
                                    <input type="date" class="filter-input" placeholder="End Date">
                                </div>
                                <input type="text" class="filter-input" placeholder="Search reports...">
                            </div>
                        </div>

                        <!-- Filters and Actions -->
                        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb;">
                            <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                                <select id="statusFilter" class="filter-input" style="width: 150px;">
                                    <option value="">All Status</option>
                                    <option value="pending">Pending</option>
                                    <option value="processing">Processing</option>
                                    <option value="classified">Classified</option>
                                    <option value="assigned">Assigned</option>
                                    <option value="in_progress">In Progress</option>
                                    <option value="completed">Completed</option>
                                    <option value="archived">Archived</option>
                                </select>
                                
                                <select id="typeFilter" class="filter-input" style="width: 150px;">
                                    <option value="">All Types</option>
                                    <option value="fire">Fire</option>
                                    <option value="medical">Medical</option>
                                    <option value="accident">Accident</option>
                                    <option value="flood">Flood</option>
                                    <option value="earthquake">Earthquake</option>
                                    <option value="storm">Storm</option>
                                    <option value="other">Other</option>
                                </select>
                                
                                <select id="priorityFilter" class="filter-input" style="width: 150px;">
                                    <option value="">All Priorities</option>
                                    <option value="high">High Priority</option>
                                    <option value="medium">Medium Priority</option>
                                    <option value="low">Low Priority</option>
                                </select>
                                
                                <button onclick="loadReports()" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer;">üîÑ Refresh</button>
                                <button onclick="addSampleReports()" style="padding: 8px 16px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer;">üìç Add Sample Reports</button>
                                <button onclick="clearSampleReports()" style="padding: 8px 16px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer;">üóëÔ∏è Clear Sample</button>
                                <button onclick="exportReports()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">üìä Export</button>
                                <button onclick="showArchivedReports()" style="padding: 8px 16px; background: #f59e0b; color: white; border: none; border-radius: 6px; cursor: pointer;">üìÅ Archived</button>
                            </div>
                        </div>

                        <!-- Reports Table -->
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" class="checkbox">
                                        </th>
                                        <th>COMPANY NAME</th>
                                        <th>PERSON IN CHARGE</th>
                                        <th>LOCATION</th>
                                        <th>CONTACT NUMBER</th>
                                        <th>EMAIL</th>
                                        <th>STATUS</th>
                                        <th style="width: 120px;">ACTIONS</th>
                                    </tr>
                                </thead>
                                <tbody id="reportsTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: #6b7280;">
                                            Loading reports...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div class="pagination">
                            <div class="pagination-left">
                                <span style="color: #6b7280; font-size: 14px;">Number of list</span>
                                <div class="page-size">
                                    <button>5</button>
                                    <button class="active">10</button>
                                    <button>20</button>
                                </div>
                            </div>
                            <div class="pagination-right">
                                <div class="page-numbers">
                                    <button class="page-number">‚Äπ</button>
                                    <button class="page-number active">1</button>
                                    <button class="page-number">2</button>
                                    <button class="page-number">3</button>
                                    <button class="page-number">4</button>
                                    <button class="page-number">5</button>
                                    <button class="page-number">-</button>
                                    <button class="page-number">20</button>
                                    <button class="page-number">‚Ä∫</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Map Section -->
                <div id="map-section" class="admin-section map-section">
                    <!-- Emergency Locations Map -->
                    <section class="card">
                        <div class="card-header">
                            <h2 class="card-title">Emergency Locations Map</h2>
                            <p class="card-subtitle">Search and filter emergency locations on the map</p>
                        </div>
                        
                        <!-- Enhanced Map Controls -->
                        <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                            <!-- Search and Filter Controls -->
                            <div class="mb-4">
                                <h3 class="font-semibold mb-3 text-gray-800">Search & Filter Reports</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    <!-- Search Input -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Search Reports</label>
                                        <input type="text" id="mapSearchInput" placeholder="Search by reporter, location, type..." 
                                               class="form-input w-full" onkeyup="filterMapReports()">
                                    </div>
                                    
                                    <!-- Status Filter -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                        <select id="mapStatusFilter" class="form-input w-full" onchange="filterMapReports()">
                                            <option value="all">All Status</option>
                                            <option value="pending">Pending</option>
                                            <option value="processing">Processing</option>
                                            <option value="assigned">Assigned</option>
                                            <option value="in_progress">In Progress</option>
                                            <option value="completed">Completed</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Type Filter -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Emergency Type</label>
                                        <select id="mapTypeFilter" class="form-input w-full" onchange="filterMapReports()">
                                            <option value="all">All Types</option>
                                            <option value="fire">Fire</option>
                                            <option value="medical">Medical</option>
                                            <option value="accident">Accident</option>
                                            <option value="flood">Flood</option>
                                            <option value="earthquake">Earthquake</option>
                                            <option value="storm">Storm</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Priority Filter -->
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                                        <select id="mapPriorityFilter" class="form-input w-full" onchange="filterMapReports()">
                                            <option value="all">All Priorities</option>
                                            <option value="1">Priority 1 (Critical)</option>
                                            <option value="2">Priority 2 (High)</option>
                                            <option value="3">Priority 3 (Medium)</option>
                                            <option value="4">Priority 4 (Low)</option>
                                            <option value="5">Priority 5 (Info)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Date Range Filter -->
                                <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                                        <input type="date" id="mapFromDate" class="form-input w-full" onchange="filterMapReports()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                                        <input type="date" id="mapToDate" class="form-input w-full" onchange="filterMapReports()">
                                    </div>
                                    <div class="flex items-end gap-2">
                                        <button onclick="clearMapFilters()" class="btn btn-sm" style="background: #6b7280; color: white;">
                                            üóëÔ∏è Clear Filters
                                        </button>
                                        <button onclick="refreshMapData()" class="btn btn-sm" style="background: #3b82f6; color: white;">
                                            üîÑ Refresh Map
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Map Controls Row -->
                            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                <!-- Emergency Types Legend -->
                                <div>
                                    <h3 class="font-semibold mb-3 text-gray-800">Emergency Types Legend</h3>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl">üî•</span>
                                            <span class="text-sm">Fire</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl">üè•</span>
                                            <span class="text-sm">Medical</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl">üöó</span>
                                            <span class="text-sm">Accident</span>
                                        </div>
                                        <div class="flex items-center gap-2">
                                            <span class="text-2xl">üåä</span>
                                            <span class="text-sm">Flood</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Marker Size Control -->
                                <div class="flex items-center gap-3">
                                    <label class="text-sm font-medium text-gray-700">Marker Size:</label>
                                    <input type="range" id="markerSizeSlider" min="60" max="150" value="80" 
                                           class="w-24 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                                           onchange="adjustMarkerSize(this.value)">
                                    <span id="markerSizeValue" class="text-sm font-semibold text-gray-600">80px</span>
                                </div>
                            </div>
                            
                            <!-- Filter Results Summary -->
                            <div id="mapFilterSummary" class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <span class="text-blue-600">üìç</span>
                                        <span class="text-sm font-medium text-blue-800">Showing <span id="mapResultsCount">0</span> emergency locations</span>
                                    </div>
                                    <div id="mapFilterStatus" class="text-sm text-blue-600"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="mapContainer" class="map-container" style="height: 500px; width: 100%; border-radius: 8px; position: relative;">
                            <div id="map" style="height: 100%; width: 100%; border-radius: 8px;"></div>
                        </div>
                    </section>
                </div>
                
                <!-- Archived Section -->
                <div id="archived-section" class="admin-section">
                    <section class="card">
                        <div class="card-header">
                            <h2 class="card-title">üìÅ Archived Reports</h2>
                            <p class="card-subtitle">View and manage archived emergency reports</p>
                        </div>
                        <div class="p-6">
                            <div class="mb-4">
                                <button onclick="showArchivedReports()" class="btn btn-primary">
                                    üîÑ Refresh Archived Reports
                                </button>
                                <button onclick="clearAllArchived()" class="btn btn-danger ml-2">
                                    üóëÔ∏è Clear All Archived
                                </button>
                            </div>
                            <div id="archived-reports-container">
                                <p class="text-gray-500 text-center py-8">Click "Refresh Archived Reports" to load archived reports.</p>
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- Analytics Section -->
                <div id="analytics-section" class="admin-section">
                    <section class="card">
                        <div class="card-header">
                            <h2 class="card-title">üìà Analytics & Reports</h2>
                            <p class="card-subtitle">System performance and emergency statistics</p>
                        </div>
                        <div class="p-6">
                            <div class="mb-6">
                                <button onclick="loadAnalytics()" class="btn btn-primary">
                                    üìä Refresh Analytics
                                </button>
                                <button onclick="exportAnalytics()" class="btn btn-secondary ml-2">
                                    üì• Export Data
                                </button>
                            </div>
                            
                            <div id="analytics-metrics" class="mb-6">
                                <!-- Metrics will be loaded here -->
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4">üìä Emergency Types Distribution</h3>
                                    <div id="emergency-types-chart">
                                        <!-- Chart will be loaded here -->
                                    </div>
                                </div>
                                <div class="card">
                                    <h3 class="text-lg font-semibold mb-4">‚è±Ô∏è Response Times</h3>
                                    <div id="response-times-chart">
                                        <!-- Chart will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>
                </div>
                
                <!-- Settings Section -->
                <div id="settings-section" class="admin-section">
                    <section class="card">
                        <div class="card-header">
                            <h2 class="card-title">‚öôÔ∏è System Settings</h2>
                            <p class="card-subtitle">Configure system parameters and preferences</p>
                        </div>
                        <div class="p-6">
                            <form id="settingsForm" onsubmit="saveSettings(); return false;">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <!-- Notification Settings -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-4">üîî Notifications</h3>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">Email Notifications</label>
                                            <input type="checkbox" id="emailNotifications" class="checkbox" checked>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">Notification Sound</label>
                                            <input type="checkbox" id="notificationSound" class="checkbox" checked>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">Push Notifications</label>
                                            <input type="checkbox" id="pushNotifications" class="checkbox" checked>
                                        </div>
                                    </div>

                                    <!-- AI Settings -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-4">ü§ñ AI Processing</h3>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">AI Processing</label>
                                            <input type="checkbox" id="aiProcessing" class="checkbox" checked>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">Auto Classification</label>
                                            <input type="checkbox" id="autoClassification" class="checkbox" checked>
                                        </div>
                                        
                                        <div class="flex items-center justify-between">
                                            <label class="text-sm font-medium text-gray-700">Auto Priority Assignment</label>
                                            <input type="checkbox" id="autoPriority" class="checkbox" checked>
                                        </div>
                                    </div>

                                    <!-- System Settings -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚öôÔ∏è System</h3>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Theme</label>
                                            <select id="theme" class="select select-bordered w-full">
                                                <option value="light">Light</option>
                                                <option value="dark">Dark</option>
                                                <option value="auto">Auto</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Language</label>
                                            <select id="language" class="select select-bordered w-full">
                                                <option value="en">English</option>
                                                <option value="fil">Filipino</option>
                                                <option value="es">Spanish</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Timezone</label>
                                            <select id="timezone" class="select select-bordered w-full">
                                                <option value="Asia/Manila">Asia/Manila (UTC+8)</option>
                                                <option value="UTC">UTC</option>
                                                <option value="America/New_York">America/New_York (UTC-5)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Performance Settings -->
                                    <div class="space-y-4">
                                        <h3 class="text-lg font-semibold text-gray-800 mb-4">‚ö° Performance</h3>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Auto Refresh Interval (seconds)</label>
                                            <select id="refreshInterval" class="select select-bordered w-full">
                                                <option value="0">Disabled</option>
                                                <option value="10">10 seconds</option>
                                                <option value="30" selected>30 seconds</option>
                                                <option value="60">1 minute</option>
                                                <option value="300">5 minutes</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Max Reports Per Page</label>
                                            <select id="maxReportsPerPage" class="select select-bordered w-full">
                                                <option value="5">5</option>
                                                <option value="10" selected>10</option>
                                                <option value="25">25</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                        </div>
                                        
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">Emergency Response Time (minutes)</label>
                                            <input type="number" id="responseTime" class="input input-bordered w-full" value="5" min="1" max="60">
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex justify-between items-center mt-8 pt-6 border-t border-gray-200">
                                    <div class="flex gap-3">
                                        <button type="submit" class="btn btn-primary">
                                            üíæ Save Settings
                                        </button>
                                        <button type="button" onclick="resetSettings()" class="btn btn-secondary">
                                            üîÑ Reset to Default
                                        </button>
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        Settings are saved automatically
                                    </div>
                                </div>
                            </form>
                        </div>
                    </section>
                </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>&copy; 2024 LSPU Emergency Response System. All rights reserved.</p>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding: 20px;">
        <div style="background: white; border-radius: 12px; max-width: 900px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
            <!-- Modal Header -->
            <div style="padding: 24px 24px 0 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;" id="modalTitle">Emergency Report Details</h3>
                <button onclick="hideReportModal()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 4px;">√ó</button>
            </div>
            
            <!-- Modal Content -->
            <div id="modalContent" style="padding: 24px; overflow-y: auto; flex: 1;">
                <!-- Content will be populated dynamically -->
            </div>
            
            <!-- Modal Footer -->
            <div style="padding: 0 24px 24px 24px; border-top: 1px solid #e5e7eb; display: flex; gap: 12px; justify-content: flex-end;">
                <button id="assignBtn" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Assign Responder</button>
                <button id="updateStatusBtn" style="padding: 8px 16px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Update Status</button>
                <button onclick="hideReportModal()" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentReports = [];
        let notificationChannel = null;

        // Check user role and redirect if necessary
        function checkUserRole() {
            if (!window.emergencySystem || !window.emergencySystem.user) {
                window.location.href = 'login.html';
                return false;
            }
            
            const userRole = window.emergencySystem.user?.user_metadata?.role || 'citizen';
            
            if (userRole !== 'admin') {
                // Redirect to appropriate dashboard
                if (userRole === 'citizen') {
                    window.location.href = 'user.html';
                } else if (userRole === 'responder') {
                    window.location.href = 'responder.html';
                }
                return false;
            }
            
            return true;
        }

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for system initialization
            await new Promise(resolve => {
                const checkInit = () => {
                    if (window.emergencySystem && window.emergencySystem.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });

            // Check user role
            if (!checkUserRole()) {
                return;
            }

            // Initialize map first
            initializeMap();
            
            // Load initial data
            await loadReports();
            await updateStatistics();
            
            // Set up real-time notifications
            await setupNotifications();
            
            // Set up filters (only if elements exist)
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priorityFilter = document.getElementById('priorityFilter');
            
            if (statusFilter) statusFilter.addEventListener('change', loadReports);
            if (typeFilter) typeFilter.addEventListener('change', loadReports);
            if (priorityFilter) priorityFilter.addEventListener('change', loadReports);
            
            // Set up settings (only if elements exist)
            const confidenceThreshold = document.getElementById('confidenceThreshold');
            const thresholdValue = document.getElementById('thresholdValue');
            
            if (confidenceThreshold && thresholdValue) {
                confidenceThreshold.addEventListener('input', (e) => {
                    thresholdValue.textContent = e.target.value + '%';
                });
            }
        });

        // Load reports
        async function loadReports() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load reports');
                    return;
                }
                
                const statusFilter = document.getElementById('statusFilter')?.value || 'all';
                const typeFilter = document.getElementById('typeFilter')?.value || 'all';
                const priorityFilter = document.getElementById('priorityFilter')?.value || 'all';
                
                // Build query with filters
                let query = window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Apply filters only if they're not "all"
                if (statusFilter && statusFilter !== 'all') {
                    query = query.eq('status', statusFilter);
                } else {
                    // By default, exclude archived reports unless specifically requested
                    query = query.neq('status', 'archived');
                }
                
                if (typeFilter && typeFilter !== 'all') {
                    query = query.eq('type', typeFilter);
                }
                
                if (priorityFilter && priorityFilter !== 'all') {
                    query = query.eq('priority', priorityFilter);
                }
                
                const { data: reports, error } = await query;
                
                if (error) throw error;
                
                currentReports = reports || [];
                displayReportsTable(currentReports);
            } catch (error) {
                console.error('Failed to load reports:', error);
                if (window.emergencySystem && window.emergencySystem.showError) {
                    window.emergencySystem.showError('Failed to load reports');
                } else {
                    showNotification('Failed to load reports', 'error');
                }
            }
        }

        // Display reports in table format
        function displayReportsTable(reports) {
            const tbody = document.getElementById('reportsTableBody');
            
            if (reports.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="text-center p-8 text-gray-500">
                            No reports found
                        </td>
                    </tr>
                `;
                updateMapDisplay([]);
                return;
            }

            // Update map with reports (filter out archived reports)
            const activeReports = reports.filter(report => report.status !== 'archived');
            updateMapDisplay(activeReports);
            
            // Initialize map if not already done
            if (!map) {
                initializeMap();
            }

            tbody.innerHTML = reports.map(report => `
                <tr>
                    <td>
                        <input type="checkbox" class="checkbox">
                    </td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">${getEmergencyIcon(report.type)}</span>
                            <span style="font-weight: 500;">${String(report.type || 'other').toUpperCase()}</span>
                        </div>
                    </td>
                    <td>
                        <div>
                            <div style="font-weight: 500;">${report.reporter_name || 'Anonymous'}</div>
                            <div style="font-size: 12px; color: #6b7280;">ID: ${report.id.substring(0, 8)}...</div>
                        </div>
                    </td>
                    <td>
                        <div style="font-size: 14px;">${formatLocationDisplay(report.location)}</div>
                    </td>
                    <td>
                        <div style="font-size: 14px;">${report.contact_number || 'No contact'}</div>
                    </td>
                    <td>
                        <div style="font-size: 14px;">${report.reporter_email || 'No email'}</div>
                    </td>
                    <td>
                        <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${getStatusColor(report.status) === 'yellow-500' ? '#fef3c7' : getStatusColor(report.status) === 'blue-500' ? '#dbeafe' : getStatusColor(report.status) === 'green-500' ? '#d1fae5' : '#f3f4f6'}; color: ${getStatusColor(report.status) === 'yellow-500' ? '#92400e' : getStatusColor(report.status) === 'blue-500' ? '#1e40af' : getStatusColor(report.status) === 'green-500' ? '#065f46' : '#374151'};">
                            ${String(report.status || 'pending').toUpperCase()}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button onclick="showReportDetails('${report.id}')" class="btn-action btn-view" title="View">üëÅÔ∏è</button>
                            <button onclick="editReport('${report.id}')" class="btn-action btn-edit" title="Edit">‚úèÔ∏è</button>
                            <button onclick="archiveReport('${report.id}')" class="btn-action btn-archive" title="Archive">üìÅ</button>
                            <button onclick="deleteReport('${report.id}')" class="btn-action btn-delete" title="Delete">üóëÔ∏è</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Show report details modal
        async function showReportDetails(reportId) {
            try {
                console.log('üîç Loading report details for ID:', reportId);
                
                // Get report from current reports array first
                let report = currentReports.find(r => r.id === reportId);
                
                // If not found, try to fetch from database
                if (!report) {
                    const { data, error } = await window.emergencySystem.supabase
                        .from('reports')
                        .select('*')
                        .eq('id', reportId)
                        .single();
                    
                    if (error) throw error;
                    report = data;
                }
                
                console.log('üìã Report data loaded:', report);
                
                document.getElementById('modalTitle').textContent = `Report ${report.id.substring(0, 8)}...`;
                
                document.getElementById('modalContent').innerHTML = `
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <!-- Emergency Type -->
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
                            <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">Emergency Type</h5>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 20px;">${getEmergencyIcon(report.type)}</span>
                                <span style="font-weight: 500; color: #111827;">${String(report.type || 'other').toUpperCase()}</span>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
                            <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">Status</h5>
                            <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${getStatusColor(report.status) === 'yellow-500' ? '#fef3c7' : getStatusColor(report.status) === 'blue-500' ? '#dbeafe' : getStatusColor(report.status) === 'green-500' ? '#d1fae5' : '#f3f4f6'}; color: ${getStatusColor(report.status) === 'yellow-500' ? '#92400e' : getStatusColor(report.status) === 'blue-500' ? '#1e40af' : getStatusColor(report.status) === 'green-500' ? '#065f46' : '#374151'};">
                                ${String(report.status || 'pending').toUpperCase()}
                            </span>
                        </div>
                        
                        <!-- AI Confidence -->
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
                            <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">AI Confidence</h5>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="flex: 1; background: #e5e7eb; border-radius: 4px; height: 8px;">
                                    <div style="background: #3b82f6; height: 8px; border-radius: 4px; width: ${(report.confidence || 0) * 100}%;"></div>
                                </div>
                                <span style="font-size: 12px; font-weight: 600; color: #3b82f6;">${report.confidence ? Math.round(report.confidence * 100) + '%' : 'N/A'}</span>
                            </div>
                        </div>
                        
                        <!-- Priority -->
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 8px;">
                            <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">Priority</h5>
                            <span style="font-weight: 500; color: #111827;">${String(report.priority || 'medium').toUpperCase()}</span>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">Description</h5>
                        <p style="margin: 0; color: #111827; font-size: 14px;">${report.message || report.description || 'No description provided'}</p>
                    </div>
                    
                    <!-- Location -->
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">üìç Location</h5>
                        <p style="margin: 0; color: #111827; font-size: 14px;">${report.location || 'Location not specified'}</p>
                    </div>
                    
                    <!-- Reporter Information -->
                    <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                        <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">üë§ Reporter Information</h5>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 14px;">
                            <div><strong>Name:</strong> ${report.reporter_name || 'Anonymous'}</div>
                            <div><strong>Contact:</strong> ${report.contact_number || 'No contact provided'}</div>
                            <div><strong>Reported:</strong> ${new Date(report.created_at).toLocaleString()}</div>
                        </div>
                    </div>
                    
                    ${report.image_path ? `
                        <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                            <h5 style="font-weight: 600; margin: 0 0 8px 0; color: #374151; font-size: 14px;">üì∏ Emergency Photo</h5>
                            <img src="${getImageUrl(report.image_path)}" alt="Emergency photo" style="border-radius: 8px; width: 100%; max-height: 200px; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                            <div style="display: none; padding: 20px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                                <p style="margin: 0;">Image not available</p>
                            </div>
                        </div>
                    ` : ''}
                `;
                
                // Update button states
                const assignBtn = document.getElementById('assignBtn');
                const updateStatusBtn = document.getElementById('updateStatusBtn');
                
                assignBtn.onclick = () => assignResponder(reportId);
                updateStatusBtn.onclick = () => updateReportStatus(reportId);
                
                if (report.status === 'completed') {
                    assignBtn.style.display = 'none';
                    updateStatusBtn.textContent = 'Already Completed';
                    updateStatusBtn.disabled = true;
                }
                
                document.getElementById('reportModal').classList.remove('hidden');
                console.log('‚úÖ Report modal displayed successfully');
            } catch (error) {
                console.error('‚ùå Failed to load report details:', error);
                window.emergencySystem.showError('Failed to load report details: ' + error.message);
            }
        }

        // Hide report modal
        function hideReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        // Assign responder
        async function assignResponder(reportId) {
            try {
                await window.emergencySystem.updateReportStatus(reportId, 'assigned');
                window.emergencySystem.showSuccess('Report assigned to responder successfully!');
                hideReportModal();
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to assign responder:', error);
                window.emergencySystem.showError('Failed to assign responder');
            }
        }

        // Update report status
        async function updateReportStatus(reportId) {
            const newStatus = prompt('Enter new status (pending, processing, assigned, in_progress, completed):');
            if (newStatus && ['pending', 'processing', 'assigned', 'in_progress', 'completed'].includes(newStatus)) {
                try {
                    await window.emergencySystem.updateReportStatus(reportId, newStatus);
                    window.emergencySystem.showSuccess('Report status updated successfully!');
                    hideReportModal();
                    await loadReports();
                    await updateStatistics();
                } catch (error) {
                    console.error('Failed to update status:', error);
                    window.emergencySystem.showError('Failed to update report status');
                }
            }
        }

        // Update statistics
        async function updateStatistics() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot update statistics');
                    return;
                }
                
                const allReports = await window.emergencySystem.getReports();
                
                const total = allReports.length;
                const pending = allReports.filter(r => r.status === 'pending').length;
                const processing = allReports.filter(r => r.status === 'processing' || r.status === 'classified').length;
                const completed = allReports.filter(r => r.status === 'completed').length;
                
                document.getElementById('totalReports').textContent = total;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('processingCount').textContent = processing;
                document.getElementById('completedCount').textContent = completed;
                
                // Update emergency types chart
                updateEmergencyTypesChart(allReports);
                updateResponseTimesChart(allReports);
            } catch (error) {
                console.error('Failed to update statistics:', error);
            }
        }

        // Update emergency types chart
        function updateEmergencyTypesChart(reports) {
            const typeCounts = reports.reduce((acc, report) => {
                acc[report.type] = (acc[report.type] || 0) + 1;
                return acc;
            }, {});
            
            // Update dashboard chart
            const chartContainer = document.getElementById('emergencyTypesChart');
            if (chartContainer) {
                chartContainer.innerHTML = Object.entries(typeCounts).map(([type, count]) => `
                    <div class="flex items-center justify-between">
                        <span class="flex items-center gap-2">
                            ${getEmergencyIcon(type)}
                            ${type.toUpperCase()}
                        </span>
                        <span class="font-semibold">${count}</span>
                    </div>
                `).join('');
            }

            // Update analytics section chart
            const analyticsChartContainer = document.getElementById('emergency-types-chart');
            if (analyticsChartContainer) {
                const total = Object.values(typeCounts).reduce((sum, count) => sum + count, 0);
                analyticsChartContainer.innerHTML = Object.entries(typeCounts)
                    .sort(([,a], [,b]) => b - a)
                    .map(([type, count]) => {
                        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                        return `
                            <div class="mb-3">
                                <div class="flex justify-between items-center mb-1">
                                    <span class="capitalize font-medium">${type}</span>
                                    <span class="text-sm text-gray-600">${count} (${percentage}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
            }
        }

        // Update response times chart
        function updateResponseTimesChart(reports) {
            const completedReports = reports.filter(r => r.status === 'completed' && r.updated_at);
            const avgResponseTime = completedReports.length > 0 ? 
                completedReports.reduce((acc, report) => {
                    const responseTime = new Date(report.updated_at) - new Date(report.created_at);
                    return acc + responseTime;
                }, 0) / completedReports.length : 0;
            
            // Update dashboard chart
            const chartContainer = document.getElementById('responseTimesChart');
            if (chartContainer) {
                chartContainer.innerHTML = `
                    <div class="text-center">
                        <div class="text-2xl font-bold text-blue-600">${Math.round(avgResponseTime / 60000)} min</div>
                        <div class="text-sm text-gray-600">Average Response Time</div>
                    </div>
                `;
            }

            // Update analytics section chart
            const analyticsChartContainer = document.getElementById('response-times-chart');
            if (analyticsChartContainer) {
                const responseTimeMinutes = Math.round(avgResponseTime / 60000);
                const responseTimeHours = Math.round(responseTimeMinutes / 60);
                
                analyticsChartContainer.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold text-green-600">${responseTimeMinutes} min</div>
                            <div class="text-sm text-gray-600">Average Response Time</div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="text-lg font-semibold text-blue-600">${completedReports.length}</div>
                                <div class="text-xs text-gray-600">Completed</div>
                            </div>
                            <div class="bg-green-50 p-3 rounded-lg">
                                <div class="text-lg font-semibold text-green-600">${responseTimeHours}h</div>
                                <div class="text-xs text-gray-600">Avg Hours</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Process pending reports with AI
        async function processPendingReports() {
            try {
                document.getElementById('aiQueueStatus').innerHTML = `
                    <div class="flex items-center justify-center gap-2">
                        <div class="loading"></div>
                        Processing pending reports...
                    </div>
                `;
                
                const { data, error } = await window.emergencySystem.supabase.functions.invoke('classify-pending');
                
                if (error) throw error;
                
                document.getElementById('aiQueueStatus').innerHTML = `
                    <div class="text-green-600">
                        ‚úÖ Processed ${data.count} reports successfully
                    </div>
                `;
                
                window.emergencySystem.showSuccess(`AI analysis completed for ${data.count} reports`);
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to process pending reports:', error);
                document.getElementById('aiQueueStatus').innerHTML = `
                    <div class="text-red-600">
                        ‚ùå Failed to process reports: ${error.message}
                    </div>
                `;
                window.emergencySystem.showError('Failed to process pending reports');
            }
        }

        // Check AI status
        async function checkAIStatus() {
            try {
                const pendingReports = await window.emergencySystem.getReports({ status: 'pending' });
                const processingReports = await window.emergencySystem.getReports({ status: 'processing' });
                
                document.getElementById('aiQueueStatus').innerHTML = `
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div>
                            <div class="text-2xl font-bold text-yellow-600">${pendingReports.length}</div>
                            <div class="text-sm text-gray-600">Pending Analysis</div>
                        </div>
                        <div>
                            <div class="text-2xl font-bold text-blue-600">${processingReports.length}</div>
                            <div class="text-sm text-gray-600">Currently Processing</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Failed to check AI status:', error);
                window.emergencySystem.showError('Failed to check AI status');
            }
        }

        // Export reports
        function exportReports() {
            try {
                const csvContent = [
                    ['ID', 'Type', 'Status', 'Priority', 'Reporter', 'Location', 'Created', 'AI Confidence'],
                    ...currentReports.map(report => [
                        report.id,
                        report.type,
                        report.status,
                        report.priority || 'medium',
                        report.reporter_name || 'Anonymous',
                        report.location || 'Not specified',
                        new Date(report.created_at).toLocaleString(),
                        report.confidence ? Math.round(report.confidence * 100) + '%' : 'N/A'
                    ])
                ].map(row => row.join(',')).join('\n');
                
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `emergency-reports-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                window.emergencySystem.showSuccess('Reports exported successfully!');
            } catch (error) {
                console.error('Failed to export reports:', error);
                window.emergencySystem.showError('Failed to export reports');
            }
        }

        // Save settings
        function saveSettings() {
            const settings = {
                emailNotifications: document.getElementById('emailNotifications').checked,
                pushNotifications: document.getElementById('pushNotifications').checked,
                smsNotifications: document.getElementById('smsNotifications').checked,
                confidenceThreshold: document.getElementById('confidenceThreshold').value,
                autoAssignment: document.getElementById('autoAssignment').value
            };
            
            localStorage.setItem('adminSettings', JSON.stringify(settings));
            window.emergencySystem.showSuccess('Settings saved successfully!');
        }

        // Load settings
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem('adminSettings') || '{}');
            
            if (settings.emailNotifications !== undefined) {
                document.getElementById('emailNotifications').checked = settings.emailNotifications;
            }
            if (settings.pushNotifications !== undefined) {
                document.getElementById('pushNotifications').checked = settings.pushNotifications;
            }
            if (settings.smsNotifications !== undefined) {
                document.getElementById('smsNotifications').checked = settings.smsNotifications;
            }
            if (settings.confidenceThreshold) {
                document.getElementById('confidenceThreshold').value = settings.confidenceThreshold;
                document.getElementById('thresholdValue').textContent = settings.confidenceThreshold + '%';
            }
            if (settings.autoAssignment) {
                document.getElementById('autoAssignment').value = settings.autoAssignment;
            }
        }

        // Set up real-time notifications
        async function setupNotifications() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, skipping notifications setup');
                    return;
                }
                
                notificationChannel = await window.emergencySystem.subscribeToNotifications((payload) => {
                    console.log('üîî Admin notification:', payload);
                    
                    if (payload.eventType === 'INSERT') {
                        window.emergencySystem.showInfo('üö® New emergency report received!');
                    }
                    
                    // Refresh data
                    loadReports();
                    updateStatistics();
                });
            } catch (error) {
                console.error('Failed to set up notifications:', error);
            }
        }

        // Initialize Leaflet map
        let map = null;
        let markers = [];
        
        // Add sample reports for testing (remove this in production)
        async function addSampleReports() {
            try {
                console.log('Adding sample reports for testing...');
                
                const sampleReports = [
                    {
                        reporter_uid: 'sample-user-1',
                        reporter_name: 'Juan Dela Cruz',
                        message: 'Flood emergency in Manila area',
                        location: JSON.stringify({
                            latitude: 14.5995,
                            longitude: 120.9842,
                            address: 'Manila, Philippines'
                        }),
                        type: 'flood',
                        confidence: 0.88,
                        status: 'pending',
                        priority: 'high',
                        created_at: new Date().toISOString()
                    },
                    {
                        reporter_uid: 'sample-user-2',
                        reporter_name: 'Maria Santos',
                        message: 'Traffic accident on EDSA',
                        location: JSON.stringify({
                            latitude: 14.5547,
                            longitude: 121.0244,
                            address: 'Makati, Philippines'
                        }),
                        type: 'accident',
                        confidence: 0.92,
                        status: 'processing',
                        priority: 'high',
                        created_at: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        reporter_uid: 'sample-user-3',
                        reporter_name: 'Pedro Rodriguez',
                        message: 'Fire emergency in Quezon City',
                        location: JSON.stringify({
                            latitude: 14.6760,
                            longitude: 121.0437,
                            address: 'Quezon City, Philippines'
                        }),
                        type: 'fire',
                        confidence: 0.95,
                        status: 'assigned',
                        priority: 'critical',
                        created_at: new Date(Date.now() - 7200000).toISOString()
                    },
                    {
                        reporter_uid: 'sample-user-4',
                        reporter_name: 'Ana Garcia',
                        message: 'Medical emergency in Pasig',
                        location: JSON.stringify({
                            latitude: 14.5604,
                            longitude: 121.0885,
                            address: 'Pasig, Philippines'
                        }),
                        type: 'medical',
                        confidence: 0.87,
                        status: 'in_progress',
                        priority: 'high',
                        created_at: new Date(Date.now() - 10800000).toISOString()
                    }
                ];
                
                for (const report of sampleReports) {
                    const { error } = await window.emergencySystem.supabase
                        .from('reports')
                        .insert([report]);
                    
                    if (error) {
                        console.log('Sample report already exists or error:', error.message);
                    } else {
                        console.log('Added sample report:', report.type);
                    }
                }
                
                console.log('Sample reports added successfully!');
                await loadReports(); // Refresh the display
                
            } catch (error) {
                console.error('Error adding sample reports:', error);
            }
        }
        
        // Clear sample reports (for testing)
        async function clearSampleReports() {
            try {
                console.log('Clearing sample reports...');
                
                const { error } = await window.emergencySystem.supabase
                    .from('reports')
                    .delete()
                    .like('reporter_uid', 'sample-user-%');
                
                if (error) {
                    console.error('Error clearing sample reports:', error);
                } else {
                    console.log('Sample reports cleared successfully!');
                    await loadReports(); // Refresh the display
                }
                
            } catch (error) {
                console.error('Error clearing sample reports:', error);
            }
        }

        function initializeMap() {
            if (map) {
                map.remove();
            }
            
            // Initialize map centered on Philippines
            map = L.map('map').setView([14.5995, 120.9842], 6);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add zoom event listener to update marker sizes
            map.on('zoomend', function() {
                updateMarkerSizes();
            });
        }

        // Global variable for manual marker size
        let manualMarkerSize = 80;

        // Adjust marker size manually
        function adjustMarkerSize(size) {
            manualMarkerSize = parseInt(size);
            document.getElementById('markerSizeValue').textContent = size + 'px';
            updateMarkerSizes();
        }

        // Update marker sizes based on zoom level
        function updateMarkerSizes() {
            if (!map || markers.length === 0) return;
            
            const currentZoom = map.getZoom();
            const baseSize = manualMarkerSize; // Use manual size instead of fixed 80
            const zoomFactor = Math.max(0.8, Math.min(2.0, currentZoom / 10));
            const dynamicSize = Math.round(baseSize * zoomFactor);
            
            markers.forEach((marker, index) => {
                const report = currentReports[index];
                if (report) {
                    const icon = getEmergencyIcon(report.type);
                    const statusColor = getStatusColor(report.status);
                    
                    const customIcon = L.divIcon({
                        html: `
                            <div class="bg-white rounded-full shadow-2xl border-4 border-${statusColor} transform hover:scale-125 transition-all duration-300" 
                             style="width: ${dynamicSize}px; height: ${dynamicSize}px; display: flex; align-items: center; justify-content: center;">
                                <div class="text-4xl drop-shadow-lg" style="font-size: ${Math.round(dynamicSize * 0.4)}px;">${icon}</div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [dynamicSize, dynamicSize],
                        iconAnchor: [dynamicSize/2, dynamicSize/2],
                        popupAnchor: [0, -dynamicSize/2]
                    });
                    
                    marker.setIcon(customIcon);
                }
            });
        }

        // Map filtering functions
        let allMapReports = []; // Store all reports for filtering
        let filteredMapReports = []; // Store filtered reports

        // Filter map reports based on search and filter criteria
        async function filterMapReports() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot filter map reports');
                    return;
                }

                // Get filter values
                const searchTerm = document.getElementById('mapSearchInput').value.toLowerCase();
                const statusFilter = document.getElementById('mapStatusFilter').value;
                const typeFilter = document.getElementById('mapTypeFilter').value;
                const priorityFilter = document.getElementById('mapPriorityFilter').value;
                const fromDate = document.getElementById('mapFromDate').value;
                const toDate = document.getElementById('mapToDate').value;

                // If no reports loaded yet, load them first
                if (allMapReports.length === 0) {
                    allMapReports = await window.emergencySystem.getReports();
                    // Filter out archived reports
                    allMapReports = allMapReports.filter(report => report.status !== 'archived');
                }

                // Apply filters
                filteredMapReports = allMapReports.filter(report => {
                    // Search filter
                    if (searchTerm) {
                        const searchableText = [
                            report.reporter_name || '',
                            report.message || '',
                            report.type || '',
                            report.location || ''
                        ].join(' ').toLowerCase();
                        
                        if (!searchableText.includes(searchTerm)) {
                            return false;
                        }
                    }

                    // Status filter
                    if (statusFilter && statusFilter !== 'all') {
                        if (report.status !== statusFilter) {
                            return false;
                        }
                    }

                    // Type filter
                    if (typeFilter && typeFilter !== 'all') {
                        if (report.type !== typeFilter) {
                            return false;
                        }
                    }

                    // Priority filter
                    if (priorityFilter && priorityFilter !== 'all') {
                        if (report.priority !== parseInt(priorityFilter)) {
                            return false;
                        }
                    }

                    // Date range filter
                    if (fromDate || toDate) {
                        const reportDate = new Date(report.created_at);
                        const from = fromDate ? new Date(fromDate) : null;
                        const to = toDate ? new Date(toDate) : null;

                        if (from && reportDate < from) {
                            return false;
                        }
                        if (to && reportDate > to) {
                            return false;
                        }
                    }

                    return true;
                });

                // Update map display with filtered reports
                updateMapDisplay(filteredMapReports);
                
                // Update filter summary
                updateMapFilterSummary();

            } catch (error) {
                console.error('Failed to filter map reports:', error);
                if (window.emergencySystem && window.emergencySystem.showError) {
                    window.emergencySystem.showError('Failed to filter map reports');
                } else {
                    showNotification('Failed to filter map reports', 'error');
                }
            }
        }

        // Clear all map filters
        function clearMapFilters() {
            document.getElementById('mapSearchInput').value = '';
            document.getElementById('mapStatusFilter').value = 'all';
            document.getElementById('mapTypeFilter').value = 'all';
            document.getElementById('mapPriorityFilter').value = 'all';
            document.getElementById('mapFromDate').value = '';
            document.getElementById('mapToDate').value = '';
            
            // Show all non-archived reports
            filterMapReports();
        }

        // Refresh map data
        async function refreshMapData() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot refresh map data');
                    return;
                }

                // Reload all reports
                allMapReports = await window.emergencySystem.getReports();
                allMapReports = allMapReports.filter(report => report.status !== 'archived');
                
                // Reapply current filters
                await filterMapReports();
                
                if (window.emergencySystem && window.emergencySystem.showSuccess) {
                    window.emergencySystem.showSuccess('Map data refreshed successfully!');
                } else {
                    showNotification('Map data refreshed successfully!', 'success');
                }

            } catch (error) {
                console.error('Failed to refresh map data:', error);
                if (window.emergencySystem && window.emergencySystem.showError) {
                    window.emergencySystem.showError('Failed to refresh map data');
                } else {
                    showNotification('Failed to refresh map data', 'error');
                }
            }
        }

        // Update map filter summary
        function updateMapFilterSummary() {
            const resultsCount = filteredMapReports.length;
            const totalCount = allMapReports.length;
            
            document.getElementById('mapResultsCount').textContent = resultsCount;
            
            const statusElement = document.getElementById('mapFilterStatus');
            if (resultsCount === 0) {
                statusElement.textContent = 'No reports match your filters';
                statusElement.className = 'text-sm text-red-600';
            } else if (resultsCount === totalCount) {
                statusElement.textContent = 'Showing all reports';
                statusElement.className = 'text-sm text-green-600';
            } else {
                statusElement.textContent = `Filtered from ${totalCount} total reports`;
                statusElement.className = 'text-sm text-blue-600';
            }
        }

        // Update map display with emergency locations
        function updateMapDisplay(reports) {
            if (!map) {
                initializeMap();
            }
            
            // Filter out archived reports - they shouldn't show on the map
            const activeReports = reports.filter(report => report.status !== 'archived');
            
            // Store reports for marker updates
            currentReports = activeReports;
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (activeReports.length === 0) {
                // Show message on map
                const noDataDiv = L.divIcon({
                    html: `
                        <div class="text-center p-4 bg-white rounded-lg shadow-lg">
                            <div class="text-4xl mb-2">üó∫Ô∏è</div>
                            <div class="font-semibold text-gray-800">No emergency locations</div>
                            <div class="text-sm text-gray-600">Reports will appear here when available</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [200, 100]
                });
                
                const noDataMarker = L.marker([14.5995, 120.9842], { icon: noDataDiv }).addTo(map);
                markers.push(noDataMarker);
                return;
            }

            // Add markers for each emergency location
            const bounds = L.latLngBounds();
            
            activeReports.forEach(report => {
                // Get coordinates for Philippines locations (simplified)
                const coordinates = getCoordinatesForLocation(report.location);
                
                if (coordinates) {
                    const icon = getEmergencyIcon(report.type);
                    const statusColor = getStatusColor(report.status);
                    
                    // Get current zoom level for dynamic sizing
                    const currentZoom = map.getZoom();
                    const baseSize = 80; // Base size for markers
                    const zoomFactor = Math.max(0.8, Math.min(2.0, currentZoom / 10)); // Scale based on zoom
                    const dynamicSize = Math.round(baseSize * zoomFactor);
                    
                    const customIcon = L.divIcon({
                        html: `
                            <div class="bg-white rounded-full shadow-2xl border-4 border-${statusColor} transform hover:scale-125 transition-all duration-300" 
                                 style="width: ${dynamicSize}px; height: ${dynamicSize}px; display: flex; align-items: center; justify-content: center;">
                                <div class="text-4xl drop-shadow-lg" style="font-size: ${Math.round(dynamicSize * 0.4)}px;">${icon}</div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [dynamicSize, dynamicSize],
                        iconAnchor: [dynamicSize/2, dynamicSize/2],
                        popupAnchor: [0, -dynamicSize/2]
                    });
                    
                    const marker = L.marker(coordinates, { icon: customIcon }).addTo(map);
                    
                    // Add popup with report details
                    marker.bindPopup(`
                        <div class="p-4 min-w-64">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">${String(report.type || 'other').toUpperCase()} Emergency</div>
                                    <div class="text-sm text-gray-600">${formatLocationDisplay(report.location)}</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Status:</span>
                                    <span class="badge badge-${report.status} text-xs">${String(report.status || 'pending').toUpperCase()}</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Reporter:</span>
                                    <span class="text-sm text-gray-600">${report.reporter_name || 'Anonymous'}</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Priority:</span>
                                    <span class="text-sm font-semibold text-${getPriorityColor(report.priority)}">${String(report.priority || 'medium').toUpperCase()}</span>
                                </div>
                                
                                ${report.confidence ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-700">AI Confidence:</span>
                                        <div class="flex items-center gap-1">
                                            <div class="w-16 bg-gray-200 rounded-full h-1">
                                                <div class="bg-blue-600 h-1 rounded-full" style="width: ${report.confidence * 100}%"></div>
                                            </div>
                                            <span class="text-xs font-semibold text-blue-600">${Math.round(report.confidence * 100)}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="text-xs text-gray-500 mt-2">
                                    Reported: ${new Date(report.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
                    
                    markers.push(marker);
                    bounds.extend(coordinates);
                }
            });
            
            // Fit map to show all markers
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Format location for display in popups
        function formatLocationDisplay(location) {
            // Handle new JSON format with latitude/longitude
            if (typeof location === 'string' && location.startsWith('{')) {
                try {
                    const locationData = JSON.parse(location);
                    if (locationData.address && locationData.address !== 'Location detected') {
                        return locationData.address;
                    } else if (locationData.latitude && locationData.longitude) {
                        return `üìç ${locationData.latitude.toFixed(4)}, ${locationData.longitude.toFixed(4)}`;
                    }
                } catch (e) {
                    console.warn('Failed to parse location JSON:', e);
                }
            }
            
            // Handle old string format
            return location || 'üìç Unknown Location';
        }

        // Get coordinates for Philippines locations
        function getCoordinatesForLocation(location) {
            console.log('Processing location:', location);
            
            // Handle new JSON format with latitude/longitude
            if (typeof location === 'string' && location.startsWith('{')) {
                try {
                    const locationData = JSON.parse(location);
                    if (locationData.latitude && locationData.longitude) {
                        console.log('Found coordinates:', locationData.latitude, locationData.longitude);
                        return [locationData.latitude, locationData.longitude];
                    }
                } catch (e) {
                    console.warn('Failed to parse location JSON:', e);
                }
            }
            
            // Handle object format
            if (typeof location === 'object' && location !== null) {
                if (location.latitude && location.longitude) {
                    console.log('Found coordinates in object:', location.latitude, location.longitude);
                    return [location.latitude, location.longitude];
                }
            }
            
            // Handle old string format with common Philippines locations
            const locationMap = {
                'Manila, Philippines': [14.5995, 120.9842],
                'Quezon City, Philippines': [14.6760, 121.0437],
                'Makati, Philippines': [14.5547, 121.0244],
                'Pasig, Philippines': [14.5604, 121.0885],
                'Test Location': [14.5995, 120.9842],
                'Manila': [14.5995, 120.9842],
                'Quezon City': [14.6760, 121.0437],
                'Makati': [14.5547, 121.0244],
                'Pasig': [14.5604, 121.0885],
                'Batangas': [13.7563, 121.0583],
                'Cavite': [14.4791, 120.8970],
                'Laguna': [14.2730, 121.4189],
                'Rizal': [14.5667, 121.2000],
                'Pampanga': [15.0794, 120.6200],
                'Tarlac': [15.4869, 120.5900],
                'Nueva Ecija': [15.5833, 120.7500],
                'Aurora': [15.9900, 121.5500],
                'Quezon': [14.0000, 121.5000],
                'Zambales': [15.0000, 120.0000],
                'Bataan': [14.6667, 120.4167]
            };
            
            // Try exact match first
            if (locationMap[location]) {
                console.log('Found exact match:', location, locationMap[location]);
                return locationMap[location];
            }
            
            // Try partial match for common patterns
            if (typeof location === 'string') {
                const lowerLocation = location.toLowerCase();
                for (const [key, coords] of Object.entries(locationMap)) {
                    if (lowerLocation.includes(key.toLowerCase()) || key.toLowerCase().includes(lowerLocation)) {
                        console.log('Found partial match:', location, '->', key, coords);
                        return coords;
                    }
                }
            }
            
            // Default to Manila if no match found
            console.log('No location match found, using default Manila coordinates');
            return [14.5995, 120.9842];
        }

        // Get status color for markers
        function getStatusColor(status) {
            const colors = {
                pending: 'yellow-500',
                processing: 'blue-500',
                assigned: 'purple-500',
                completed: 'green-500',
                classified: 'blue-500'
            };
            return colors[status] || 'gray-500';
        }

        // Utility functions
        function getEmergencyIcon(type) {
            const icons = {
                fire: 'üî•',
                medical: 'üè•',
                accident: 'üöó',
                flood: 'üåä',
                earthquake: 'üåç',
                storm: '‚õàÔ∏è',
                other: '‚ö†Ô∏è'
            };
            return icons[type] || '‚ö†Ô∏è';
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'red-600',
                medium: 'yellow-600',
                low: 'green-600'
            };
            return colors[priority] || 'yellow-600';
        }

        function getConfidenceColor(confidence) {
            if (confidence >= 0.8) return 'text-green-600';
            if (confidence >= 0.6) return 'text-yellow-600';
            return 'text-red-600';
        }

        function getConfidenceLevel(confidence) {
            if (confidence >= 0.8) return 'high';
            if (confidence >= 0.6) return 'medium';
            return 'low';
        }

        // Navigation functions
        function showUserManagement() {
            setActiveNav('nav-users');
            window.emergencySystem.showInfo('User Management feature coming soon!');
        }

        function showSystemSettings() {
            setActiveNav('nav-settings');
            window.emergencySystem.showInfo('System Settings feature coming soon!');
        }

        function showAnalytics() {
            setActiveNav('nav-analytics');
            window.emergencySystem.showInfo('Analytics feature coming soon!');
        }

        function setActiveNav(navId) {
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            // Add active class to clicked button
            document.getElementById(navId).classList.add('active');
        }

        // CRUD Operations for Reports
        
        // Edit Report
        async function editReport(reportId) {
            try {
                // Get report from current reports array first
                let report = currentReports.find(r => r.id === reportId);
                
                // If not found, try to fetch from database
                if (!report) {
                    const { data, error } = await window.emergencySystem.supabase
                        .from('reports')
                        .select('*')
                        .eq('id', reportId)
                        .single();
                    
                    if (error) throw error;
                    report = data;
                }
                
                // Create edit modal
                const modalContent = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding: 20px;">
                        <div style="background: white; border-radius: 12px; max-width: 800px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
                            <div style="padding: 24px 24px 0 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">‚úèÔ∏è Edit Report</h3>
                                <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 4px;">‚úï</button>
                            </div>
                            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                            <form id="editReportForm">
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Emergency Type</label>
                                        <select id="editType" class="form-input form-select w-full">
                                            <option value="fire" ${report.type === 'fire' ? 'selected' : ''}>üî• Fire</option>
                                            <option value="medical" ${report.type === 'medical' ? 'selected' : ''}>üè• Medical</option>
                                            <option value="accident" ${report.type === 'accident' ? 'selected' : ''}>üöó Accident</option>
                                            <option value="flood" ${report.type === 'flood' ? 'selected' : ''}>üåä Flood</option>
                                            <option value="earthquake" ${report.type === 'earthquake' ? 'selected' : ''}>üåç Earthquake</option>
                                            <option value="storm" ${report.type === 'storm' ? 'selected' : ''}>‚õàÔ∏è Storm</option>
                                            <option value="other" ${report.type === 'other' ? 'selected' : ''}>‚ö†Ô∏è Other</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Status</label>
                                        <select id="editStatus" class="form-input form-select w-full">
                                            <option value="pending" ${report.status === 'pending' ? 'selected' : ''}>Pending</option>
                                            <option value="processing" ${report.status === 'processing' ? 'selected' : ''}>Processing</option>
                                            <option value="classified" ${report.status === 'classified' ? 'selected' : ''}>Classified</option>
                                            <option value="assigned" ${report.status === 'assigned' ? 'selected' : ''}>Assigned</option>
                                            <option value="in_progress" ${report.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                                            <option value="completed" ${report.status === 'completed' ? 'selected' : ''}>Completed</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Priority</label>
                                        <select id="editPriority" class="form-input form-select w-full">
                                            <option value="high" ${report.priority === 'high' ? 'selected' : ''}>High</option>
                                            <option value="medium" ${report.priority === 'medium' ? 'selected' : ''}>Medium</option>
                                            <option value="low" ${report.priority === 'low' ? 'selected' : ''}>Low</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Reporter Name</label>
                                        <input type="text" id="editReporterName" class="form-input w-full" value="${report.reporter_name || ''}">
                                    </div>
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Contact Number</label>
                                    <input type="text" id="editContactNumber" class="form-input w-full" value="${report.contact_number || ''}">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Location</label>
                                    <input type="text" id="editLocation" class="form-input w-full" value="${report.location || ''}">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-1">Description</label>
                                    <textarea id="editMessage" class="form-input w-full" rows="3">${report.message || report.description || ''}</textarea>
                                </div>
                                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 24px; border-top: 1px solid #e5e7eb;">
                                    <button type="button" onclick="closeEditModal()" style="padding: 8px 16px; background: #f3f4f6; color: #374151; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                                    <button type="submit" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">üíæ Save Changes</button>
                                </div>
                            </form>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
                
                // Handle form submission
                document.getElementById('editReportForm').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const updateData = {
                        type: document.getElementById('editType').value,
                        status: document.getElementById('editStatus').value,
                        priority: document.getElementById('editPriority').value,
                        reporter_name: document.getElementById('editReporterName').value,
                        contact_number: document.getElementById('editContactNumber').value,
                        location: document.getElementById('editLocation').value,
                        message: document.getElementById('editMessage').value
                    };
                    
                    try {
                        await window.emergencySystem.supabase
                            .from('reports')
                            .update(updateData)
                            .eq('id', reportId);
                        
                        window.emergencySystem.showSuccess('Report updated successfully!');
                        closeEditModal();
                        await loadReports();
                        await updateStatistics();
                    } catch (error) {
                        console.error('Failed to update report:', error);
                        window.emergencySystem.showError('Failed to update report: ' + error.message);
                    }
                });
                
            } catch (error) {
                console.error('Failed to load report for editing:', error);
                window.emergencySystem.showError('Failed to load report for editing: ' + error.message);
            }
        }
        
        // Close Edit Modal
        function closeEditModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }
        
        // Archive Report
        async function archiveReport(reportId) {
            if (!confirm('Are you sure you want to archive this report? It will be moved to archived reports.')) {
                return;
            }
            
            try {
                // First, try to update with archive fields
                const { error: archiveError } = await window.emergencySystem.supabase
                    .from('reports')
                    .update({ 
                        status: 'archived',
                        archived_at: new Date().toISOString(),
                        archived_by: window.emergencySystem.user?.id
                    })
                    .eq('id', reportId);
                
                if (archiveError) {
                    // If archive fields don't exist, fall back to just updating status
                    console.warn('Archive fields not available, falling back to status update:', archiveError);
                    const { error: statusError } = await window.emergencySystem.supabase
                        .from('reports')
                        .update({ 
                            status: 'archived'
                        })
                        .eq('id', reportId);
                    
                    if (statusError) throw statusError;
                }
                
                window.emergencySystem.showSuccess('Report archived successfully!');
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to archive report:', error);
                window.emergencySystem.showError('Failed to archive report: ' + error.message);
            }
        }
        
        // Delete Report (permanent)
        async function deleteReport(reportId) {
            if (!confirm('Are you sure you want to permanently delete this report? This action cannot be undone.')) {
                return;
            }
            
            try {
                await window.emergencySystem.supabase
                    .from('reports')
                    .delete()
                    .eq('id', reportId);
                
                window.emergencySystem.showSuccess('Report deleted permanently!');
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to delete report:', error);
                window.emergencySystem.showError('Failed to delete report: ' + error.message);
            }
        }
        
        // Show Archived Reports
        async function showArchivedReports() {
            try {
                const { data: archivedReports, error } = await window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .eq('status', 'archived')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (archivedReports.length === 0) {
                    window.emergencySystem.showInfo('No archived reports found.');
                    return;
                }
                
                // Create archived reports modal
                const modalContent = `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="padding: 20px;">
                        <div style="background: white; border-radius: 12px; max-width: 1000px; width: 100%; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);">
                            <div style="padding: 24px 24px 0 24px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="font-size: 20px; font-weight: 600; color: #111827; margin: 0;">üìÅ Archived Reports (${archivedReports.length})</h3>
                                <button onclick="closeArchivedModal()" style="background: none; border: none; font-size: 24px; color: #6b7280; cursor: pointer; padding: 4px; border-radius: 4px;">‚úï</button>
                            </div>
                            <div style="padding: 24px; overflow-y: auto; flex: 1;">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead>
                                        <tr class="border-b">
                                            <th class="text-left p-2">ID</th>
                                            <th class="text-left p-2">Type</th>
                                            <th class="text-left p-2">Reporter</th>
                                            <th class="text-left p-2">Archived</th>
                                            <th class="text-left p-2">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${archivedReports.map(report => `
                                            <tr class="border-b">
                                                <td class="p-2 font-mono text-sm">${report.id.substring(0, 8)}...</td>
                                                <td class="p-2">${getEmergencyIcon(report.type)} ${String(report.type || 'other').toUpperCase()}</td>
                                                <td class="p-2">${report.reporter_name || 'Anonymous'}</td>
                                                <td class="p-2 text-sm">${report.archived_at ? new Date(report.archived_at).toLocaleString() : new Date(report.created_at).toLocaleString()}</td>
                                                <td class="p-2">
                                                    <div class="flex gap-1">
                                                        <button onclick="restoreReport('${report.id}')" class="btn btn-success btn-sm">üîÑ Restore</button>
                                                        <button onclick="permanentDeleteReport('${report.id}')" class="btn btn-danger btn-sm">üóëÔ∏è Delete</button>
                                                    </div>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalContent);
            } catch (error) {
                console.error('Failed to load archived reports:', error);
                window.emergencySystem.showError('Failed to load archived reports: ' + error.message);
            }
        }
        
        // Close Archived Modal
        function closeArchivedModal() {
            const modal = document.querySelector('.fixed.inset-0');
            if (modal) {
                modal.remove();
            }
        }
        
        // Restore Report from Archive
        async function restoreReport(reportId) {
            if (!confirm('Are you sure you want to restore this report from archive?')) {
                return;
            }
            
            try {
                // First, try to update with archive fields
                const { error: restoreError } = await window.emergencySystem.supabase
                    .from('reports')
                    .update({ 
                        status: 'pending',
                        archived_at: null,
                        archived_by: null
                    })
                    .eq('id', reportId);
                
                if (restoreError) {
                    // If archive fields don't exist, fall back to just updating status
                    console.warn('Archive fields not available, falling back to status update:', restoreError);
                    const { error: statusError } = await window.emergencySystem.supabase
                        .from('reports')
                        .update({ 
                            status: 'pending'
                        })
                        .eq('id', reportId);
                    
                    if (statusError) throw statusError;
                }
                
                window.emergencySystem.showSuccess('Report restored successfully!');
                closeArchivedModal();
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to restore report:', error);
                window.emergencySystem.showError('Failed to restore report: ' + error.message);
            }
        }
        
        // Permanent Delete from Archive
        async function permanentDeleteReport(reportId) {
            if (!confirm('Are you sure you want to permanently delete this archived report? This action cannot be undone.')) {
                return;
            }
            
            try {
                await window.emergencySystem.supabase
                    .from('reports')
                    .delete()
                    .eq('id', reportId);
                
                window.emergencySystem.showSuccess('Report permanently deleted!');
                closeArchivedModal();
                await loadReports();
                await updateStatistics();
            } catch (error) {
                console.error('Failed to permanently delete report:', error);
                window.emergencySystem.showError('Failed to permanently delete report: ' + error.message);
            }
        }


        // Loading indicator functions
        function showLoadingIndicator() {
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loading-indicator';
            loadingDiv.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                           background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                           z-index: 9999; display: flex; align-items: center; gap: 10px;">
                    <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #fbbf24; 
                               border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span>Loading...</span>
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            document.body.appendChild(loadingDiv);
        }

        function hideLoadingIndicator() {
            const loadingDiv = document.getElementById('loading-indicator');
            if (loadingDiv) {
                loadingDiv.remove();
            }
        }

        // Dashboard data loading
        async function loadDashboardData() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load dashboard data');
                    return;
                }
                
                await loadReports();
                await updateStatistics();
                await loadRecentActivity();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                throw error;
            }
        }

        // Map data loading
        async function loadMapData() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load map data');
                    return;
                }
                
                if (!map) {
                    initializeMap();
                }
                
                // Load all reports and initialize filtering system
                allMapReports = await window.emergencySystem.getReports();
                allMapReports = allMapReports.filter(report => report.status !== 'archived');
                
                // Initialize with all active reports
                filteredMapReports = [...allMapReports];
                updateMapDisplay(filteredMapReports);
                updateMapFilterSummary();
                
            } catch (error) {
                console.error('Error loading map data:', error);
                throw error;
            }
        }

        // Archived reports loading
        async function loadArchivedReports() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load archived reports');
                    return;
                }
                
                const { data: archivedReports, error } = await window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .eq('status', 'archived')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const archivedContainer = document.getElementById('archived-reports-container');
                if (archivedContainer) {
                    if (archivedReports && archivedReports.length > 0) {
                        archivedContainer.innerHTML = archivedReports.map(report => `
                            <div class="card mb-4">
                                <div class="card-body">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <h3 class="font-semibold">${report.type.toUpperCase()} - ${report.reporter_name}</h3>
                                            <p class="text-gray-600">${report.message}</p>
                                            <p class="text-sm text-gray-500">Archived: ${new Date(report.updated_at).toLocaleString()}</p>
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="restoreReport('${report.id}')" class="btn btn-sm btn-success">
                                                üîÑ Restore
                                            </button>
                                            <button onclick="permanentlyDeleteReport('${report.id}')" class="btn btn-sm btn-danger">
                                                üóëÔ∏è Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        archivedContainer.innerHTML = '<p class="text-gray-500 text-center py-8">No archived reports found.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading archived reports:', error);
                throw error;
            }
        }

        // Analytics loading
        async function loadAnalytics() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load analytics');
                    return;
                }
                
                const reports = await window.emergencySystem.getReports();
                updateAnalyticsCharts(reports);
                updateAnalyticsMetrics(reports);
            } catch (error) {
                console.error('Error loading analytics:', error);
                throw error;
            }
        }

        // Recent activity loading
        async function loadRecentActivity() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot load recent activity');
                    return;
                }
                
                const { data: recentReports, error } = await window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);

                if (error) throw error;

                const activityContainer = document.getElementById('recent-activity');
                if (activityContainer && recentReports) {
                    activityContainer.innerHTML = recentReports.map(report => `
                        <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                            <div class="w-2 h-2 bg-${getStatusColor(report.status)} rounded-full"></div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${report.type.toUpperCase()} - ${report.reporter_name}</p>
                                <p class="text-xs text-gray-500">${new Date(report.created_at).toLocaleString()}</p>
                            </div>
                            <span class="text-xs px-2 py-1 bg-${getPriorityColor(report.priority)} text-white rounded">
                                ${report.priority}
                            </span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading recent activity:', error);
            }
        }

        // Analytics charts update
        function updateAnalyticsCharts(reports) {
            updateEmergencyTypesChart(reports);
            updateResponseTimesChart(reports);
        }

        // Analytics metrics update
        function updateAnalyticsMetrics(reports) {
            const totalReports = reports.length;
            const completedReports = reports.filter(r => r.status === 'completed').length;
            const avgResponseTime = calculateAverageResponseTime(reports);
            const successRate = totalReports > 0 ? (completedReports / totalReports * 100).toFixed(1) : 0;

            // Update metrics in analytics section
            const metricsContainer = document.getElementById('analytics-metrics');
            if (metricsContainer) {
                metricsContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2">üìä Total Reports</h3>
                            <p class="text-3xl font-bold text-blue-600">${totalReports}</p>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2">‚è±Ô∏è Avg Response Time</h3>
                            <p class="text-3xl font-bold text-green-600">${avgResponseTime} min</p>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2">üéØ Success Rate</h3>
                            <p class="text-3xl font-bold text-purple-600">${successRate}%</p>
                        </div>
                    </div>
                `;
            }
        }

        // Calculate average response time
        function calculateAverageResponseTime(reports) {
            const completedReports = reports.filter(r => r.status === 'completed' && r.updated_at);
            if (completedReports.length === 0) return 0;
            
            const totalTime = completedReports.reduce((acc, report) => {
                const responseTime = new Date(report.updated_at) - new Date(report.created_at);
                return acc + responseTime;
            }, 0);
            
            return Math.round(totalTime / completedReports.length / (1000 * 60)); // Convert to minutes
        }

        // Utility functions for status and priority colors
        function getStatusColor(status) {
            const colors = {
                'pending': 'yellow-500',
                'processing': 'blue-500',
                'assigned': 'purple-500',
                'in_progress': 'orange-500',
                'completed': 'green-500',
                'archived': 'gray-500'
            };
            return colors[status] || 'gray-500';
        }

        function getPriorityColor(priority) {
            const colors = {
                'low': 'green-500',
                'medium': 'yellow-500',
                'high': 'orange-500',
                'critical': 'red-500'
            };
            return colors[priority] || 'gray-500';
        }

        // Restore archived report
        async function restoreReport(reportId) {
            try {
                const { error } = await window.emergencySystem.supabase
                    .from('reports')
                    .update({ status: 'pending' })
                    .eq('id', reportId);

                if (error) throw error;

                window.emergencySystem.showSuccess('Report restored successfully!');
                await loadArchivedReports();
            } catch (error) {
                console.error('Error restoring report:', error);
                window.emergencySystem.showError('Failed to restore report: ' + error.message);
            }
        }

        // Show archived reports function
        async function showArchivedReports() {
            await loadArchivedReports();
        }

        // Clear all archived reports
        async function clearAllArchived() {
            if (confirm('Are you sure you want to permanently delete all archived reports? This action cannot be undone.')) {
                try {
                    const { error } = await window.emergencySystem.supabase
                        .from('reports')
                        .delete()
                        .eq('status', 'archived');

                    if (error) throw error;

                    window.emergencySystem.showSuccess('All archived reports have been permanently deleted!');
                    await loadArchivedReports();
                } catch (error) {
                    console.error('Error clearing archived reports:', error);
                    window.emergencySystem.showError('Failed to clear archived reports: ' + error.message);
                }
            }
        }

        // Export analytics data
        async function exportAnalytics() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot export analytics');
                    return;
                }
                
                const reports = await window.emergencySystem.getReports();
                const analyticsData = {
                    totalReports: reports.length,
                    completedReports: reports.filter(r => r.status === 'completed').length,
                    pendingReports: reports.filter(r => r.status === 'pending').length,
                    processingReports: reports.filter(r => r.status === 'processing').length,
                    avgResponseTime: calculateAverageResponseTime(reports),
                    successRate: reports.length > 0 ? (reports.filter(r => r.status === 'completed').length / reports.length * 100).toFixed(1) : 0,
                    emergencyTypes: reports.reduce((acc, report) => {
                        acc[report.type] = (acc[report.type] || 0) + 1;
                        return acc;
                    }, {}),
                    exportDate: new Date().toISOString(),
                    reports: reports.map(report => ({
                        id: report.id,
                        type: report.type,
                        status: report.status,
                        priority: report.priority,
                        reporter_name: report.reporter_name,
                        created_at: report.created_at,
                        updated_at: report.updated_at
                    }))
                };

                const dataStr = JSON.stringify(analyticsData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `emergency-analytics-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                window.emergencySystem.showSuccess('Analytics data exported successfully!');
            } catch (error) {
                console.error('Error exporting analytics:', error);
                window.emergencySystem.showError('Failed to export analytics: ' + error.message);
            }
        }

        // Navigation functionality with loading indicators
        async function showSection(sectionName) {
            try {
                // Show loading indicator
                showLoadingIndicator();
                
                // Hide all sections
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.remove('active');
                });
                
                // Remove active class from all nav items
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show selected section
                const targetSection = document.getElementById(sectionName + '-section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Add active class to clicked nav item
                const targetNav = document.getElementById('nav-' + sectionName);
                if (targetNav) {
                    targetNav.classList.add('active');
                }
                
                // Load data for specific sections with proper error handling
                switch(sectionName) {
                    case 'dashboard':
                        await loadDashboardData();
                        break;
                    case 'reports':
                        await loadReports();
                        break;
                    case 'map':
                        await loadMapData();
                        break;
                    case 'archived':
                        await loadArchivedReports();
                        break;
                    case 'analytics':
                        await loadAnalytics();
                        break;
                    case 'settings':
                        await loadSettings();
                        break;
                }
                
                // Hide loading indicator
                hideLoadingIndicator();
                
            } catch (error) {
                console.error('Error loading section:', error);
                window.emergencySystem.showError('Failed to load section data');
                hideLoadingIndicator();
            }
        }

        // Missing functions that are referenced in onclick handlers
        async function permanentlyDeleteReport(reportId) {
            if (!confirm('Are you sure you want to permanently delete this report? This action cannot be undone.')) {
                return;
            }
            
            try {
                const { error } = await window.emergencySystem.supabase
                    .from('reports')
                    .delete()
                    .eq('id', reportId);

                if (error) throw error;

                window.emergencySystem.showSuccess('Report permanently deleted successfully!');
                await loadReports();
            } catch (error) {
                console.error('Error permanently deleting report:', error);
                window.emergencySystem.showError('Failed to permanently delete report: ' + error.message);
            }
        }

        // Enhanced settings save function
        async function saveSettings() {
            try {
                const settings = {
                    emailNotifications: document.getElementById('emailNotifications')?.checked || false,
                    aiProcessing: document.getElementById('aiProcessing')?.checked || true,
                    autoClassification: document.getElementById('autoClassification')?.checked || true,
                    notificationSound: document.getElementById('notificationSound')?.checked || true,
                    theme: document.getElementById('theme')?.value || 'light',
                    language: document.getElementById('language')?.value || 'en',
                    timezone: document.getElementById('timezone')?.value || 'Asia/Manila',
                    refreshInterval: document.getElementById('refreshInterval')?.value || '30',
                    maxReportsPerPage: document.getElementById('maxReportsPerPage')?.value || '10'
                };

                localStorage.setItem('adminSettings', JSON.stringify(settings));
                window.emergencySystem.showSuccess('Settings saved successfully!');
                
                // Apply settings immediately
                applySettings(settings);
                
            } catch (error) {
                console.error('Error saving settings:', error);
                window.emergencySystem.showError('Failed to save settings: ' + error.message);
            }
        }

        // Apply settings function
        function applySettings(settings) {
            // Apply theme
            if (settings.theme === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }

            // Apply refresh interval
            if (window.refreshInterval) {
                clearInterval(window.refreshInterval);
            }
            
            if (settings.refreshInterval && settings.refreshInterval !== '0') {
                window.refreshInterval = setInterval(() => {
                    if (document.getElementById('dashboard-section').classList.contains('active')) {
                        loadDashboardData();
                    } else if (document.getElementById('reports-section').classList.contains('active')) {
                        loadReports();
                    }
                }, parseInt(settings.refreshInterval) * 1000);
            }

            // Apply notification settings
            if (settings.notificationSound) {
                // Enable notification sounds
                window.notificationSoundEnabled = true;
            } else {
                window.notificationSoundEnabled = false;
            }
        }

        // Enhanced load settings function
        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('adminSettings') || '{}');
                
                // Load form values
                if (settings.emailNotifications !== undefined) {
                    const emailCheckbox = document.getElementById('emailNotifications');
                    if (emailCheckbox) emailCheckbox.checked = settings.emailNotifications;
                }
                
                if (settings.aiProcessing !== undefined) {
                    const aiCheckbox = document.getElementById('aiProcessing');
                    if (aiCheckbox) aiCheckbox.checked = settings.aiProcessing;
                }
                
                if (settings.autoClassification !== undefined) {
                    const autoCheckbox = document.getElementById('autoClassification');
                    if (autoCheckbox) autoCheckbox.checked = settings.autoClassification;
                }
                
                if (settings.notificationSound !== undefined) {
                    const soundCheckbox = document.getElementById('notificationSound');
                    if (soundCheckbox) soundCheckbox.checked = settings.notificationSound;
                }
                
                if (settings.theme) {
                    const themeSelect = document.getElementById('theme');
                    if (themeSelect) themeSelect.value = settings.theme;
                }
                
                if (settings.language) {
                    const languageSelect = document.getElementById('language');
                    if (languageSelect) languageSelect.value = settings.language;
                }
                
                if (settings.timezone) {
                    const timezoneSelect = document.getElementById('timezone');
                    if (timezoneSelect) timezoneSelect.value = settings.timezone;
                }
                
                if (settings.refreshInterval) {
                    const refreshSelect = document.getElementById('refreshInterval');
                    if (refreshSelect) refreshSelect.value = settings.refreshInterval;
                }
                
                if (settings.maxReportsPerPage) {
                    const maxReportsSelect = document.getElementById('maxReportsPerPage');
                    if (maxReportsSelect) maxReportsSelect.value = settings.maxReportsPerPage;
                }

                // Apply settings
                applySettings(settings);
                
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }

        // Enhanced export reports function
        async function exportReports() {
            try {
                if (!window.emergencySystem || !window.emergencySystem.supabase) {
                    console.warn('Emergency system not initialized, cannot export reports');
                    return;
                }
                
                const reports = await window.emergencySystem.getReports();
                const exportData = {
                    exportDate: new Date().toISOString(),
                    totalReports: reports.length,
                    reports: reports.map(report => ({
                        id: report.id,
                        type: report.type,
                        status: report.status,
                        priority: report.priority,
                        reporter_name: report.reporter_name,
                        message: report.message,
                        location: report.location,
                        confidence: report.confidence,
                        created_at: report.created_at,
                        updated_at: report.updated_at
                    }))
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `emergency-reports-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                window.emergencySystem.showSuccess('Reports exported successfully!');
            } catch (error) {
                console.error('Error exporting reports:', error);
                window.emergencySystem.showError('Failed to export reports: ' + error.message);
            }
        }

        // Enhanced notification system
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-message">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="notification-close">√ó</button>
                </div>
            `;
            
            // Add notification styles if not already present
            if (!document.getElementById('notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .notification {
                        position: fixed;
                        top: 80px;
                        right: 20px;
                        background: white;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        z-index: 10000;
                        max-width: 400px;
                        animation: slideIn 0.3s ease-out;
                    }
                    .notification-info { border-left: 4px solid #3b82f6; }
                    .notification-success { border-left: 4px solid #10b981; }
                    .notification-warning { border-left: 4px solid #f59e0b; }
                    .notification-error { border-left: 4px solid #ef4444; }
                    .notification-content {
                        padding: 16px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                    }
                    .notification-message {
                        flex: 1;
                        font-size: 14px;
                        color: #374151;
                    }
                    .notification-close {
                        background: none;
                        border: none;
                        font-size: 18px;
                        color: #6b7280;
                        cursor: pointer;
                        margin-left: 12px;
                    }
                    @keyframes slideIn {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // Enhanced error handling
        function handleError(error, context = 'Operation') {
            console.error(`${context} error:`, error);
            const message = error.message || 'An unexpected error occurred';
            showNotification(`${context} failed: ${message}`, 'error');
        }

        // Enhanced success handling
        function handleSuccess(message) {
            showNotification(message, 'success');
        }

        // Get proper image URL from Supabase storage
        function getImageUrl(imagePath) {
            if (!imagePath) return '';
            
            // If it's already a full URL, return it
            if (imagePath.startsWith('http')) {
                return imagePath;
            }
            
            // If it's a storage path, construct the public URL
            if (imagePath.startsWith('emergency-reports/')) {
                return `https://hmolyqzbvxxliemclrld.supabase.co/storage/v1/object/public/reports-images/${imagePath}`;
            }
            
            // For other paths, try to construct the URL
            return `https://hmolyqzbvxxliemclrld.supabase.co/storage/v1/object/public/reports-images/${imagePath}`;
        }

        // Reset settings to default
        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default values? This will clear all your current preferences.')) {
                try {
                    // Clear saved settings
                    localStorage.removeItem('adminSettings');
                    
                    // Reset form to default values
                    document.getElementById('emailNotifications').checked = true;
                    document.getElementById('notificationSound').checked = true;
                    document.getElementById('pushNotifications').checked = true;
                    document.getElementById('aiProcessing').checked = true;
                    document.getElementById('autoClassification').checked = true;
                    document.getElementById('autoPriority').checked = true;
                    document.getElementById('theme').value = 'light';
                    document.getElementById('language').value = 'en';
                    document.getElementById('timezone').value = 'Asia/Manila';
                    document.getElementById('refreshInterval').value = '30';
                    document.getElementById('maxReportsPerPage').value = '10';
                    document.getElementById('responseTime').value = '5';
                    
                    // Apply default settings
                    const defaultSettings = {
                        emailNotifications: true,
                        notificationSound: true,
                        pushNotifications: true,
                        aiProcessing: true,
                        autoClassification: true,
                        autoPriority: true,
                        theme: 'light',
                        language: 'en',
                        timezone: 'Asia/Manila',
                        refreshInterval: '30',
                        maxReportsPerPage: '10',
                        responseTime: '5'
                    };
                    
                    applySettings(defaultSettings);
                    showNotification('Settings reset to default values!', 'success');
                    
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showNotification('Failed to reset settings: ' + error.message, 'error');
                }
            }
        }

        // Enhanced pagination functions
        function setupPagination() {
            // Add pagination event listeners
            document.querySelectorAll('.page-number').forEach(button => {
                button.addEventListener('click', function() {
                    const page = parseInt(this.textContent);
                    if (!isNaN(page)) {
                        loadReportsPage(page);
                    }
                });
            });
        }

        // Load reports with pagination
        async function loadReportsPage(page = 1) {
            try {
                showLoadingIndicator();
                
                const reportsPerPage = parseInt(document.getElementById('maxReportsPerPage')?.value || '10');
                const start = (page - 1) * reportsPerPage;
                const end = start + reportsPerPage;
                
                const { data: reports, error } = await window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .neq('status', 'archived')
                    .order('created_at', { ascending: false })
                    .range(start, end - 1);

                if (error) throw error;

                displayReportsTable(reports);
                updatePaginationUI(page, reportsPerPage);
                
                hideLoadingIndicator();
            } catch (error) {
                console.error('Error loading reports page:', error);
                handleError(error, 'Loading reports');
                hideLoadingIndicator();
            }
        }

        // Update pagination UI
        function updatePaginationUI(currentPage, reportsPerPage) {
            const paginationContainer = document.querySelector('.pagination');
            if (paginationContainer) {
                // Update active page indicator
                document.querySelectorAll('.page-number').forEach(btn => {
                    btn.classList.remove('active');
                    if (parseInt(btn.textContent) === currentPage) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        // Enhanced search functionality
        function setupSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                searchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(this.value);
                    }, 300);
                });
            }
        }

        // Perform search
        async function performSearch(query) {
            try {
                if (!query.trim()) {
                    await loadReports();
                    return;
                }

                const { data: reports, error } = await window.emergencySystem.supabase
                    .from('reports')
                    .select('*')
                    .or(`reporter_name.ilike.%${query}%,message.ilike.%${query}%,type.ilike.%${query}%`)
                    .neq('status', 'archived')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayReportsTable(reports);
                showNotification(`Found ${reports.length} reports matching "${query}"`, 'info');
                
            } catch (error) {
                console.error('Error performing search:', error);
                handleError(error, 'Search');
            }
        }

        // Enhanced filter functionality
        function setupFilters() {
            const statusFilter = document.getElementById('statusFilter');
            const typeFilter = document.getElementById('typeFilter');
            const priorityFilter = document.getElementById('priorityFilter');

            [statusFilter, typeFilter, priorityFilter].forEach(filter => {
                if (filter) {
                    filter.addEventListener('change', function() {
                        applyFilters();
                    });
                }
            });
        }

        // Apply filters
        async function applyFilters() {
            try {
                const statusFilter = document.getElementById('statusFilter')?.value;
                const typeFilter = document.getElementById('typeFilter')?.value;
                const priorityFilter = document.getElementById('priorityFilter')?.value;

                let query = window.emergencySystem.supabase.from('reports').select('*');

                if (statusFilter && statusFilter !== 'all') {
                    query = query.eq('status', statusFilter);
                } else {
                    // By default, exclude archived reports unless specifically requested
                    query = query.neq('status', 'archived');
                }
                if (typeFilter && typeFilter !== 'all') {
                    query = query.eq('type', typeFilter);
                }
                if (priorityFilter && priorityFilter !== 'all') {
                    query = query.eq('priority', priorityFilter);
                }

                const { data: reports, error } = await query.order('created_at', { ascending: false });

                if (error) throw error;

                displayReportsTable(reports);
                showNotification(`Filtered to ${reports.length} reports`, 'info');
                
            } catch (error) {
                console.error('Error applying filters:', error);
                handleError(error, 'Filtering');
            }
        }

        // Mobile menu functionality
        function toggleMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            
            if (sidebar && mobileToggle) {
                sidebar.classList.toggle('open');
                mobileToggle.textContent = sidebar.classList.contains('open') ? '‚úï' : '‚ò∞';
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar');
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            
            if (sidebar && mobileToggle && 
                !sidebar.contains(event.target) && 
                !mobileToggle.contains(event.target) &&
                sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                mobileToggle.textContent = '‚ò∞';
            }
        });

        // Sign out functionality
        async function signOut() {
            try {
                if (confirm('Are you sure you want to sign out?')) {
                    if (window.emergencySystem && window.emergencySystem.signOut) {
                        await window.emergencySystem.signOut();
                    }
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('Error signing out:', error);
                showNotification('Failed to sign out: ' + error.message, 'error');
            }
        }

        // Show mobile menu toggle on small screens
        function checkScreenSize() {
            const mobileToggle = document.querySelector('.mobile-menu-toggle');
            if (window.innerWidth <= 768) {
                if (mobileToggle) mobileToggle.style.display = 'block';
            } else {
                if (mobileToggle) mobileToggle.style.display = 'none';
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) sidebar.classList.remove('open');
            }
        }

        // Listen for window resize
        window.addEventListener('resize', checkScreenSize);

        // Initialize all functionality on page load
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // Initialize Emergency Response System first
                window.emergencySystem = new EmergencyResponseSystem();
                await window.emergencySystem.initialize();
                
                // Load settings first
                loadSettings();
                
                // Initialize all components
                setupPagination();
                setupSearch();
                setupFilters();
                
                // Check screen size for mobile menu
                checkScreenSize();
                
                // Load initial data
                await loadDashboardData();
                
                // Set up real-time notifications
                await setupNotifications();
                
                // Initialize map if needed
                if (document.getElementById('map-section').classList.contains('active')) {
                    initializeMap();
                }
                
                console.log('Admin dashboard initialized successfully');
                
            } catch (error) {
                console.error('Error initializing admin dashboard:', error);
                showNotification('Failed to initialize dashboard: ' + error.message, 'error');
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationChannel) {
                notificationChannel.unsubscribe();
            }
        });
    </script>
</body>
</html>
