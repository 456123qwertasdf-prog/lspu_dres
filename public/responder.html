<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Responder Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="flex items-center justify-between">
                <a href="index.html" class="navbar-brand">üö® LSPU Emergency Response</a>
                <div class="navbar-nav">
                    <a href="responder.html" class="nav-link active">Responder Dashboard</a>
                    <div data-auth="required" class="hidden">
                        <span data-user-info="email" class="text-sm text-gray-600"></span>
                        <button onclick="emergencySystem.signOut()" class="btn btn-outline btn-sm">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Alerts Container -->
    <div class="alerts-container"></div>

    <!-- Main Content -->
    <main class="container" style="margin-top: 2rem;">
        <!-- Header -->
        <section class="text-center mb-8">
            <div class="mb-4">
                <a href="user.html" class="btn btn-outline btn-sm">‚Üê Back to Home</a>
            </div>
            <h1 class="mb-4">üö® Emergency Responder Dashboard</h1>
            <p class="text-lg text-gray-600 mb-8">
                Monitor and respond to emergency reports in real-time. Get instant notifications for new emergencies.
            </p>
        </section>

        <!-- Status Cards -->
        <section class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="card text-center">
                <div class="text-3xl mb-2">üö®</div>
                <div class="text-2xl font-bold text-red-600" id="totalEmergencies">0</div>
                <div class="text-sm text-gray-600">Total Emergencies</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">‚è≥</div>
                <div class="text-2xl font-bold text-yellow-600" id="pendingReports">0</div>
                <div class="text-sm text-gray-600">Pending Reports</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">üîÑ</div>
                <div class="text-2xl font-bold text-blue-600" id="processingReports">0</div>
                <div class="text-sm text-gray-600">Processing</div>
            </div>
            <div class="card text-center">
                <div class="text-3xl mb-2">‚úÖ</div>
                <div class="text-2xl font-bold text-green-600" id="completedReports">0</div>
                <div class="text-sm text-gray-600">Completed</div>
            </div>
        </section>

        <!-- Emergency Reports -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Active Emergency Reports</h2>
                <p class="card-subtitle">Real-time emergency reports requiring immediate attention</p>
            </div>

            <!-- Filters -->
            <div class="flex gap-4 mb-6">
                <select id="statusFilter" class="form-input form-select" style="max-width: 200px;">
                    <option value="">All Status</option>
                    <option value="pending">Pending</option>
                    <option value="processing">Processing</option>
                    <option value="classified">Classified</option>
                    <option value="assigned">Assigned</option>
                    <option value="in_progress">In Progress</option>
                    <option value="completed">Completed</option>
                </select>
                <select id="typeFilter" class="form-input form-select" style="max-width: 200px;">
                    <option value="">All Types</option>
                    <option value="fire">Fire</option>
                    <option value="medical">Medical</option>
                    <option value="accident">Accident</option>
                    <option value="flood">Flood</option>
                    <option value="earthquake">Earthquake</option>
                    <option value="storm">Storm</option>
                    <option value="other">Other</option>
                </select>
                <button onclick="loadReports()" class="btn btn-secondary">üîÑ Refresh</button>
            </div>

            <!-- Reports List -->
            <div id="reportsList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-4">üìã</div>
                    <p>Loading emergency reports...</p>
                </div>
            </div>
        </section>

        <!-- Emergency Response Map Section -->
        <section class="card mt-8">
            <div class="card-header">
                <h2 class="card-title">üö® Emergency Response Map</h2>
                <p class="card-subtitle">Navigate to emergency locations and track your response</p>
            </div>
            
            <!-- Emergency Response Controls -->
            <div class="mb-4 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Current Assignment -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-2">üéØ Current Assignment</h3>
                        <div id="currentAssignment" class="text-sm text-gray-600">
                            No active assignment
                        </div>
                        <button id="startNavigationBtn" onclick="startNavigation()" 
                                class="btn btn-sm mt-2 hidden" style="background: #ef4444; color: white;">
                            üß≠ Start Navigation
                        </button>
                    </div>
                    
                    <!-- Response Status -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-2">üìä Response Status</h3>
                        <div id="responseStatus" class="text-sm text-gray-600">
                            <div>Status: <span id="responderStatus">Available</span></div>
                            <div>Location: <span id="responderLocation">Getting location...</span></div>
                        </div>
                    </div>
                    
                    <!-- Emergency Types Filter -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-2">üîç Filter Emergencies</h3>
                        <select id="emergencyTypeFilter" class="form-input w-full text-sm" onchange="filterEmergencyTypes()">
                            <option value="all">All Types</option>
                            <option value="fire">üî• Fire</option>
                            <option value="medical">üè• Medical</option>
                            <option value="accident">üöó Accident</option>
                            <option value="flood">üåä Flood</option>
                            <option value="earthquake">üåç Earthquake</option>
                            <option value="storm">‚õàÔ∏è Storm</option>
                        </select>
                    </div>
                    
                    <!-- Priority Filter -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <h3 class="font-semibold text-gray-800 mb-2">‚ö° Priority Level</h3>
                        <select id="priorityFilter" class="form-input w-full text-sm" onchange="filterByPriority()">
                            <option value="all">All Priorities</option>
                            <option value="1">üö® Critical (P1)</option>
                            <option value="2">üî¥ High (P2)</option>
                            <option value="3">üü° Medium (P3)</option>
                            <option value="4">üü¢ Low (P4)</option>
                            <option value="5">‚ÑπÔ∏è Info (P5)</option>
                        </select>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-4 flex flex-wrap gap-2">
                    <button onclick="updateResponderStatus('available')" class="btn btn-sm" style="background: #10b981; color: white;">
                        ‚úÖ Mark Available
                    </button>
                    <button onclick="updateResponderStatus('busy')" class="btn btn-sm" style="background: #f59e0b; color: white;">
                        üöß Mark Busy
                    </button>
                    <button onclick="updateResponderStatus('offline')" class="btn btn-sm" style="background: #6b7280; color: white;">
                        üî¥ Go Offline
                    </button>
                    <button onclick="refreshEmergencyData()" class="btn btn-sm" style="background: #3b82f6; color: white;">
                        üîÑ Refresh Data
                    </button>
                </div>
            </div>
            
            <!-- Map with Navigation Features -->
            <div class="relative">
                <div id="mapContainer" class="map-container" style="height: 600px; border-radius: 8px; position: relative;">
                    <div id="map" style="height: 100%; width: 100%; border-radius: 8px;"></div>
                    
                    <!-- Map Overlay Controls -->
                    <div class="absolute top-4 right-4 bg-white rounded-lg shadow-lg p-3 z-10">
                        <div class="flex flex-col gap-2">
                            <button onclick="centerOnResponder()" class="btn btn-sm" style="background: #3b82f6; color: white;">
                                üìç My Location
                            </button>
                            <button onclick="showAllEmergencies()" class="btn btn-sm" style="background: #ef4444; color: white;">
                                üö® All Emergencies
                            </button>
                            <button onclick="toggleTrafficLayer()" class="btn btn-sm" style="background: #6b7280; color: white;">
                                üõ£Ô∏è Traffic
                            </button>
                        </div>
                    </div>
                    
                    <!-- Navigation Status -->
                    <div id="navigationStatus" class="absolute bottom-4 left-4 bg-white rounded-lg shadow-lg p-3 z-10 hidden">
                        <div class="flex items-center gap-2">
                            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                            <span class="text-sm font-medium">Calculating route...</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t mt-16">
        <div class="container py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="font-semibold mb-4">Emergency Response</h3>
                    <p class="text-sm text-gray-600">AI-powered emergency reporting and response management system.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-4">Quick Links</h3>
                    <div class="space-y-2">
                        <a href="responder.html" class="block text-sm text-gray-600 hover:text-gray-800">Responder Dashboard</a>
                        <a href="login.html" class="block text-sm text-gray-600 hover:text-gray-800">Switch Role</a>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-4">Contact</h3>
                    <p class="text-sm text-gray-600">LSPU Emergency Response System</p>
                    <p class="text-sm text-gray-600">For emergencies, call 911</p>
                </div>
            </div>
            <div class="border-t mt-8 pt-4 text-center text-sm text-gray-500">
                <p>&copy; 2024 LSPU Emergency Response System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Report Details Modal -->
    <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="card" style="max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div class="card-header">
                <h3 class="card-title" id="modalTitle">Emergency Report Details</h3>
                <button onclick="hideReportModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">√ó</button>
            </div>
            
            <div id="modalContent">
                <!-- Content will be populated dynamically -->
            </div>
            
            <div class="flex gap-4 mt-6">
                <button id="acceptBtn" class="btn btn-primary flex-1">Accept Assignment</button>
                <button id="completeBtn" class="btn btn-success flex-1">Mark Complete</button>
                <button onclick="hideReportModal()" class="btn btn-outline">Close</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let currentReports = [];
        let notificationChannel = null;

        // Check user role and redirect if necessary
        function checkUserRole() {
            if (!emergencySystem.user) {
                window.location.href = 'login.html';
                return false;
            }
            
            const userRole = emergencySystem.user?.user_metadata?.role || 'citizen';
            
            if (userRole !== 'responder' && userRole !== 'admin') {
                // Redirect to appropriate dashboard
                if (userRole === 'citizen') {
                    window.location.href = 'user.html';
                } else if (userRole === 'admin') {
                    window.location.href = 'admin.html';
                }
                return false;
            }
            
            return true;
        }

        // Initialize responder dashboard
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for system initialization
            await new Promise(resolve => {
                const checkInit = () => {
                    if (emergencySystem.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });

            // Check user role
            if (!checkUserRole()) {
                return;
            }

            // Load initial data
            await loadReports();
            await updateStatusCards();
            
            // Set up real-time notifications
            await setupNotifications();
            
            // Set up filters
            document.getElementById('statusFilter').addEventListener('change', loadReports);
            document.getElementById('typeFilter').addEventListener('change', loadReports);
            
            // Initialize responder location tracking
            updateResponderLocation();
            
            // Set up location updates
            setInterval(updateResponderLocation, 30000); // Update every 30 seconds
            
            // Request notification permission for navigation alerts
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        });

        // Load emergency reports
        async function loadReports() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                const typeFilter = document.getElementById('typeFilter').value;
                
                const filters = {};
                if (statusFilter) filters.status = statusFilter;
                if (typeFilter) filters.type = typeFilter;
                
                // Get all reports first
                const allReports = await emergencySystem.getReports(filters);
                
                // Filter out archived reports - responders should not see archived reports
                currentReports = allReports.filter(report => report.status !== 'archived');
                
                displayReports(currentReports);
            } catch (error) {
                console.error('Failed to load reports:', error);
                emergencySystem.showError('Failed to load emergency reports');
            }
        }

        // Display reports in the list
        function displayReports(reports) {
            const reportsList = document.getElementById('reportsList');
            
            if (reports.length === 0) {
                reportsList.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <div class="text-4xl mb-4">üìã</div>
                        <p>No emergency reports found</p>
                    </div>
                `;
                updateMapDisplay([]);
                return;
            }

            // Update map with reports using enhanced responder features
            updateMapDisplayWithResponderFeatures(reports);
            
            // Initialize map if not already done
            if (!map) {
                initializeMap();
            }

            reportsList.innerHTML = reports.map(report => `
                <div class="card cursor-pointer hover:shadow-lg transition-shadow" onclick="showReportDetails('${report.id}')">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="flex items-center gap-4 mb-2">
                                <h4 class="font-semibold text-lg">${getEmergencyIcon(report.type)} ${report.type.toUpperCase()} Emergency</h4>
                                <span class="badge badge-${report.status}">${report.status}</span>
                            </div>
                            <p class="text-gray-600 mb-2">${report.description}</p>
                            <div class="flex items-center gap-4 text-sm text-gray-500">
                                <span>üìç ${report.location || 'Location not specified'}</span>
                                <span>üë§ ${report.reporter_name || 'Anonymous'}</span>
                                <span>üïí ${new Date(report.created_at).toLocaleString()}</span>
                            </div>
                            ${report.confidence ? `
                                <div class="mt-2">
                                    <span class="text-sm text-blue-600">ü§ñ AI Confidence: ${Math.round(report.confidence * 100)}%</span>
                                </div>
                            ` : ''}
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Priority</div>
                            <div class="font-semibold text-${getPriorityColor(report.priority)}">Priority ${report.priority || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Show report details modal
        async function showReportDetails(reportId) {
            try {
                const report = await emergencySystem.getReportById(reportId);
                
                document.getElementById('modalTitle').textContent = `${report.type.toUpperCase()} Emergency Report`;
                
                document.getElementById('modalContent').innerHTML = `
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold mb-2">Emergency Details</h4>
                            <p class="text-gray-600">${report.description}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <h5 class="font-semibold mb-1">Type</h5>
                                <p class="text-gray-600">${report.type}</p>
                            </div>
                            <div>
                                <h5 class="font-semibold mb-1">Status</h5>
                                <span class="badge badge-${report.status}">${report.status}</span>
                            </div>
                            <div>
                                <h5 class="font-semibold mb-1">Priority</h5>
                                <p class="text-gray-600">${report.priority || 'Medium'}</p>
                            </div>
                            <div>
                                <h5 class="font-semibold mb-1">AI Confidence</h5>
                                <p class="text-gray-600">${report.confidence ? Math.round(report.confidence * 100) + '%' : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold mb-1">Location</h5>
                            <p class="text-gray-600">${report.location || 'Location not specified'}</p>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold mb-1">Reporter</h5>
                            <p class="text-gray-600">${report.reporter_name || 'Anonymous'} - ${report.contact_number || 'No contact'}</p>
                        </div>
                        
                        <div>
                            <h5 class="font-semibold mb-1">Reported At</h5>
                            <p class="text-gray-600">${new Date(report.created_at).toLocaleString()}</p>
                        </div>
                        
                        ${report.image_path ? `
                            <div>
                                <h5 class="font-semibold mb-1">Emergency Photo</h5>
                                <img src="${report.image_path}" alt="Emergency photo" class="rounded-lg shadow" style="max-width: 100%; max-height: 200px;">
                            </div>
                        ` : ''}
                        
                        ${report.ai_labels ? `
                            <div>
                                <h5 class="font-semibold mb-1">AI Analysis</h5>
                                <div class="text-sm text-gray-600">
                                    ${report.ai_labels.map(label => `${label.label} (${Math.round(label.score * 100)}%)`).join(', ')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // Update button states
                const acceptBtn = document.getElementById('acceptBtn');
                const completeBtn = document.getElementById('completeBtn');
                
                acceptBtn.onclick = () => acceptAssignment(reportId);
                completeBtn.onclick = () => completeAssignment(reportId);
                
                if (report.status === 'completed') {
                    acceptBtn.style.display = 'none';
                    completeBtn.textContent = 'Already Completed';
                    completeBtn.disabled = true;
                } else if (report.status === 'assigned' || report.status === 'in_progress') {
                    acceptBtn.textContent = 'Update Status';
                    completeBtn.style.display = 'block';
                }
                
                document.getElementById('reportModal').classList.remove('hidden');
            } catch (error) {
                console.error('Failed to load report details:', error);
                emergencySystem.showError('Failed to load report details');
            }
        }

        // Hide report modal
        function hideReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
        }

        // Accept assignment
        async function acceptAssignment(reportId) {
            try {
                await emergencySystem.updateReportStatus(reportId, 'assigned', 'Assignment accepted by responder');
                emergencySystem.showSuccess('Assignment accepted successfully!');
                hideReportModal();
                await loadReports();
                await updateStatusCards();
            } catch (error) {
                console.error('Failed to accept assignment:', error);
                emergencySystem.showError('Failed to accept assignment');
            }
        }

        // Complete assignment
        async function completeAssignment(reportId) {
            try {
                await emergencySystem.updateReportStatus(reportId, 'completed', 'Emergency response completed');
                emergencySystem.showSuccess('Assignment marked as completed!');
                hideReportModal();
                await loadReports();
                await updateStatusCards();
            } catch (error) {
                console.error('Failed to complete assignment:', error);
                emergencySystem.showError('Failed to complete assignment');
            }
        }

        // Update status cards
        async function updateStatusCards() {
            try {
                const allReports = await emergencySystem.getReports();
                
                // Filter out archived reports from statistics - responders should not see archived reports
                const activeReports = allReports.filter(report => report.status !== 'archived');
                
                const total = activeReports.length;
                const pending = activeReports.filter(r => r.status === 'pending').length;
                const processing = activeReports.filter(r => r.status === 'processing' || r.status === 'classified').length;
                const completed = activeReports.filter(r => r.status === 'completed').length;
                
                document.getElementById('totalEmergencies').textContent = total;
                document.getElementById('pendingReports').textContent = pending;
                document.getElementById('processingReports').textContent = processing;
                document.getElementById('completedReports').textContent = completed;
            } catch (error) {
                console.error('Failed to update status cards:', error);
            }
        }

        // Set up real-time notifications
        async function setupNotifications() {
            try {
                notificationChannel = await emergencySystem.subscribeToNotifications((payload) => {
                    console.log('üîî New notification:', payload);
                    
                    if (payload.eventType === 'INSERT') {
                        emergencySystem.showInfo('üö® New emergency report received!');
                        emergencySystem.sendNotification(
                            'New Emergency Report',
                            `New ${payload.new.type} emergency reported`,
                            'emergency'
                        );
                    }
                    
                    // Refresh data
                    loadReports();
                    updateStatusCards();
                });
            } catch (error) {
                console.error('Failed to set up notifications:', error);
            }
        }

        // Initialize Leaflet map
        let map = null;
        let markers = [];

        function initializeMap() {
            if (map) {
                map.remove();
            }
            
            // Initialize map centered on Philippines
            map = L.map('map').setView([14.5995, 120.9842], 6);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Add zoom event listener to update marker sizes
            map.on('zoomend', function() {
                updateMarkerSizes();
            });
        }

        // Global variable for manual marker size
        let manualMarkerSize = 80;

        // Adjust marker size manually
        function adjustMarkerSize(size) {
            manualMarkerSize = parseInt(size);
            document.getElementById('markerSizeValue').textContent = size + 'px';
            updateMarkerSizes();
        }

        // Update marker sizes based on zoom level
        function updateMarkerSizes() {
            if (!map || markers.length === 0) return;
            
            const currentZoom = map.getZoom();
            const baseSize = manualMarkerSize; // Use manual size instead of fixed 80
            const zoomFactor = Math.max(0.8, Math.min(2.0, currentZoom / 10));
            const dynamicSize = Math.round(baseSize * zoomFactor);
            
            markers.forEach((marker, index) => {
                const report = currentReports[index];
                if (report) {
                    const icon = getEmergencyIcon(report.type);
                    const statusColor = getStatusColor(report.status);
                    
                    const customIcon = L.divIcon({
                        html: `
                            <div class="bg-white rounded-full shadow-2xl border-4 border-${statusColor} transform hover:scale-125 transition-all duration-300" 
                             style="width: ${dynamicSize}px; height: ${dynamicSize}px; display: flex; align-items: center; justify-content: center;">
                                <div class="text-4xl drop-shadow-lg" style="font-size: ${Math.round(dynamicSize * 0.4)}px;">${icon}</div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [dynamicSize, dynamicSize],
                        iconAnchor: [dynamicSize/2, dynamicSize/2],
                        popupAnchor: [0, -dynamicSize/2]
                    });
                    
                    marker.setIcon(customIcon);
                }
            });
        }

        // Update map display with emergency locations
        function updateMapDisplay(reports) {
            if (!map) {
                initializeMap();
            }
            
            // Store reports for marker updates
            currentReports = reports;
            
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (reports.length === 0) {
                // Show message on map
                const noDataDiv = L.divIcon({
                    html: `
                        <div class="text-center p-4 bg-white rounded-lg shadow-lg">
                            <div class="text-4xl mb-2">üó∫Ô∏è</div>
                            <div class="font-semibold text-gray-800">No emergency locations</div>
                            <div class="text-sm text-gray-600">Reports will appear here when available</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [200, 100]
                });
                
                const noDataMarker = L.marker([14.5995, 120.9842], { icon: noDataDiv }).addTo(map);
                markers.push(noDataMarker);
                return;
            }

            // Add markers for each emergency location
            const bounds = L.latLngBounds();
            
            reports.forEach(report => {
                // Get coordinates for Philippines locations (simplified)
                const coordinates = getCoordinatesForLocation(report.location);
                
                if (coordinates) {
                    const icon = getEmergencyIcon(report.type);
                    const statusColor = getStatusColor(report.status);
                    
                    const customIcon = L.divIcon({
                        html: `
                            <div class="bg-white rounded-full p-3 shadow-xl border-4 border-${statusColor} transform hover:scale-110 transition-transform">
                                <div class="text-3xl drop-shadow-lg">${icon}</div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [60, 60]
                    });
                    
                    const marker = L.marker(coordinates, { icon: customIcon }).addTo(map);
                    
                    // Add popup with report details
                    marker.bindPopup(`
                        <div class="p-4 min-w-64">
                            <div class="flex items-center gap-2 mb-3">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-bold text-lg text-gray-800">${report.type.toUpperCase()} Emergency</div>
                                    <div class="text-sm text-gray-600">${formatLocationDisplay(report.location)}</div>
                                </div>
                            </div>
                            
                            <div class="space-y-2">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Status:</span>
                                    <span class="badge badge-${report.status} text-xs">${report.status.toUpperCase()}</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Reporter:</span>
                                    <span class="text-sm text-gray-600">${report.reporter_name || 'Anonymous'}</span>
                                </div>
                                
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-medium text-gray-700">Priority:</span>
                                    <span class="text-sm font-semibold text-${getPriorityColor(report.priority)}">Priority ${report.priority || 'N/A'}</span>
                                </div>
                                
                                ${report.confidence ? `
                                    <div class="flex justify-between items-center">
                                        <span class="text-sm font-medium text-gray-700">AI Confidence:</span>
                                        <div class="flex items-center gap-1">
                                            <div class="w-16 bg-gray-200 rounded-full h-1">
                                                <div class="bg-blue-600 h-1 rounded-full" style="width: ${report.confidence * 100}%"></div>
                                            </div>
                                            <span class="text-xs font-semibold text-blue-600">${Math.round(report.confidence * 100)}%</span>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="text-xs text-gray-500 mt-2">
                                    Reported: ${new Date(report.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `, {
                        maxWidth: 300,
                        className: 'custom-popup'
                    });
                    
                    markers.push(marker);
                    bounds.extend(coordinates);
                }
            });
            
            // Fit map to show all markers
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Format location for display in popups
        function formatLocationDisplay(location) {
            // Handle new JSON format with latitude/longitude
            if (typeof location === 'string' && location.startsWith('{')) {
                try {
                    const locationData = JSON.parse(location);
                    if (locationData.address && locationData.address !== 'Location detected') {
                        return locationData.address;
                    } else if (locationData.latitude && locationData.longitude) {
                        return `${locationData.latitude.toFixed(6)}, ${locationData.longitude.toFixed(6)}`;
                    }
                } catch (e) {
                    console.warn('Failed to parse location JSON:', e);
                }
            }
            
            // Handle old string format
            return location || 'Unknown Location';
        }

        // Get coordinates for Philippines locations
        function getCoordinatesForLocation(location) {
            // Handle new JSON format with latitude/longitude
            if (typeof location === 'string' && location.startsWith('{')) {
                try {
                    const locationData = JSON.parse(location);
                    if (locationData.latitude && locationData.longitude) {
                        return [locationData.latitude, locationData.longitude];
                    }
                } catch (e) {
                    console.warn('Failed to parse location JSON:', e);
                }
            }
            
            // Handle old string format
            const locationMap = {
                'Manila, Philippines': [14.5995, 120.9842],
                'Quezon City, Philippines': [14.6760, 121.0437],
                'Makati, Philippines': [14.5547, 121.0244],
                'Pasig, Philippines': [14.5604, 121.0885],
                'Test Location': [14.5995, 120.9842]
            };
            
            return locationMap[location] || null;
        }

        // Get status color for markers
        function getStatusColor(status) {
            const colors = {
                pending: 'yellow-500',
                processing: 'blue-500',
                assigned: 'purple-500',
                completed: 'green-500',
                classified: 'blue-500'
            };
            return colors[status] || 'gray-500';
        }

        // Enhanced Emergency Response Functions
        let currentAssignment = null;
        let responderLocation = null;
        let responderStatus = 'available';
        let trafficLayer = null;
        let navigationRoute = null;

        // Update responder status
        async function updateResponderStatus(status) {
            try {
                responderStatus = status;
                document.getElementById('responderStatus').textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                // Update status color
                const statusElement = document.getElementById('responderStatus');
                statusElement.className = `text-sm font-medium ${
                    status === 'available' ? 'text-green-600' :
                    status === 'busy' ? 'text-yellow-600' :
                    'text-gray-600'
                }`;
                
                emergencySystem.showSuccess(`Status updated to: ${status}`);
                
                // If going offline, clear current assignment
                if (status === 'offline') {
                    currentAssignment = null;
                    updateCurrentAssignment();
                }
                
            } catch (error) {
                console.error('Failed to update responder status:', error);
                emergencySystem.showError('Failed to update status');
            }
        }

        // Filter emergency types
        function filterEmergencyTypes() {
            const typeFilter = document.getElementById('emergencyTypeFilter').value;
            const priorityFilter = document.getElementById('priorityFilter').value;
            
            // Filter current reports based on type and priority
            let filteredReports = currentReports;
            
            if (typeFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.type === typeFilter);
            }
            
            if (priorityFilter !== 'all') {
                filteredReports = filteredReports.filter(report => report.priority === parseInt(priorityFilter));
            }
            
            // Update map display with filtered reports
            updateMapDisplay(filteredReports);
        }

        // Filter by priority
        function filterByPriority() {
            filterEmergencyTypes(); // Same function handles both filters
        }

        // Start navigation to emergency location
        async function startNavigation() {
            if (!currentAssignment) {
                emergencySystem.showError('No active assignment to navigate to');
                return;
            }
            
            try {
                // Show navigation status
                document.getElementById('navigationStatus').classList.remove('hidden');
                
                // Get emergency coordinates
                const coordinates = getCoordinatesForLocation(currentAssignment.location);
                if (!coordinates) {
                    emergencySystem.showError('Could not determine emergency location');
                    return;
                }
                
                // Update responder status to "en route"
                await updateResponderStatus('busy');
                
                // Center map on emergency location
                map.setView(coordinates, 15);
                
                // Add route if we have responder location
                if (responderLocation) {
                    await calculateRoute(responderLocation, coordinates);
                }
                
                emergencySystem.showSuccess(`Navigation started to ${currentAssignment.type} emergency`);
                
                // Hide navigation status after 3 seconds
                setTimeout(() => {
                    document.getElementById('navigationStatus').classList.add('hidden');
                }, 3000);
                
            } catch (error) {
                console.error('Failed to start navigation:', error);
                emergencySystem.showError('Failed to start navigation');
                document.getElementById('navigationStatus').classList.add('hidden');
            }
        }

        // Calculate route between two points with real navigation
        async function calculateRoute(from, to) {
            try {
                // Show navigation status
                document.getElementById('navigationStatus').classList.remove('hidden');
                document.getElementById('navigationStatus').innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                        <span class="text-sm font-medium">Calculating route...</span>
                    </div>
                `;
                
                // Use enhanced fallback routing to avoid CORS issues
                console.log('Using enhanced fallback routing to avoid CORS issues...');
                
                // Create enhanced route with realistic waypoints
                const enhancedRoute = createEnhancedRoute(from, to);
                
                // Create route data structure
                const data = {
                    features: [{
                        geometry: {
                            coordinates: enhancedRoute.map(coord => [coord[1], coord[0]]) // Convert to [lng, lat]
                        },
                        properties: {
                            summary: {
                                distance: calculateDistance(from, to),
                                duration: calculateDistance(from, to) / 1000 * 60 // Rough estimate: 1 minute per km
                            },
                            segments: [{
                                steps: createNavigationSteps(enhancedRoute)
                            }]
                        }
                    }]
                };
                
                if (data.features && data.features.length > 0) {
                    const route = data.features[0];
                    const coordinates = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                    
                    // Create route polyline
                    const routePolyline = L.polyline(coordinates, {
                        color: '#ef4444',
                        weight: 6,
                        opacity: 0.8,
                        dashArray: '10, 10'
                    }).addTo(map);
                    
                    navigationRoute = routePolyline;
                    
                    // Calculate route statistics
                    const distance = route.properties.summary.distance / 1000; // Convert to km
                    const duration = route.properties.summary.duration / 60; // Convert to minutes
                    
                    // Add route markers with navigation info
                    const startMarker = L.marker(from, {
                        icon: L.divIcon({
                            html: '<div class="bg-blue-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold">START</div>',
                            className: 'custom-div-icon',
                            iconSize: [40, 40]
                        })
                    }).addTo(map);
                    
                    const endMarker = L.marker(to, {
                        icon: L.divIcon({
                            html: '<div class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold">END</div>',
                            className: 'custom-div-icon',
                            iconSize: [40, 40]
                        })
                    }).addTo(map);
                    
                    // Add navigation instructions
                    const instructions = route.properties.segments[0].steps.map((step, index) => {
                        const instruction = step.instruction.replace(/<[^>]*>/g, ''); // Remove HTML tags
                        const distance = (step.distance / 1000).toFixed(1);
                        return `${index + 1}. ${instruction} (${distance} km)`;
                    }).join('\n');
                    
                    // Create navigation popup
                    const navigationPopup = L.popup({
                        maxWidth: 300,
                        className: 'navigation-popup'
                    }).setContent(`
                        <div class="p-4">
                            <h3 class="font-bold text-lg mb-2">üß≠ Navigation Route</h3>
                            <div class="mb-3">
                                <div class="text-sm"><strong>Distance:</strong> ${distance.toFixed(1)} km</div>
                                <div class="text-sm"><strong>Duration:</strong> ${Math.round(duration)} minutes</div>
                            </div>
                            <div class="mb-3">
                                <h4 class="font-semibold mb-1">Turn-by-Turn Directions:</h4>
                                <div class="text-xs max-h-32 overflow-y-auto bg-gray-50 p-2 rounded">
                                    ${instructions}
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="startTurnByTurnNavigation()" class="btn btn-sm" style="background: #10b981; color: white;">
                                    üöó Start Navigation
                                </button>
                                <button onclick="clearNavigation()" class="btn btn-sm" style="background: #6b7280; color: white;">
                                    ‚ùå Clear Route
                                </button>
                            </div>
                        </div>
                    `);
                    
                    endMarker.bindPopup(navigationPopup).openPopup();
                    
                    // Store navigation data for turn-by-turn
                    window.navigationData = {
                        coordinates: coordinates,
                        instructions: route.properties.segments[0].steps,
                        distance: distance,
                        duration: duration,
                        currentStep: 0
                    };
                    
                    // Fit map to show entire route
                    const routeBounds = L.latLngBounds(coordinates);
                    map.fitBounds(routeBounds, { padding: [20, 20] });
                    
                    emergencySystem.showSuccess(`Route calculated: ${distance.toFixed(1)} km, ${Math.round(duration)} minutes`);
                    
                } else {
                    throw new Error('No route found');
                }
                
            } catch (error) {
                console.error('Failed to calculate route:', error);
                emergencySystem.showError('Using simplified route navigation.');
                
                // Create a more realistic fallback route with waypoints
                const fallbackRoute = createFallbackRoute(from, to);
                const route = L.polyline(fallbackRoute, {
                    color: '#ef4444',
                    weight: 4,
                    opacity: 0.8,
                    dashArray: '5, 5'
                }).addTo(map);
                
                navigationRoute = route;
                
                // Create basic navigation data for fallback
                window.navigationData = {
                    coordinates: fallbackRoute,
                    instructions: [
                        { instruction: 'Start navigation to emergency location', distance: 0 },
                        { instruction: 'Follow the route to your destination', distance: calculateDistance(from, to) },
                        { instruction: 'You have arrived at the emergency location', distance: 0 }
                    ],
                    distance: calculateDistance(from, to) / 1000,
                    duration: (calculateDistance(from, to) / 1000) * 2, // Rough estimate: 2 minutes per km
                    currentStep: 0
                };
                
                // Show fallback navigation popup
                const endMarker = L.marker(to, {
                    icon: L.divIcon({
                        html: '<div class="bg-red-500 text-white rounded-full w-10 h-10 flex items-center justify-center text-sm font-bold">END</div>',
                        className: 'custom-div-icon',
                        iconSize: [40, 40]
                    })
                }).addTo(map);
                
                const navigationPopup = L.popup({
                    maxWidth: 300,
                    className: 'navigation-popup'
                }).setContent(`
                    <div class="p-4">
                        <h3 class="font-bold text-lg mb-2">üß≠ Simplified Route</h3>
                        <div class="mb-3">
                            <div class="text-sm"><strong>Distance:</strong> ${(calculateDistance(from, to) / 1000).toFixed(1)} km</div>
                            <div class="text-sm"><strong>Duration:</strong> ~${Math.round((calculateDistance(from, to) / 1000) * 2)} minutes</div>
                        </div>
                        <div class="mb-3">
                            <div class="text-xs text-gray-600">Using simplified routing. For detailed turn-by-turn directions, ensure routing services are available.</div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="startTurnByTurnNavigation()" class="btn btn-sm" style="background: #10b981; color: white;">
                                üöó Start Navigation
                            </button>
                            <button onclick="clearNavigation()" class="btn btn-sm" style="background: #6b7280; color: white;">
                                ‚ùå Clear Route
                            </button>
                        </div>
                    </div>
                `);
                
                endMarker.bindPopup(navigationPopup).openPopup();
                
            } finally {
                // Hide navigation status
                setTimeout(() => {
                    document.getElementById('navigationStatus').classList.add('hidden');
                }, 2000);
            }
        }

        // Center map on responder location
        function centerOnResponder() {
            if (responderLocation) {
                map.setView(responderLocation, 15);
                emergencySystem.showInfo('Centered on your location');
            } else {
                emergencySystem.showError('Location not available');
            }
        }

        // Show all emergencies
        function showAllEmergencies() {
            updateMapDisplay(currentReports);
            map.fitBounds(L.latLngBounds(
                currentReports.map(report => {
                    const coords = getCoordinatesForLocation(report.location);
                    return coords || [14.5995, 120.9842];
                })
            ), { padding: [20, 20] });
            emergencySystem.showInfo('Showing all emergency locations');
        }

        // Toggle traffic layer
        function toggleTrafficLayer() {
            if (trafficLayer) {
                map.removeLayer(trafficLayer);
                trafficLayer = null;
                emergencySystem.showInfo('Traffic layer hidden');
            } else {
                // Add a simple traffic simulation (in real implementation, use actual traffic data)
                trafficLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: 'Traffic Data',
                    opacity: 0.3
                }).addTo(map);
                emergencySystem.showInfo('Traffic layer enabled');
            }
        }

        // Refresh emergency data
        async function refreshEmergencyData() {
            try {
                await loadReports();
                await updateStatusCards();
                updateCurrentAssignment();
                emergencySystem.showSuccess('Emergency data refreshed');
            } catch (error) {
                console.error('Failed to refresh data:', error);
                emergencySystem.showError('Failed to refresh data');
            }
        }

        // Update current assignment display
        function updateCurrentAssignment() {
            const assignmentElement = document.getElementById('currentAssignment');
            const navigationBtn = document.getElementById('startNavigationBtn');
            
            if (currentAssignment) {
                assignmentElement.innerHTML = `
                    <div class="font-semibold text-red-600">${currentAssignment.type.toUpperCase()}</div>
                    <div class="text-xs text-gray-500">Priority: ${currentAssignment.priority}</div>
                    <div class="text-xs text-gray-500">${formatLocation(currentAssignment.location)}</div>
                `;
                navigationBtn.classList.remove('hidden');
            } else {
                assignmentElement.innerHTML = 'No active assignment';
                navigationBtn.classList.add('hidden');
            }
        }

        // Update responder location
        function updateResponderLocation() {
            if (emergencySystem.location) {
                responderLocation = [emergencySystem.location.latitude, emergencySystem.location.longitude];
                document.getElementById('responderLocation').textContent = 
                    `${emergencySystem.location.latitude.toFixed(4)}, ${emergencySystem.location.longitude.toFixed(4)}`;
            } else {
                document.getElementById('responderLocation').textContent = 'Location not available';
            }
        }

        // Enhanced map display with responder features
        function updateMapDisplayWithResponderFeatures(reports) {
            if (!map) {
                initializeMap();
            }
            
            // Store reports for marker updates
            currentReports = reports;
            
            // Clear existing markers and routes
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            
            if (navigationRoute) {
                map.removeLayer(navigationRoute);
                navigationRoute = null;
            }
            
            if (reports.length === 0) {
                // Show message on map
                const noDataDiv = L.divIcon({
                    html: `
                        <div class="text-center p-4 bg-white rounded-lg shadow-lg">
                            <div class="text-4xl mb-2">üó∫Ô∏è</div>
                            <div class="font-semibold text-gray-800">No emergency locations</div>
                            <div class="text-sm text-gray-600">Reports will appear here when available</div>
                        </div>
                    `,
                    className: 'custom-div-icon',
                    iconSize: [200, 100]
                });
                
                const noDataMarker = L.marker([14.5995, 120.9842], { icon: noDataDiv }).addTo(map);
                markers.push(noDataMarker);
                return;
            }

            // Add markers for each emergency location
            const bounds = L.latLngBounds();
            
            reports.forEach(report => {
                const coordinates = getCoordinatesForLocation(report.location);
                
                if (coordinates) {
                    const icon = getEmergencyIcon(report.type);
                    const statusColor = getStatusColor(report.status);
                    
                    // Enhanced marker with responder actions
                    const customIcon = L.divIcon({
                        html: `
                            <div class="bg-white rounded-full shadow-2xl border-4 border-${statusColor} transform hover:scale-125 transition-all duration-300 cursor-pointer" 
                                 style="width: 80px; height: 80px; display: flex; align-items: center; justify-content: center;"
                                 onclick="selectEmergencyForResponse('${report.id}')">
                                <div class="text-4xl drop-shadow-lg">${icon}</div>
                            </div>
                        `,
                        className: 'custom-div-icon',
                        iconSize: [80, 80],
                        iconAnchor: [40, 40],
                        popupAnchor: [0, -40]
                    });
                    
                    const marker = L.marker(coordinates, { icon: customIcon }).addTo(map);
                    
                    // Enhanced popup with responder actions
                    marker.bindPopup(`
                        <div class="p-3 min-w-64">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <div class="font-semibold text-lg">${report.type.toUpperCase()}</div>
                                    <div class="text-sm text-gray-600">Priority: ${report.priority || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="text-sm text-gray-700 mb-3">
                                <div><strong>Status:</strong> ${report.status}</div>
                                <div><strong>Reporter:</strong> ${report.reporter_name || 'Anonymous'}</div>
                                <div><strong>Location:</strong> ${formatLocation(report.location)}</div>
                                <div><strong>Reported:</strong> ${new Date(report.created_at).toLocaleString()}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="acceptEmergencyAssignment('${report.id}')" 
                                        class="btn btn-sm" style="background: #10b981; color: white;">
                                    ‚úÖ Accept
                                </button>
                                <button onclick="navigateToEmergency('${report.id}')" 
                                        class="btn btn-sm" style="background: #3b82f6; color: white;">
                                    üß≠ Navigate
                                </button>
                            </div>
                        </div>
                    `);
                    
                    markers.push(marker);
                    bounds.extend(coordinates);
                }
            });
            
            // Fit map to show all markers
            if (bounds.isValid()) {
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Accept emergency assignment
        async function acceptEmergencyAssignment(reportId) {
            try {
                const report = currentReports.find(r => r.id === reportId);
                if (!report) {
                    emergencySystem.showError('Report not found');
                    return;
                }
                
                currentAssignment = report;
                await emergencySystem.updateReportStatus(reportId, 'assigned', 'Assignment accepted by responder');
                
                updateCurrentAssignment();
                emergencySystem.showSuccess(`Accepted ${report.type} emergency assignment`);
                
            } catch (error) {
                console.error('Failed to accept assignment:', error);
                emergencySystem.showError('Failed to accept assignment');
            }
        }

        // Navigate to emergency
        async function navigateToEmergency(reportId) {
            try {
                const report = currentReports.find(r => r.id === reportId);
                if (!report) {
                    emergencySystem.showError('Report not found');
                    return;
                }
                
                currentAssignment = report;
                updateCurrentAssignment();
                await startNavigation();
                
            } catch (error) {
                console.error('Failed to navigate to emergency:', error);
                emergencySystem.showError('Failed to navigate to emergency');
            }
        }

        // Select emergency for response
        function selectEmergencyForResponse(reportId) {
            const report = currentReports.find(r => r.id === reportId);
            if (report) {
                // Show emergency details and allow responder to accept
                emergencySystem.showInfo(`Selected ${report.type} emergency for response`);
            }
        }

        // Start turn-by-turn navigation
        function startTurnByTurnNavigation() {
            if (!window.navigationData) {
                emergencySystem.showError('No navigation data available');
                return;
            }
            
            // Create navigation panel
            createNavigationPanel();
            
            // Start navigation guidance
            showNextInstruction();
            
            emergencySystem.showSuccess('Turn-by-turn navigation started!');
        }

        // Create navigation panel
        function createNavigationPanel() {
            // Remove existing navigation panel
            const existingPanel = document.getElementById('navigationPanel');
            if (existingPanel) {
                existingPanel.remove();
            }
            
            // Create navigation panel
            const navigationPanel = document.createElement('div');
            navigationPanel.id = 'navigationPanel';
            navigationPanel.className = 'fixed top-4 right-4 bg-white rounded-lg shadow-lg p-4 z-50 max-w-sm';
            navigationPanel.innerHTML = `
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-bold text-lg">üß≠ Navigation</h3>
                    <button onclick="closeNavigationPanel()" class="text-gray-500 hover:text-gray-700">
                        ‚úï
                    </button>
                </div>
                <div id="currentInstruction" class="mb-3 p-3 bg-blue-50 rounded-lg">
                    <div class="text-sm font-medium">Current Instruction:</div>
                    <div id="instructionText" class="text-sm">Loading...</div>
                </div>
                <div class="mb-3">
                    <div class="text-xs text-gray-600">
                        <div>Distance: <span id="remainingDistance">-</span></div>
                        <div>Time: <span id="remainingTime">-</span></div>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="previousInstruction()" class="btn btn-sm" style="background: #6b7280; color: white;">
                        ‚Üê Previous
                    </button>
                    <button onclick="nextInstruction()" class="btn btn-sm" style="background: #3b82f6; color: white;">
                        Next ‚Üí
                    </button>
                </div>
                <div class="mt-3">
                    <button onclick="endNavigation()" class="btn btn-sm w-full" style="background: #ef4444; color: white;">
                        üõë End Navigation
                    </button>
                </div>
            `;
            
            document.body.appendChild(navigationPanel);
        }

        // Show next navigation instruction
        function showNextInstruction() {
            if (!window.navigationData) return;
            
            const { instructions, currentStep } = window.navigationData;
            const step = instructions[currentStep];
            
            if (step) {
                const instructionText = step.instruction.replace(/<[^>]*>/g, '');
                const distance = (step.distance / 1000).toFixed(1);
                
                document.getElementById('instructionText').textContent = instructionText;
                document.getElementById('remainingDistance').textContent = `${distance} km`;
                
                // Update map to show current step
                if (step.way_points && step.way_points.length > 0) {
                    const startIndex = step.way_points[0];
                    const endIndex = step.way_points[1] || step.way_points[0];
                    const stepCoordinates = window.navigationData.coordinates.slice(startIndex, endIndex + 1);
                    
                    if (stepCoordinates.length > 0) {
                        // Highlight current step on map
                        L.polyline(stepCoordinates, {
                            color: '#10b981',
                            weight: 8,
                            opacity: 0.9
                        }).addTo(map);
                        
                        // Center map on current step
                        const stepBounds = L.latLngBounds(stepCoordinates);
                        map.fitBounds(stepBounds, { padding: [50, 50] });
                    }
                }
                
                // Show instruction in browser notification
                if (Notification.permission === 'granted') {
                    new Notification('Navigation Instruction', {
                        body: instructionText,
                        icon: '/favicon.ico'
                    });
                }
            }
        }

        // Next instruction
        function nextInstruction() {
            if (!window.navigationData) return;
            
            window.navigationData.currentStep++;
            if (window.navigationData.currentStep >= window.navigationData.instructions.length) {
                emergencySystem.showSuccess('You have arrived at your destination!');
                endNavigation();
                return;
            }
            
            showNextInstruction();
        }

        // Previous instruction
        function previousInstruction() {
            if (!window.navigationData || window.navigationData.currentStep <= 0) return;
            
            window.navigationData.currentStep--;
            showNextInstruction();
        }

        // End navigation
        function endNavigation() {
            // Clear navigation data
            window.navigationData = null;
            
            // Remove navigation panel
            const navigationPanel = document.getElementById('navigationPanel');
            if (navigationPanel) {
                navigationPanel.remove();
            }
            
            // Clear route from map
            if (navigationRoute) {
                map.removeLayer(navigationRoute);
                navigationRoute = null;
            }
            
            emergencySystem.showSuccess('Navigation ended');
        }

        // Close navigation panel
        function closeNavigationPanel() {
            const navigationPanel = document.getElementById('navigationPanel');
            if (navigationPanel) {
                navigationPanel.remove();
            }
        }

        // Clear navigation
        function clearNavigation() {
            if (navigationRoute) {
                map.removeLayer(navigationRoute);
                navigationRoute = null;
            }
            
            window.navigationData = null;
            
            const navigationPanel = document.getElementById('navigationPanel');
            if (navigationPanel) {
                navigationPanel.remove();
            }
            
            emergencySystem.showInfo('Navigation cleared');
        }

        // Create enhanced route with realistic waypoints
        function createEnhancedRoute(from, to) {
            const lat1 = from[0];
            const lon1 = from[1];
            const lat2 = to[0];
            const lon2 = to[1];
            
            // Calculate distance to determine number of waypoints
            const distance = calculateDistance(from, to);
            const numPoints = Math.max(3, Math.min(10, Math.floor(distance / 1000))); // 1 point per km, min 3, max 10
            
            const waypoints = [];
            
            for (let i = 1; i < numPoints; i++) {
                const ratio = i / numPoints;
                const lat = lat1 + (lat2 - lat1) * ratio;
                const lon = lon1 + (lon2 - lon1) * ratio;
                
                // Add realistic road-like variations
                const variation = Math.min(0.005, distance / 100000); // Scale variation with distance
                const latVariation = (Math.random() - 0.5) * variation;
                const lonVariation = (Math.random() - 0.5) * variation;
                
                // Add some curve to make it look more like a real road
                const curveFactor = Math.sin(ratio * Math.PI) * 0.002;
                const latCurve = (Math.random() - 0.5) * curveFactor;
                const lonCurve = (Math.random() - 0.5) * curveFactor;
                
                waypoints.push([
                    lat + latVariation + latCurve, 
                    lon + lonVariation + lonCurve
                ]);
            }
            
            return [from, ...waypoints, to];
        }

        // Create navigation steps for the route
        function createNavigationSteps(route) {
            const steps = [];
            const totalDistance = calculateDistance(route[0], route[route.length - 1]);
            
            // Start instruction
            steps.push({
                instruction: 'Start navigation to emergency location',
                distance: 0,
                way_points: [0, 0]
            });
            
            // Intermediate steps
            for (let i = 1; i < route.length - 1; i++) {
                const segmentDistance = calculateDistance(route[i-1], route[i]);
                const instruction = getRouteInstruction(route[i-1], route[i], route[i+1]);
                
                steps.push({
                    instruction: instruction,
                    distance: segmentDistance,
                    way_points: [i-1, i]
                });
            }
            
            // End instruction
            steps.push({
                instruction: 'You have arrived at the emergency location',
                distance: 0,
                way_points: [route.length - 1, route.length - 1]
            });
            
            return steps;
        }

        // Get route instruction based on direction changes
        function getRouteInstruction(prev, current, next) {
            if (!next) return 'Continue to destination';
            
            const bearing1 = calculateBearing(prev, current);
            const bearing2 = calculateBearing(current, next);
            const angleDiff = bearing2 - bearing1;
            
            if (Math.abs(angleDiff) < 30) {
                return 'Continue straight ahead';
            } else if (angleDiff > 30 && angleDiff < 150) {
                return 'Turn right and continue';
            } else if (angleDiff < -30 && angleDiff > -150) {
                return 'Turn left and continue';
            } else if (angleDiff > 150 || angleDiff < -150) {
                return 'Make a U-turn and continue';
            } else {
                return 'Continue following the route';
            }
        }

        // Calculate bearing between two points
        function calculateBearing(point1, point2) {
            const lat1 = point1[0] * Math.PI / 180;
            const lat2 = point2[0] * Math.PI / 180;
            const deltaLon = (point2[1] - point1[1]) * Math.PI / 180;
            
            const y = Math.sin(deltaLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(deltaLon);
            
            return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
        }

        // Create fallback route with waypoints (legacy function)
        function createFallbackRoute(from, to) {
            return createEnhancedRoute(from, to);
        }

        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            const R = 6371e3; // Earth's radius in meters
            const œÜ1 = point1[0] * Math.PI / 180;
            const œÜ2 = point2[0] * Math.PI / 180;
            const ŒîœÜ = (point2[0] - point1[0]) * Math.PI / 180;
            const ŒîŒª = (point2[1] - point1[1]) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
                    Math.cos(œÜ1) * Math.cos(œÜ2) *
                    Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

            return R * c; // Distance in meters
        }

        // Utility functions
        function getEmergencyIcon(type) {
            const icons = {
                fire: 'üî•',
                medical: 'üè•',
                accident: 'üöó',
                flood: 'üåä',
                earthquake: 'üåç',
                storm: '‚õàÔ∏è',
                other: '‚ö†Ô∏è'
            };
            return icons[type] || '‚ö†Ô∏è';
        }

        // Format location for display
        function formatLocation(location) {
            if (!location) return 'Unknown Location';
            
            // Handle new JSON format with latitude/longitude
            if (typeof location === 'string' && location.startsWith('{')) {
                try {
                    const locationData = JSON.parse(location);
                    if (locationData.address && locationData.address !== 'Location detected') {
                        return locationData.address;
                    } else if (locationData.latitude && locationData.longitude) {
                        return `${locationData.latitude.toFixed(6)}, ${locationData.longitude.toFixed(6)}`;
                    }
                } catch (e) {
                    console.warn('Failed to parse location JSON:', e);
                }
            }
            
            // Handle old string format
            return location || 'Unknown Location';
        }

        function getPriorityColor(priority) {
            // Handle numeric priority (1-5)
            if (typeof priority === 'number') {
                if (priority <= 1) return 'red-600';      // Critical
                if (priority <= 2) return 'orange-600';   // High
                if (priority <= 3) return 'yellow-600';   // Medium
                if (priority <= 4) return 'blue-600';    // Low
                return 'green-600';                       // Info
            }
            
            // Handle string priority (fallback)
            const colors = {
                high: 'red-600',
                medium: 'yellow-600',
                low: 'green-600'
            };
            return colors[priority] || 'yellow-600';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (notificationChannel) {
                notificationChannel.unsubscribe();
            }
        });
    </script>
</body>
</html>
