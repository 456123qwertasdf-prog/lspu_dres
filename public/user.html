<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Report - LSPU Emergency Response</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="flex items-center justify-between">
                <a href="login.html" class="navbar-brand">üö® LSPU Emergency Response</a>
                <div class="navbar-nav">
                    <a href="user.html" class="nav-link active">Report Emergency</a>
                    <div data-auth="required" class="hidden">
                        <span data-user-info="email" class="text-sm text-gray-600"></span>
                        <button onclick="emergencySystem.signOut()" class="btn btn-outline btn-sm">Sign Out</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Alerts Container -->
    <div class="alerts-container"></div>

    <!-- Main Content -->
    <main class="container" style="margin-top: 2rem;">
        <!-- Hero Section -->
        <section class="text-center mb-8">
            <h1 class="mb-4">üö® Report Emergency</h1>
            <p class="text-lg text-gray-600 mb-8">
                Take a photo or upload an image to report an emergency. Your location will be automatically detected.
            </p>
        </section>

        <!-- Emergency Report Form -->
        <section class="card mb-8">
            <div class="card-header">
                <h2 class="card-title">Emergency Report</h2>
                <p class="card-subtitle">Quick and easy emergency reporting with AI analysis</p>
            </div>

            <form id="emergencyForm" class="space-y-6">
                <!-- Photo Upload Section -->
                <div class="form-group">
                    <label class="form-label">üì∑ Emergency Photo (Required)</label>
                    <div class="file-upload">
                        <input type="file" id="emergencyPhoto" class="file-upload-input" accept="image/*" capture="environment" required>
                        <label for="emergencyPhoto" class="file-upload-label">
                            <div class="file-upload-icon">üì∑</div>
                            <div class="file-upload-text">Take Photo or Upload Image</div>
                            <div class="file-upload-hint">Click to capture or select an image</div>
                        </label>
                    </div>
                    <div id="photoPreview" class="hidden mt-4">
                        <img id="previewImage" src="" alt="Preview" class="rounded-lg shadow" style="max-width: 300px; max-height: 200px;">
                    </div>
                </div>

                <!-- Optional Message -->
                <div class="form-group">
                    <label class="form-label">üí¨ Additional Details (Optional)</label>
                    <textarea id="description" class="form-input form-textarea" placeholder="Describe the emergency situation in detail (optional)..." rows="3"></textarea>
                </div>

                <!-- Location Section -->
                <div class="form-group">
                    <label class="form-label">üìç Location</label>
                    <div class="flex gap-4">
                        <input type="text" id="location" class="form-input" placeholder="Location will be auto-detected..." readonly>
                        <button type="button" id="getLocationBtn" class="btn btn-secondary">üìç Get Location</button>
                    </div>
                    <div id="locationStatus" class="text-sm text-gray-600 mt-2"></div>
                </div>

                <!-- Contact Information -->
                <!-- User info will be auto-filled from login -->
                <div class="hidden">
                    <input type="text" id="reporterName" value="">
                    <input type="tel" id="contactNumber" value="">
                </div>

                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <span id="submitText">üö® Submit Emergency Report</span>
                        <span id="submitLoading" class="hidden">
                            <div class="loading"></div>
                            Processing...
                        </span>
                    </button>
                </div>
            </form>
        </section>

        <!-- Recent Reports -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">Your Recent Reports</h2>
                <p class="card-subtitle">Track your submitted emergency reports</p>
            </div>
            <div id="reportsList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">
                    <div class="text-4xl mb-4">üìã</div>
                    <p>No reports submitted yet</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 border-t mt-16">
        <div class="container py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <h3 class="font-semibold mb-4">Emergency Response</h3>
                    <p class="text-sm text-gray-600">AI-powered emergency reporting and response management system.</p>
                </div>
                <div>
                    <h3 class="font-semibold mb-4">Quick Links</h3>
                    <div class="space-y-2">
                        <a href="user.html" class="block text-sm text-gray-600 hover:text-gray-800">Report Emergency</a>
                        <a href="login.html" class="block text-sm text-gray-600 hover:text-gray-800">Switch Role</a>
                    </div>
                </div>
                <div>
                    <h3 class="font-semibold mb-4">Contact</h3>
                    <p class="text-sm text-gray-600">LSPU Emergency Response System</p>
                    <p class="text-sm text-gray-600">For emergencies, call 911</p>
                </div>
            </div>
            <div class="border-t mt-8 pt-4 text-center text-sm text-gray-500">
                <p>&copy; 2024 LSPU Emergency Response System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script>
        // Form handling
        document.getElementById('emergencyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await submitEmergencyReport();
        });

        // Photo preview
        document.getElementById('emergencyPhoto').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        });

        // Location button
        document.getElementById('getLocationBtn').addEventListener('click', async () => {
            try {
                const position = await emergencySystem.getCurrentPosition();
                const address = await emergencySystem.getAddressFromCoordinates(
                    position.coords.latitude, 
                    position.coords.longitude
                );
                
                document.getElementById('location').value = address;
                document.getElementById('locationStatus').textContent = '‚úÖ Location detected';
                document.getElementById('locationStatus').className = 'text-sm text-green-600 mt-2';
            } catch (error) {
                document.getElementById('locationStatus').textContent = '‚ùå Location access denied';
                document.getElementById('locationStatus').className = 'text-sm text-red-600 mt-2';
            }
        });

        // Submit emergency report
        async function submitEmergencyReport() {
            const submitBtn = document.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                submitLoading.classList.remove('hidden');

                // Get form data
                const formData = {
                    type: 'other', // Will be determined by AI
                    message: document.getElementById('description').value || 'Emergency reported via photo',
                    reporter_name: document.getElementById('reporterName').value,
                    location: document.getElementById('location').value
                };

                // Upload image if provided
                const photoInput = document.getElementById('emergencyPhoto');
                if (photoInput.files[0]) {
                    formData.image_path = await emergencySystem.uploadImage(photoInput.files[0]);
                } else {
                    throw new Error('Please take a photo or upload an image');
                }

                // Submit report
                const report = await emergencySystem.submitEmergencyReport(formData);
                
                // Reset form
                document.getElementById('emergencyForm').reset();
                document.getElementById('photoPreview').classList.add('hidden');
                document.getElementById('locationStatus').textContent = '';
                
                // Refresh reports list
                await loadRecentReports();
                
                emergencySystem.showSuccess('Emergency report submitted successfully! AI analysis in progress...');
                
            } catch (error) {
                console.error('Submit failed:', error);
                emergencySystem.showError('Failed to submit report: ' + error.message);
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
            }
        }

        // Load recent reports
        async function loadRecentReports() {
            try {
                const reports = await emergencySystem.getReports({ user_id: emergencySystem.user?.id });
                const reportsList = document.getElementById('reportsList');
                
                if (reports.length === 0) {
                    reportsList.innerHTML = `
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-4">üìã</div>
                            <p>No reports submitted yet</p>
                        </div>
                    `;
                    return;
                }

                reportsList.innerHTML = reports.map(report => `
                    <div class="card">
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-4 mb-2">
                                    <h4 class="font-semibold">${getEmergencyIcon(report.type)} ${report.type.toUpperCase()} Emergency</h4>
                                    <span class="badge badge-${report.status}">${report.status}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-2">${report.description}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span>üìç ${report.location || 'Location not specified'}</span>
                                    <span>üïí ${new Date(report.created_at).toLocaleString()}</span>
                                </div>
                                ${report.confidence ? `
                                    <div class="mt-2">
                                        <span class="text-sm text-blue-600">ü§ñ AI Confidence: ${Math.round(report.confidence * 100)}%</span>
                                    </div>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-gray-500">Priority</div>
                                <div class="font-semibold text-${getPriorityColor(report.priority)}">${report.priority?.toUpperCase() || 'MEDIUM'}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load reports:', error);
            }
        }

        // Utility functions
        function getEmergencyIcon(type) {
            const icons = {
                fire: 'üî•',
                medical: 'üè•',
                accident: 'üöó',
                flood: 'üåä',
                earthquake: 'üåç',
                storm: '‚õàÔ∏è',
                other: '‚ö†Ô∏è'
            };
            return icons[type] || '‚ö†Ô∏è';
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'red-600',
                medium: 'yellow-600',
                low: 'green-600'
            };
            return colors[priority] || 'yellow-600';
        }

        // Check user role and redirect if necessary
        function checkUserRole() {
            if (!emergencySystem.user) {
                window.location.href = 'login.html';
                return false;
            }
            
            const userRole = emergencySystem.user?.user_metadata?.role || 'citizen';
            
            if (userRole !== 'citizen') {
                // Redirect to appropriate dashboard
                if (userRole === 'responder') {
                    window.location.href = 'responder.html';
                } else if (userRole === 'admin') {
                    window.location.href = 'admin.html';
                }
                return false;
            }
            
            return true;
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for system initialization
            await new Promise(resolve => {
                const checkInit = () => {
                    if (emergencySystem.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });

            // Check user role
            if (!checkUserRole()) {
                return;
            }

            // Load recent reports if user is authenticated
            if (emergencySystem.user) {
                await loadRecentReports();
                
                // Auto-fill user information from login
                const user = emergencySystem.user;
                const userMetadata = user.user_metadata || {};
                
                // Set user name and contact from user data
                document.getElementById('reporterName').value = userMetadata.full_name || user.email || 'User';
                document.getElementById('contactNumber').value = userMetadata.phone || '';
                
                console.log('‚úÖ User info auto-filled:', {
                    name: userMetadata.full_name || user.email,
                    email: user.email,
                    role: userMetadata.role
                });
            }

            // Try to get location automatically
            try {
                const position = await emergencySystem.getCurrentPosition();
                const address = await emergencySystem.getAddressFromCoordinates(
                    position.coords.latitude, 
                    position.coords.longitude
                );
                
                document.getElementById('location').value = address;
                document.getElementById('locationStatus').textContent = '‚úÖ Location auto-detected';
                document.getElementById('locationStatus').className = 'text-sm text-green-600 mt-2';
            } catch (error) {
                console.log('Auto-location failed:', error);
                document.getElementById('locationStatus').textContent = 'üìç Click "Get Location" to detect your location';
                document.getElementById('locationStatus').className = 'text-sm text-gray-600 mt-2';
            }
        });
    </script>
</body>
</html>
