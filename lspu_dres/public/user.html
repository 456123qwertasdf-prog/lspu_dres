<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Report - LSPU Emergency Response</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Notification Toast Animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        .announcement-card {
            border-left: 4px solid;
            border-radius: 8px;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }
        .announcement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .announcement-card.border-l-red-500 {
            border-left-color: #dc2626;
            background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);
        }
        .announcement-card.border-l-orange-500 {
            border-left-color: #f59e0b;
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
        }
        .announcement-card.border-l-blue-500 {
            border-left-color: #3b82f6;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
        }
        .announcement-card.border-l-green-500 {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
        }
        .announcement-card.border-l-gray-500 {
            border-left-color: #6b7280;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
        }

        /* Weather Card Styles - matching admin dashboard */
        .weather-today-card {
            padding: 1.25rem 1.5rem 1.5rem 1.5rem;
        }
        
        .weather-main {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: stretch;
        }
        
        .weather-main-left {
            flex: 1.1;
            min-width: 260px;
        }
        
        .weather-main-right {
            flex: 1;
            min-width: 260px;
        }
        
        .weather-location {
            font-size: 0.95rem;
            font-weight: 600;
            color: #0f172a;
        }
        
        .weather-asof {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.15rem;
        }
        
        .weather-temp-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .weather-temp {
            font-size: 3.5rem;
            font-weight: 700;
            color: #0f172a;
            line-height: 1;
        }
        
        .weather-condition {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .weather-description {
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            text-transform: capitalize;
        }
        
        .weather-range {
            font-size: 0.8rem;
            color: #6b7280;
        }
        
        .weather-meta-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 0.75rem 1.25rem;
        }
        
        .weather-meta-item {
            padding: 0.55rem 0.75rem;
            border-radius: 10px;
            background: linear-gradient(135deg, #f9fafb 0%, #eef2ff 100%);
            border: 1px solid rgba(209, 213, 219, 0.8);
        }
        
        .weather-meta-header {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-bottom: 0.25rem;
        }
        
        .meta-label {
            font-size: 0.7rem;
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #6b7280;
        }
        
        .meta-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #111827;
        }
        
        .meta-subvalue {
            font-size: 0.7rem;
            color: #6b7280;
            display: block;
            margin-top: 0.1rem;
        }
        
        .hourly-strip {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.25rem;
            padding-top: 1.25rem;
            border-top: 1px solid #e5e7eb;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .hourly-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            padding: 0.65rem 0.85rem;
            border-radius: 10px;
            background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);
            border: 1px solid rgba(209, 213, 219, 0.6);
            min-width: 70px;
            transition: all 0.3s ease;
        }
        
        .hourly-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .hourly-time {
            font-size: 0.7rem;
            font-weight: 600;
            color: #6b7280;
        }
        
        .hourly-icon {
            font-size: 1.5rem;
        }
        
        .hourly-temp {
            font-size: 0.85rem;
            font-weight: 700;
            color: #111827;
        }
        
        .hourly-rain {
            font-size: 0.65rem;
            color: #3b82f6;
            font-weight: 600;
        }

        /* Weather icon colors */
        .weather-icon-sun {
            color: #fbbf24; /* warm yellow */
        }

        .weather-icon-cloud {
            color: #9ca3af; /* soft gray */
        }

        .weather-icon-rain {
            color: #3b82f6; /* soft blue */
        }

        .weather-icon-thunder {
            color: #6366f1; /* indigo */
        }

        .weather-icon-snow {
            color: #93c5fd; /* light blue */
        }

        .weather-icon-fog {
            color: #6b7280; /* muted gray */
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="flex items-center justify-between">
                <div class="navbar-brand-container">
                    <img src="images/udrrmo-logo.jpg" alt="UDRRMO Logo" class="navbar-logo">
                    <a href="user.html" class="navbar-brand">Kapiyu Emergency</a>
                </div>
                <div class="navbar-nav">
                    <div data-auth="required" class="hidden" style="display: flex; align-items: center; gap: 15px;">
                        <!-- Notification Icon -->
                        <div class="notification-container" style="position: relative;">
                            <button onclick="toggleNotifications()" class="notification-btn" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; position: relative;">
                                <i class="bi bi-bell"></i>
                                <span class="notification-badge" id="notificationBadge" style="position: absolute; top: -5px; right: -5px; background: #dc2626; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold;">0</span>
                            </button>
                        </div>
                        <!-- Profile Icon -->
                        <div class="profile-container" style="position: relative;">
                            <button onclick="toggleProfileDropdown()" class="profile-btn" style="background: rgba(255, 255, 255, 0.2); border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; color: white; font-size: 1.25rem;">
                                <i class="bi bi-person-circle"></i>
                            </button>
                            <!-- Profile Dropdown -->
                            <div id="profileDropdown" class="profile-dropdown" style="position: absolute; top: 100%; right: 0; margin-top: 8px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1000; display: none;">
                                <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                                    <div style="font-weight: 600; color: #374151; font-size: 0.9rem;" id="profileUserName">User</div>
                                    <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;" id="profileUserEmail">Email</div>
                                </div>
                                <div style="padding: 8px 0;">
                                    <button onclick="openEditProfile()" style="width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #374151; font-size: 0.9rem; transition: background 0.2s;">
                                        <i class="bi bi-pencil"></i>
                                        <span>Edit Profile</span>
                                    </button>
                                    <button onclick="handleLogout()" style="width: 100%; text-align: left; padding: 10px 16px; background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #dc2626; font-size: 0.9rem; transition: background 0.2s;">
                                        <i class="bi bi-box-arrow-right"></i>
                                        <span>Logout</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Alerts Container -->
    <div class="alerts-container"></div>


    <!-- Main Content -->
    <main class="container" style="margin-top: 2rem;">

        <!-- Hero Section -->
        <section class="text-center mb-8">
            <h1 class="mb-4"><i class="bi bi-house-fill"></i> Welcome to Kapiyu Emergency Application</h1>
            <p class="text-lg text-gray-600 mb-8">
                Your LSPU Emergency Application for emergency reporting. Stay safe and connected.
            </p>
        </section>

        <!-- Quick Actions Dashboard -->
        <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="card text-center">
                <div class="p-6">
                    <div class="text-4xl mb-4 text-purple-600">
                        <i class="bi bi-box-seam"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Modules</h3>
                    <p class="text-gray-600 mb-4">Access learning modules and educational content</p>
                    <a href="learning-modules.html" class="btn btn-primary">
                        <i class="bi bi-book"></i> View Modules
                    </a>
                </div>
            </div>

            <div class="card text-center">
                <div class="p-6">
                    <div class="text-4xl mb-4 text-blue-600">
                        <i class="bi bi-clipboard-data"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">My Reports</h3>
                    <p class="text-gray-600 mb-4">View your submitted reports and track their status</p>
                    <a href="my-reports.html" class="btn btn-secondary">
                        <i class="bi bi-eye"></i> View History
                    </a>
                </div>
            </div>

            <div class="card text-center">
                <div class="p-6">
                    <div class="text-4xl mb-4 text-green-600">
                        <i class="bi bi-shield-check"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Safety Tips</h3>
                    <p class="text-gray-600 mb-4">Learn emergency preparedness and safety guidelines</p>
                    <button onclick="showSafetyTips()" class="btn btn-primary">
                        <i class="bi bi-book"></i> Learn More
                    </button>
                </div>
            </div>
        </section>


        <!-- Weather Dashboard Section -->
        <section id="weatherSection" class="card mb-8">
            <div class="card-header">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="card-title">
                            <i class="bi bi-cloud-sun"></i> Daily Weather Outlook
                        </h2>
                        <p class="card-subtitle">Current weather conditions for LSPU Sta. Cruz Campus</p>
                        <div class="text-sm text-gray-600 mt-2">
                            Last updated: <span id="lastUpdatedUser">--</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="weatherStatus" class="flex items-center gap-1 text-sm text-gray-500">
                            <div class="w-2 h-2 bg-gray-400 rounded-full" id="weatherStatusDot"></div>
                            <span id="weatherStatusText">Loading...</span>
                        </div>
                        <button onclick="refreshWeather()" class="btn btn-outline btn-sm" id="refreshWeatherBtn">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
            <div id="weatherDashboard">
                <div class="weather-today-card">
                    <div class="weather-main">
                        <div class="weather-main-left">
                            <div class="weather-location">LSPU Sta. Cruz Campus, Laguna</div>
                            <div class="weather-asof">As of <span id="lastUpdatedShortUser">--:--</span></div>
                            <div class="weather-temp-row">
                                <div class="flex items-center">
                                    <span id="temperatureUser" class="weather-temp">--¬∞C</span>
                                </div>
                                <div class="weather-condition">
                                    <div id="weatherDescriptionUser" class="weather-description">Loading...</div>
                                    <div class="weather-range">
                                        Day <span id="dayHighUser">--¬∞</span> ‚Ä¢ Night <span id="nightLowUser">--¬∞</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="weather-main-right">
                            <div class="weather-meta-grid">
                                <div class="weather-meta-item">
                                    <div class="weather-meta-header">
                                        <span class="meta-label">Feels Like</span>
                                    </div>
                                    <span id="feelsLikeUser" class="meta-value">--¬∞C</span>
                                </div>
                                <div class="weather-meta-item">
                                    <div class="weather-meta-header">
                                        <span class="meta-label">Humidity</span>
                                    </div>
                                    <span id="humidityUser" class="meta-value">--%</span>
                                </div>
                                <div class="weather-meta-item">
                                    <div class="weather-meta-header">
                                        <span class="meta-label">Rain Chance</span>
                                    </div>
                                    <span id="rainChanceUser" class="meta-value">--%</span>
                                    <span id="rainChanceDescUser" class="meta-subvalue">Loading...</span>
                                </div>
                                <div class="weather-meta-item">
                                    <div class="weather-meta-header">
                                        <span class="meta-label">Wind</span>
                                    </div>
                                    <span id="windSpeedUser" class="meta-value">-- km/h</span>
                                    <span id="windDescUser" class="meta-subvalue">Loading...</span>
                                </div>
                                <div class="weather-meta-item">
                                    <div class="weather-meta-header">
                                        <span class="meta-label">Air Quality (AQI)</span>
                                    </div>
                                    <span id="airQualityUser" class="meta-value">--</span>
                                    <span id="airQualityDescUser" class="meta-subvalue">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="hourlyStripUser" class="hourly-strip">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </section>


        <!-- Emergency Report Form -->
        <section id="reportForm" class="card mb-8">
            <div class="card-header">
                <h2 class="card-title">Emergency Report</h2>
                <p class="card-subtitle">Quick and easy emergency reporting with AI analysis</p>
            </div>

            <form id="emergencyForm" class="space-y-6">
                <!-- Photo Upload Section -->
                <div class="form-group">
                    <label class="form-label"><i class="bi bi-camera"></i> Emergency Photo (Required)</label>
                    <div class="file-upload">
                        <input type="file" id="emergencyPhoto" class="file-upload-input" accept="image/*" capture="environment" required>
                        <label for="emergencyPhoto" class="file-upload-label">
                            <div class="file-upload-icon"><i class="bi bi-camera"></i></div>
                            <div class="file-upload-text">Take Photo or Upload Image</div>
                            <div class="file-upload-hint">Click to capture or select an image</div>
                        </label>
                    </div>
                    <div id="photoPreview" class="hidden mt-4">
                        <img id="previewImage" src="" alt="Preview" class="rounded-lg shadow" style="max-width: 300px; max-height: 200px;">
                    </div>
                </div>

                <!-- Optional Message -->
                <div class="form-group">
                    <label class="form-label"><i class="bi bi-chat-dots"></i> Additional Details (Optional)</label>
                    <textarea id="description" class="form-input form-textarea" placeholder="Describe the emergency situation in detail (optional)..." rows="3"></textarea>
                </div>

                <!-- Location Section -->
                <div class="form-group">
                    <label class="form-label"><i class="bi bi-geo-alt"></i> Location</label>
                    <div class="flex gap-4">
                        <input type="text" id="location" class="form-input" placeholder="Location will be auto-detected..." readonly>
                        <button type="button" id="getLocationBtn" class="btn btn-secondary"><i class="bi bi-geo-alt"></i> Get Location</button>
                    </div>
                    <div id="locationStatus" class="text-sm text-gray-600 mt-2"></div>
                </div>

                <!-- Contact Information -->
                <!-- User info will be auto-filled from login -->
                <div class="hidden">
                    <input type="text" id="reporterName" value="">
                    <input type="tel" id="contactNumber" value="">
                </div>


                <!-- Submit Button -->
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <span id="submitText"><i class="bi bi-exclamation-triangle-fill"></i> Submit Emergency Report</span>
                        <span id="submitLoading" class="hidden">
                            <div class="loading"></div>
                            Processing...
                        </span>
                    </button>
                    <p class="text-sm text-gray-500 mt-2">‚ö†Ô∏è This will be reviewed by admin before assigning responders</p>
                </div>
            </form>
        </section>
    </main>
    
    <!-- Safety Tips & Evacuation Guide Modal (integrated) -->
    <div id="safetyTipsModal" class="modal-overlay hidden" onclick="if(event.target === this) closeSafetyTips()">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="card-title" style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <i class="bi bi-shield-check"></i> Emergency Evacuation Guide
                </h2>
                <button class="modal-close" onclick="closeSafetyTips()" aria-label="Close">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Emergency Procedures -->
                <section class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-exclamation-triangle"></i> Emergency Procedures</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="evacuation-card" style="border-left: 4px solid #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);">
                                <div class="p-6">
                                    <h4 class="text-lg font-semibold mb-4" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-activity"></i> Earthquake Safety</h4>
                                    <div class="space-y-3">
                                        <div class="safety-instruction"><strong>DROP</strong> - Drop to the ground immediately</div>
                                        <div class="safety-instruction"><strong>COVER</strong> - Take cover under a sturdy table or desk</div>
                                        <div class="safety-instruction"><strong>HOLD ON</strong> - Hold onto the table leg until shaking stops</div>
                                        <div class="safety-instruction"><strong>EVACUATE</strong> - Follow evacuation routes to designated areas</div>
                                    </div>
                                </div>
                            </div>
                            <div class="evacuation-card" style="border-left: 4px solid #dc2626; background: linear-gradient(135deg, #fef2f2 0%, #ffffff 100%);">
                                <div class="p-6">
                                    <h4 class="text-lg font-semibold mb-4" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-fire"></i> Fire Safety</h4>
                                    <div class="space-y-3">
                                        <div class="safety-instruction"><strong>ALERT</strong> - Pull fire alarm and call emergency services</div>
                                        <div class="safety-instruction"><strong>EVACUATE</strong> - Use nearest exit, never use elevators</div>
                                        <div class="safety-instruction"><strong>ASSEMBLE</strong> - Gather at designated assembly points</div>
                                        <div class="safety-instruction"><strong>ACCOUNT</strong> - Report to safety officers for headcount</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Training Videos -->
                <section class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-camera-video"></i> Emergency Training Videos</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- First Aid Video -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-heart-pulse-fill"></i> First Aid</h4>
                                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 8px;">
                                    <iframe id="firstAidVideoUser" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                        src="https://www.youtube.com/embed/TsJ49Np3HS0" 
                                        title="First Aid Training Tutorial" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>

                            <!-- Earthquake Video -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-activity"></i> Earthquake Drill</h4>
                                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 8px;">
                                    <iframe id="earthquakeVideoUser" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                        src="https://www.youtube.com/embed/BLEPakj1YTY" 
                                        title="Earthquake Drill Tutorial" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>

                            <!-- Fire Drill Video -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-fire"></i> Fire Drill</h4>
                                <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; background: #000; border-radius: 8px;">
                                    <iframe id="fireDrillVideoUser" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                                        src="https://www.youtube.com/embed/kPWyiscBrfk" 
                                        title="Fire Drill Tutorial" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                    </iframe>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Evacuation Routes & Assembly Points -->
                <section class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-map"></i> Evacuation Routes & Assembly Points</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="evacuation-route">
                                <h4 class="text-lg font-semibold mb-3" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-geo-alt"></i> Primary Evacuation Area</h4>
                                <p class="mb-3"><strong>Location:</strong> Main Quadrangle / Open Field</p>
                                <p class="mb-3"><strong>Capacity:</strong> 2,000+ people</p>
                                <div class="space-y-2">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-check-circle text-green-600"></i><span>Open space away from buildings</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-check-circle text-green-600"></i><span>First aid station available</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-check-circle text-green-600"></i><span>Emergency supplies storage</span></div>
                                </div>
                            </div>
                            <div class="evacuation-route">
                                <h4 class="text-lg font-semibold mb-3" style="display:flex;align-items:center;gap:8px;"><i class="bi bi-geo-alt-fill"></i> Secondary Evacuation Areas</h4>
                                <div class="space-y-2">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-building"></i><span>Gymnasium (Building 15)</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-building"></i><span>Library (Building 8)</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-building"></i><span>Auditorium (Building 12)</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-building"></i><span>Parking Area (North Side)</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Emergency Contacts -->
                <section class="card mb-6">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-telephone"></i> Emergency Contacts</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="emergency-contact">
                                <h4 class="text-lg font-semibold mb-2">MDRRMO</h4>
                                <p class="text-sm text-gray-600 mb-2">Municipal Disaster Risk Reduction and Management Office</p>
                                <div class="space-y-1">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-phone"></i><span>0921-962-0602</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-telephone"></i><span>(049) 557-1047</span></div>
                                </div>
                            </div>
                            <div class="emergency-contact">
                                <h4 class="text-lg font-semibold mb-2">PDRRMO</h4>
                                <p class="text-sm text-gray-600 mb-2">Provincial Disaster Risk Reduction and Management Office</p>
                                <div class="space-y-1">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-phone"></i><span>0917 417 3698</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-telephone"></i><span>(049) 501-4672</span></div>
                                </div>
                            </div>
                            <div class="emergency-contact">
                                <h4 class="text-lg font-semibold mb-2">BFP</h4>
                                <p class="text-sm text-gray-600 mb-2">Bureau of Fire Protection</p>
                                <div class="space-y-1">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-phone"></i><span>0917 417 3698</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-telephone"></i><span>(049) 501-0004</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="emergency-contact">
                                <h4 class="text-lg font-semibold mb-2">Police Station</h4>
                                <div class="space-y-1">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-phone"></i><span>0928-465-3820</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-telephone"></i><span>501-5971</span></div>
                                </div>
                            </div>
                            <div class="emergency-contact">
                                <h4 class="text-lg font-semibold mb-2">Medical Emergency</h4>
                                <div class="space-y-1">
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-hospital"></i><span>Laguna Doctors Hospital: (049) 501-3218</span></div>
                                    <div style="display:flex;align-items:center;gap:8px;"><i class="bi bi-hospital"></i><span>Laguna Medical Center: (049) 543-333</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Safety Tips & Reminders -->
                <section class="card">
                    <div class="card-header">
                        <h3 class="card-title"><i class="bi bi-lightbulb"></i> Safety Tips & Reminders</h3>
                    </div>
                    <div class="card-body">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="text-lg font-semibold mb-3">Before an Emergency</h4>
                                <ul class="space-y-2">
                                    <li class="flex items-start gap-2"><i class="bi bi-check-circle text-green-600 mt-1"></i><span>Familiarize yourself with evacuation routes</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-check-circle text-green-600 mt-1"></i><span>Know the location of emergency exits</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-check-circle text-green-600 mt-1"></i><span>Keep emergency contact numbers handy</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-check-circle text-green-600 mt-1"></i><span>Participate in emergency drills</span></li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="text-lg font-semibold mb-3">During an Emergency</h4>
                                <ul class="space-y-2">
                                    <li class="flex items-start gap-2"><i class="bi bi-exclamation-triangle text-orange-600 mt-1"></i><span>Stay calm and follow instructions</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-exclamation-triangle text-orange-600 mt-1"></i><span>Use designated evacuation routes</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-exclamation-triangle text-orange-600 mt-1"></i><span>Help others if it's safe to do so</span></li>
                                    <li class="flex items-start gap-2"><i class="bi bi-exclamation-triangle text-orange-600 mt-1"></i><span>Report to assembly points for headcount</span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container py-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <div class="footer-brand">
                        <img src="images/udrrmo-logo.jpg" alt="UDRRMO Logo" class="footer-logo">
                        <div>
                            <h3 class="footer-title">Emergency Response</h3>
                            <p class="footer-subtitle">Emergency Reporting and Response Management System.</p>
                        </div>
                    </div>
                </div>
                <div>
                   <h3 class="footer-section-title">Quick Links</h3>
                   <div class="space-y-2">
                       <a href="https://www.facebook.com/profile.php?id=61564014370323" class="footer-link" target="_blank" rel="noopener noreferrer">Facebook Page</a>
                   </div>
               </div>
                <div>
                    <h3 class="footer-section-title">Contact</h3>
                    <p class="footer-text">Police Department - 911</p>
                    <p class="footer-text">UDRRMO - 0921-962-0602</p>
                    <p class="footer-text">Hospital - 911</p>
                    <p class="footer-text">Fire Department - 911</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 LSPU Emergency Response System. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="js/supabase.js"></script>
    <script>
        // Real-time announcements functionality
        let announcementsSubscription = null;
        let announcements = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for system initialization
            await new Promise(resolve => {
                const checkInit = () => {
                    if (typeof emergencySystem !== 'undefined' && emergencySystem.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });

            // Set up real-time subscription for notifications
            setupAnnouncementsSubscription();
        });



        // Set up real-time subscription for announcements
        function setupAnnouncementsSubscription() {
            if (announcementsSubscription) {
                announcementsSubscription.unsubscribe();
            }

            announcementsSubscription = emergencySystem.supabase
                .channel('announcements_channel')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'announcements'
                }, (payload) => {
                    console.log('Announcement change detected:', payload);
                    
                    if (payload.eventType === 'INSERT' && payload.new.status === 'active') {
                        // New announcement added - add to notifications
                        const notificationType = getAnnouncementNotificationType(payload.new.type);
                        const notificationTitle = `${getAnnouncementIcon(payload.new.type)} ${payload.new.title}`;
                        addNotification(notificationTitle, payload.new.message, notificationType, payload.new.id);
                    }
                })
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                    if (typeof updateConnectionStatus === 'function') {
                        updateConnectionStatus(status);
                    }
                    
                    if (status === 'SUBSCRIBED') {
                        console.log('‚úÖ Real-time announcements connected');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('‚ùå Real-time connection error');
                        // Retry connection after 5 seconds
                        setTimeout(() => {
                            console.log('üîÑ Retrying real-time connection...');
                            setupAnnouncementsSubscription();
                        }, 5000);
                    }
                });
        }

        // Optional: Connection status update function (can be implemented for UI feedback)
        function updateConnectionStatus(status) {
            // This function can be used to update UI elements based on connection status
            // For now, it's a no-op to prevent errors
            console.log('üì° Connection status:', status);
        }

        // Optional: Learning modules loader (modules are loaded via separate page)
        async function loadLearningModules() {
            // Learning modules are loaded separately via learning-modules.html
            // This function can be implemented if needed for dashboard display
            console.log('‚ÑπÔ∏è Learning modules available via learning-modules.html');
        }

        // Clean up subscription on page unload
        window.addEventListener('beforeunload', () => {
            if (announcementsSubscription) {
                announcementsSubscription.unsubscribe();
            }
        });

        // Navigation functionality
        function scrollToMyReports() {
            const reportsSection = document.querySelector('#reportsList');
            if (reportsSection) {
                reportsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showModules() {
            window.location.href = 'learning-modules.html';
        }

        // Dashboard functionality
        function scrollToReportForm() {
            const reportForm = document.getElementById('reportForm');
            if (reportForm) {
                reportForm.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function showSafetyTips() {
            const modal = document.getElementById('safetyTipsModal');
            if (modal) {
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        function closeSafetyTips() {
            const modal = document.getElementById('safetyTipsModal');
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = '';
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const profileContainer = document.querySelector('.profile-container');
            const dropdown = document.getElementById('profileDropdown');
            
            if (profileContainer && dropdown && !profileContainer.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });

        function openEditProfile() {
            window.location.href = 'edit-profile.html';
        }

        function handleLogout() {
            if (window.emergencySystem && window.emergencySystem.signOut) {
                window.emergencySystem.signOut();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSafetyTips();
            }
        });

    </script>
    <script>
        // Form handling
        document.getElementById('emergencyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            
            // Add additional validation to prevent accidental submissions
            const photoInput = document.getElementById('emergencyPhoto');
            if (!photoInput.files || photoInput.files.length === 0) {
                emergencySystem.showError('Please take a photo or upload an image before submitting');
                return;
            }
            
            // Check if location is available
            const locationInput = document.getElementById('location');
            if (!locationInput.value || locationInput.value.trim() === '') {
                emergencySystem.showError('Please get your location before submitting');
                return;
            }
            
            await submitEmergencyReport();
        });

        // Photo preview
        document.getElementById('emergencyPhoto').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('previewImage').src = e.target.result;
                    document.getElementById('photoPreview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
                
            }
        });

        // Location button
        document.getElementById('getLocationBtn').addEventListener('click', async () => {
            try {
                const position = await emergencySystem.getCurrentPosition();
                const address = await emergencySystem.getAddressFromCoordinates(
                    position.coords.latitude, 
                    position.coords.longitude
                );
                
                document.getElementById('location').value = address;
                document.getElementById('locationStatus').textContent = '‚úÖ Location detected';
                document.getElementById('locationStatus').className = 'text-sm text-green-600 mt-2';
                
            } catch (error) {
                document.getElementById('locationStatus').textContent = '‚ùå Location access denied';
                document.getElementById('locationStatus').className = 'text-sm text-red-600 mt-2';
            }
        });


        // Submit emergency report
        let isSubmitting = false;
        async function submitEmergencyReport() {
            // Prevent double submissions
            if (isSubmitting) {
                console.log('‚ö†Ô∏è Already submitting, please wait...');
                return;
            }
            
            // Add confirmation dialog to prevent accidental submissions
            const confirmed = confirm('Are you sure you want to submit this emergency report? This will be reviewed by admin before assigning responders.');
            if (!confirmed) {
                return;
            }
            
            isSubmitting = true;
            const submitBtn = document.querySelector('button[type="submit"]');
            const submitText = document.getElementById('submitText');
            const submitLoading = document.getElementById('submitLoading');
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitText.classList.add('hidden');
                submitLoading.classList.remove('hidden');

                // Get form data
                const formData = {
                    type: 'other', // Will be determined by AI
                    message: document.getElementById('description').value || 'Emergency reported via photo',
                    reporter_name: document.getElementById('reporterName').value,
                    location: document.getElementById('location').value
                };

                // Upload image if provided
                const photoInput = document.getElementById('emergencyPhoto');
                if (photoInput.files[0]) {
                    formData.image_path = await emergencySystem.uploadImage(photoInput.files[0]);
                } else {
                    throw new Error('Please take a photo or upload an image');
                }

                // Submit report
                const report = await emergencySystem.submitEmergencyReport(formData);
                
                // Reset form
                document.getElementById('emergencyForm').reset();
                document.getElementById('photoPreview').classList.add('hidden');
                document.getElementById('locationStatus').textContent = '';
                
                // Report submitted successfully
                
                emergencySystem.showSuccess('Emergency report submitted successfully! Admin will review and assign responders...');
                
            } catch (error) {
                console.error('Submit failed:', error);
                emergencySystem.showError('Failed to submit report: ' + error.message);
            } finally {
                // Hide loading state
                submitBtn.disabled = false;
                submitText.classList.remove('hidden');
                submitLoading.classList.add('hidden');
                isSubmitting = false;
            }
        }

        // Load weather data for users
        async function loadWeatherData() {
            try {
                console.log('üå§Ô∏è Loading weather data...');
                
                // Call the enhanced weather alert function
                const response = await fetch('https://hmolyqzbvxxliemclrld.supabase.co/functions/v1/enhanced-weather-alert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhtb2x5cXpidnh4bGllbWNscmxkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyNDY5NzAsImV4cCI6MjA3NTgyMjk3MH0.G2AOT-8zZ5sk8qGQUBifFqq5ww2W7Hxvtux0tlQ0Q-4'
                    },
                    body: JSON.stringify({
                        latitude: 14.262585,
                        longitude: 121.398436,
                        city: "LSPU Sta. Cruz Campus, Laguna, Philippines"
                    })
                });

                if (!response.ok) {
                    throw new Error(`Weather API error: ${response.status}`);
                }

                const weatherData = await response.json();
                console.log('üå§Ô∏è Weather data loaded:', weatherData);
                console.log('üå§Ô∏è Weather data structure:', JSON.stringify(weatherData, null, 2));

                displayWeatherMetrics(weatherData);
                updateWeatherStatus('SUCCESS');

            } catch (error) {
                console.error('‚ùå Failed to load weather data:', error);
                displayWeatherError();
                updateWeatherStatus('ERROR');
            }
        }

        // Display weather metrics in user-friendly format
        function displayWeatherMetrics(data) {
            // Extract weather data from the API response
            const weatherData = data.weather_data || data;
            console.log('üå§Ô∏è Extracting weather data from:', weatherData);
            console.log('üå§Ô∏è Available fields:', Object.keys(weatherData));
            
            // Extract from the correct API response structure
            const temperature = Math.round(weatherData.main?.temp || 0);
            const humidity = Math.round(weatherData.main?.humidity || 0);
            
            // Use forecast data for rainfall (next 24h max rain volume)
            const forecastSummary = weatherData.forecast_summary;
            const forecastRainfall = forecastSummary?.next_24h_forecast?.reduce((max, item) => 
                Math.max(max, item.rain_volume || 0), 0) || 0;
            const rainfall = weatherData.rain?.["1h"] || forecastRainfall;
            
            // Use the SAME rain chance calculation as admin interface
            const rainChance = forecastSummary?.next_24h_max_rain_chance ? 
                Math.round(forecastSummary.next_24h_max_rain_chance * 100) : 
                Math.round((weatherData.pop || 0) * 100);
            
            console.log('üå§Ô∏è Rain chance calculation:', {
                next_24h_max_rain_chance: forecastSummary?.next_24h_max_rain_chance,
                calculated: rainChance,
                weatherPop: weatherData.pop
            });
            
            const heatIndex = Math.round(weatherData.main?.feels_like || temperature);
            // Compute simplified AQI using same logic as admin dashboard
            const pressure = Math.round(weatherData.main?.pressure || 1013);
            const airQualityIndex = calculateSimplifiedAQI(pressure, humidity);
            const { category: airQualityCategory, description: airQualityDescription } = getAirQualityCategoryFromIndex(airQualityIndex);
            
            // Use actual API data
            const finalTemperature = temperature;
            const finalRainfall = rainfall;
            const finalHeatIndex = heatIndex;
            
            console.log('üå§Ô∏è Extracted values:', {
                temperature,
                humidity,
                rainfall,
                rainChance,
                heatIndex,
                airQualityIndex,
                airQualityCategory
            });
            
            console.log('üå§Ô∏è Final values:', {
                finalTemperature,
                finalRainfall,
                finalHeatIndex,
                rainChance,
                airQualityIndex,
                airQualityCategory
            });

            // Update "as of" time
            const now = new Date();
            const lastUpdatedEl = document.getElementById('lastUpdatedUser');
            if (lastUpdatedEl) {
                lastUpdatedEl.textContent = now.toLocaleString();
            }
            const shortEl = document.getElementById('lastUpdatedShortUser');
            if (shortEl) {
                shortEl.textContent = now.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // Update main temperature panel
            document.getElementById('temperatureUser').textContent = `${finalTemperature}¬∞C`;
            const desc = (weatherData.weather?.[0]?.description || 'Current conditions');
            const descEl = document.getElementById('weatherDescriptionUser');
            if (descEl) {
                descEl.textContent = desc.charAt(0).toUpperCase() + desc.slice(1);
            }
            document.getElementById('dayHighUser').textContent = `${Math.round(weatherData.main?.temp_max || finalTemperature)}¬∞`;
            document.getElementById('nightLowUser').textContent = `${Math.round(weatherData.main?.temp_min || finalTemperature)}¬∞`;

            // Update meta cards
            document.getElementById('feelsLikeUser').textContent = `${finalHeatIndex}¬∞C`;
            document.getElementById('humidityUser').textContent = `${humidity}%`;

            document.getElementById('rainChanceUser').textContent = `${rainChance}%`;
            document.getElementById('rainChanceDescUser').textContent = getRainChanceDescription(rainChance);

            const windSpeedKmh = Math.round((weatherData.wind?.speed || 0) * 3.6);
            document.getElementById('windSpeedUser').textContent = `${windSpeedKmh} km/h`;
            document.getElementById('windDescUser').textContent = getWindDescription(windSpeedKmh);

            document.getElementById('airQualityUser').textContent = `${airQualityIndex} (${airQualityCategory})`;
            document.getElementById('airQualityDescUser').textContent = airQualityDescription;

            // Update hourly mini-forecast strip
            updateHourlyStripUser(forecastSummary);

            console.log('‚úÖ Weather metrics displayed successfully');
        }

        // Display weather error
        function displayWeatherError() {
            document.getElementById('temperatureUser').textContent = '--¬∞C';
            document.getElementById('feelsLikeUser').textContent = '--¬∞C';
            document.getElementById('humidityUser').textContent = '--%';
            document.getElementById('rainChanceUser').textContent = '--%';
            document.getElementById('rainChanceDescUser').textContent = 'Weather data unavailable';
            document.getElementById('windSpeedUser').textContent = '-- km/h';
            document.getElementById('windDescUser').textContent = 'Weather data unavailable';
            document.getElementById('airQualityUser').textContent = '--';
            document.getElementById('airQualityDescUser').textContent = 'Air quality data unavailable';
            const strip = document.getElementById('hourlyStripUser');
            if (strip) {
                strip.innerHTML = '<p class="text-xs text-gray-500">No short-term forecast available.</p>';
            }
        }

        // Compact hourly strip similar to admin dashboard
        function updateHourlyStripUser(forecastSummary) {
            const strip = document.getElementById('hourlyStripUser');
            if (!strip) return;
            if (!forecastSummary || !forecastSummary.next_24h_forecast) {
                strip.innerHTML = '<p class="text-xs text-gray-500">No short-term forecast available.</p>';
                return;
            }

            const hours = forecastSummary.next_24h_forecast.slice(0, 5);
            strip.innerHTML = hours.map(item => {
                const time = new Date(item.time).toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
                const rainChance = Math.round((item.rain_chance || 0) * 100);
                return `
                    <div class="hourly-item">
                        <div class="hourly-time">${time}</div>
                        <div class="hourly-temp">${Math.round(item.temp)}¬∞</div>
                        <div class="hourly-icon">${getWeatherIcon(item.description || '')}</div>
                        <div class="hourly-rain">${rainChance}%</div>
                    </div>
                `;
            }).join('');
        }

        // Weather status functions
        function updateWeatherStatus(status) {
            const statusDot = document.getElementById('weatherStatusDot');
            const statusText = document.getElementById('weatherStatusText');
            
            if (status === 'SUCCESS') {
                statusDot.className = 'w-2 h-2 bg-green-500 rounded-full';
                statusText.textContent = 'Live';
            } else if (status === 'ERROR') {
                statusDot.className = 'w-2 h-2 bg-red-500 rounded-full';
                statusText.textContent = 'Error';
            } else {
                statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full';
                statusText.textContent = 'Loading...';
            }
        }

        // Manual refresh weather
        async function refreshWeather() {
            const refreshBtn = document.getElementById('refreshWeatherBtn');
            const originalText = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refreshing...';
            refreshBtn.disabled = true;
            
            try {
                await loadWeatherData();
                emergencySystem.showSuccess('Weather data refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing weather:', error);
                emergencySystem.showError('Failed to refresh weather data');
            } finally {
                refreshBtn.innerHTML = originalText;
                refreshBtn.disabled = false;
            }
        }

        // Weather status helper functions
        function getRainfallStatus(rainfall) {
            if (rainfall < 1) return 'text-green-600 bg-green-100';
            if (rainfall < 5) return 'text-yellow-600 bg-yellow-100';
            return 'text-red-600 bg-red-100';
        }

        function getRainfallDescription(rainfall) {
            if (rainfall < 1) return 'Light';
            if (rainfall < 5) return 'Moderate';
            return 'Heavy';
        }

        function getRainChanceStatus(chance) {
            if (chance < 30) return 'text-green-600 bg-green-100';
            if (chance < 70) return 'text-yellow-600 bg-yellow-100';
            return 'text-red-600 bg-red-100';
        }

        function getRainChanceDescription(chance) {
            if (chance < 30) return 'Low';
            if (chance < 70) return 'Moderate';
            return 'High';
        }

        function getHeatIndexStatus(heatIndex) {
            if (heatIndex < 32) return 'text-green-600 bg-green-100';
            if (heatIndex < 38) return 'text-yellow-600 bg-yellow-100';
            return 'text-red-600 bg-red-100';
        }

        function getHeatIndexDescription(heatIndex) {
            if (heatIndex < 32) return 'Comfortable';
            if (heatIndex < 38) return 'Hot';
            return 'Dangerous';
        }

        function getWindDescription(windSpeed) {
            if (windSpeed > 30) return 'Strong wind';
            if (windSpeed > 20) return 'High wind';
            if (windSpeed > 10) return 'Moderate wind';
            return 'Calm';
        }

        function getWeatherIcon(description) {
            const icons = {
                // Clear / sunny
                'clear sky': '<i class="bi bi-sun-fill weather-icon weather-icon-sun"></i>',
                // Partly cloudy
                'few clouds': '<i class="bi bi-cloud-sun weather-icon weather-icon-cloud"></i>',
                'scattered clouds': '<i class="bi bi-cloud weather-icon weather-icon-cloud"></i>',
                'broken clouds': '<i class="bi bi-clouds weather-icon weather-icon-cloud"></i>',
                'overcast clouds': '<i class="bi bi-clouds-fill weather-icon weather-icon-cloud"></i>',
                // Rain variants
                'light rain': '<i class="bi bi-cloud-drizzle weather-icon weather-icon-rain"></i>',
                'moderate rain': '<i class="bi bi-cloud-rain weather-icon weather-icon-rain"></i>',
                'heavy rain': '<i class="bi bi-cloud-rain-heavy weather-icon weather-icon-rain"></i>',
                // Thunderstorm
                'thunderstorm': '<i class="bi bi-lightning-fill weather-icon weather-icon-thunder"></i>',
                // Snow / fog
                'snow': '<i class="bi bi-snow weather-icon weather-icon-snow"></i>',
                'mist': '<i class="bi bi-cloud-fog weather-icon weather-icon-fog"></i>',
                'fog': '<i class="bi bi-cloud-fog2 weather-icon weather-icon-fog"></i>'
            };
            
            const key = Object.keys(icons).find(icon => 
                description.toLowerCase().includes(icon.toLowerCase())
            );
            
            // Default to a nice cloud-sun icon if we don't find a more specific match
            return icons[key] || '<i class="bi bi-cloud-sun weather-icon weather-icon-sun"></i>';
        }

        function getAirQualityStatus(category) {
            if (!category) return 'text-green-600 bg-green-100';
            const quality = category.toLowerCase();
            if (quality.includes('excellent') || quality.includes('good')) {
                return 'text-green-600 bg-green-100';
            }
            if (quality.includes('fair') || quality.includes('moderate')) {
                return 'text-yellow-600 bg-yellow-100';
            }
            if (quality.includes('poor') || quality.includes('unhealthy')) {
                return 'text-red-600 bg-red-100';
            }
            return 'text-red-600 bg-red-100';
        }

        // Same AQI calculation as admin early-warning dashboard
        function calculateSimplifiedAQI(pressure, humidity) {
            const baseAQI = 50;
            const pressureFactor = Math.max(0, (1013 - pressure) / 10);
            const humidityFactor = Math.max(0, (humidity - 60) / 20);
            return Math.round(baseAQI + pressureFactor + humidityFactor);
        }

        function getAirQualityCategoryFromIndex(aqi) {
            let category = 'Good';
            let description = 'Healthy air quality.';

            if (aqi <= 19) {
                category = 'Excellent';
                description = 'Ideal air quality; enjoy outdoor activities.';
            } else if (aqi <= 49) {
                category = 'Fair';
                description = 'Generally acceptable; minor risk for sensitive groups.';
            } else if (aqi <= 99) {
                category = 'Poor';
                description = 'Unhealthy for sensitive groups; limit prolonged outdoor exertion.';
            } else if (aqi <= 149) {
                category = 'Unhealthy';
                description = 'Everyone may feel effects; sensitive groups at greater risk.';
            } else if (aqi <= 249) {
                category = 'Very Unhealthy';
                description = 'Health effects likely for everyone; avoid outdoor activity.';
            } else {
                category = 'Dangerous';
                description = 'Serious health effects possible; stay indoors and avoid exposure.';
            }

            return { category, description };
        }

        // Load announcements (both active and resolved)
        async function loadAnnouncements() {
            try {
                console.log('üì¢ Loading announcements...');
                
                const { data: announcements, error } = await emergencySystem.supabase
                    .from('announcements')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('‚ùå Error loading announcements:', error);
                    throw error;
                }

                console.log('üì¢ Loaded announcements:', announcements);

                const announcementsList = document.getElementById('announcementsList');
                
                if (!announcements || announcements.length === 0) {
                    announcementsList.innerHTML = `
                        <div class="text-center py-8">
                            <div class="text-4xl mb-4">üì¢</div>
                            <p class="text-gray-500">No announcements at this time</p>
                            <p class="text-sm text-gray-400 mt-2">Check back later for updates</p>
                        </div>
                    `;
                    return;
                }

                const activeAnnouncements = announcements.filter(a => a.status === 'active');
                const pastAnnouncements = announcements.filter(a => a.status !== 'active');

                const renderAnnouncementCard = (announcement) => `
                    <div class="announcement-card border-l-4 ${getPriorityClass(announcement.priority)} rounded-lg p-4 shadow-sm mb-3">
                        <div class="flex items-start justify-between">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-2xl">${getAnnouncementIcon(announcement.type)}</span>
                                    <h3 class="font-semibold text-gray-900">${announcement.title}</h3>
                                    <span class="px-2 py-1 text-xs rounded-full ${getPriorityBadgeClass(announcement.priority)}">
                                        ${announcement.priority?.toUpperCase?.() || 'NORMAL'}
                                    </span>
                                    ${announcement.status !== 'active' ? `
                                        <span class="px-2 py-1 text-xs rounded-full bg-gray-200 text-gray-700">
                                            ${announcement.status === 'expired' ? 'EXPIRED' : 'RESOLVED'}
                                        </span>
                                    ` : ''}
                                </div>
                                <p class="text-gray-700 mb-3">${announcement.message}</p>
                                <div class="flex items-center justify-between text-sm text-gray-500">
                                    <span>${getTimeAgo(announcement.created_at)}</span>
                                    <span class="capitalize">${announcement.type}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                let html = '';

                if (activeAnnouncements.length > 0) {
                    html += `
                        <h3 class="text-sm font-semibold text-red-600 mb-2 flex items-center gap-2">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                            Active Alerts
                        </h3>
                        ${activeAnnouncements.map(renderAnnouncementCard).join('')}
                    `;
                }

                if (pastAnnouncements.length > 0) {
                    html += `
                        <h3 class="text-sm font-semibold text-gray-600 mt-4 mb-2 flex items-center gap-2">
                            <i class="bi bi-clock-history"></i>
                            Past Alerts & Announcements
                        </h3>
                        ${pastAnnouncements.map(renderAnnouncementCard).join('')}
                    `;
                }

                announcementsList.innerHTML = html;

                console.log('‚úÖ Announcements loaded successfully');
            } catch (error) {
                console.error('‚ùå Failed to load announcements:', error);
                const announcementsList = document.getElementById('announcementsList');
                announcementsList.innerHTML = `
                    <div class="text-center py-8">
                        <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                        <p class="text-gray-500">Failed to load announcements</p>
                        <button onclick="loadAnnouncements()" class="btn btn-outline btn-sm mt-2">
                            <i class="bi bi-arrow-clockwise"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Set up real-time subscription for announcements
        let subscriptionRetryCount = 0;
        const maxRetries = 3;
        
        async function setupAnnouncementsSubscription() {
            try {
                console.log('üì° Setting up announcements subscription...');
                
                // Check if emergencySystem is available
                if (!emergencySystem || !emergencySystem.supabase) {
                    console.warn('‚ö†Ô∏è EmergencySystem not available, skipping real-time subscription');
                    updateConnectionStatus('CHANNEL_ERROR');
                    return;
                }

                const announcementsChannel = emergencySystem.supabase
                    .channel('announcements_channel', {
                        config: {
                            broadcast: { self: false },
                            presence: { key: 'announcements' }
                        }
                    })
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'announcements'
                    }, (payload) => {
                        console.log('üì¢ Announcement update received:', payload);
                        
                        if (payload.eventType === 'INSERT') {
                            showNewAnnouncementNotification(payload.new);
                            
                            // Add to notifications
                            const notificationType = getAnnouncementNotificationType(payload.new.type);
                            const notificationTitle = `${getAnnouncementIcon(payload.new.type)} ${payload.new.title}`;
                            addNotification(notificationTitle, payload.new.message, notificationType, payload.new.id);
                        }
                        
                        // Reload announcements to show updates
                        loadAnnouncements();
                    })
                    .subscribe((status) => {
                        console.log('üì° Announcements subscription status:', status);
                        // Connection status callback (optional - can be implemented later)
                        if (typeof updateConnectionStatus === 'function') {
                            updateConnectionStatus(status);
                        }
                        
                        // If subscription fails, try to reconnect (but limit retries)
                        if ((status === 'CHANNEL_ERROR' || status === 'CLOSED') && subscriptionRetryCount < maxRetries) {
                            subscriptionRetryCount++;
                            console.log(`üîÑ Attempting to reconnect subscription... (${subscriptionRetryCount}/${maxRetries})`);
                            setTimeout(() => {
                                setupAnnouncementsSubscription();
                            }, 10000); // Wait 10 seconds instead of 5
                        } else if (subscriptionRetryCount >= maxRetries) {
                            console.log('‚ö†Ô∏è Real-time subscription failed after multiple attempts. Manual refresh will work.');
                            updateConnectionStatus('CHANNEL_ERROR');
                        }
                    });

                // Also subscribe to notifications table for direct notifications
                const notificationsChannel = emergencySystem.supabase
                    .channel('user-notifications')
                    .on('postgres_changes', {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'notifications',
                        filter: `target_type=eq.reporter`
                    }, (payload) => {
                        console.log('üîî New notification received:', payload.new);
                        if (payload.new) {
                            showNotificationToast(payload.new);
                            syncNotifications();
                        }
                    })
                    .subscribe((status) => {
                        console.log('üì° Notifications subscription status:', status);
                    });

                console.log('‚úÖ Announcements subscription set up successfully');
            } catch (error) {
                console.error('‚ùå Failed to setup announcements subscription:', error);
                updateConnectionStatus('CHANNEL_ERROR');
                
                // Try to reconnect after a delay (but limit retries)
                if (subscriptionRetryCount < maxRetries) {
                    subscriptionRetryCount++;
                    console.log(`üîÑ Retrying subscription setup... (${subscriptionRetryCount}/${maxRetries})`);
                    setTimeout(() => {
                        setupAnnouncementsSubscription();
                    }, 10000); // Wait 10 seconds instead of 5
                } else {
                    console.log('‚ö†Ô∏è Real-time subscription failed after multiple attempts. Manual refresh will work.');
                }
            }
        }

        // Sync notifications for current user
        async function syncNotifications() {
            try {
                const { data, error } = await emergencySystem.supabase.functions.invoke(
                    'sync-notifications',
                    {
                        body: { 
                            limit: 20, 
                            unreadOnly: false 
                        }
                    }
                );

                if (error) throw error;
                
                console.log('‚úÖ Synced notifications:', data);
                return data;
            } catch (error) {
                console.error('‚ùå Failed to sync notifications:', error);
                return null;
            }
        }

        // Show notification toast
        function showNotificationToast(notification) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: white;
                border-left: 4px solid #17a2b8;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                max-width: 400px;
                z-index: 10000;
                animation: slideIn 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: start; gap: 10px;">
                    <div style="font-size: 24px;">üîî</div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 5px;">${notification.title || 'New Notification'}</div>
                        <div style="font-size: 14px; color: #666;">${notification.message || ''}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" style="border: none; background: none; cursor: pointer; font-size: 20px; color: #999;">&times;</button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s ease-out';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }


        // Load all citizen reports
        async function loadRecentReports() {
            try {
                // Check if user is authenticated
                if (!emergencySystem.user) {
                    const reportsList = document.getElementById('reportsList');
                    reportsList.innerHTML = 
                        '<div class="text-center text-gray-500 py-8">' +
                            '<div class="text-4xl mb-4"><i class="bi bi-person-circle"></i></div>' +
                            '<p>Please log in to view reports</p>' +
                        '</div>';
                    return;
                }

                // Get all reports for all citizens (not just current user)
                const reports = await emergencySystem.getReports();
                const reportsList = document.getElementById('reportsList');
                
                if (reports.length === 0) {
                    reportsList.innerHTML = 
                        '<div class="text-center text-gray-500 py-8">' +
                            '<div class="text-4xl mb-4"><i class="bi bi-clipboard"></i></div>' +
                            '<p>No reports submitted yet</p>' +
                        '</div>';
                    return;
                }

                // Sort reports by creation date (newest first)
                const sortedReports = reports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

                reportsList.innerHTML = sortedReports.map(report => {
                    const confidenceHtml = report.confidence ? 
                        '<div class="mt-2">' +
                            '<span class="text-sm text-blue-600"><i class="bi bi-robot"></i> AI Confidence: ' + Math.round(report.confidence * 100) + '%</span>' +
                        '</div>' : '';
                    
                    return '<div class="card">' +
                        '<div class="flex items-center justify-between">' +
                            '<div class="flex-1">' +
                                '<div class="flex items-center gap-4 mb-2">' +
                                    '<h4 class="font-semibold">' + getEmergencyIcon(report.type) + ' ' + (typeof report.type === 'string' ? report.type.toUpperCase() : 'OTHER') + ' Emergency</h4>' +
                                    '<span class="badge badge-' + report.status + '">' + report.status + '</span>' +
                                '</div>' +
                                '<p class="text-sm text-gray-600 mb-2">' + (report.description || 'No description provided') + '</p>' +
                                '<div class="flex items-center gap-4 text-sm text-gray-500">' +
                                    '<span><i class="bi bi-person"></i> ' + (report.reporter_name || 'Anonymous') + '</span>' +
                                    '<span><i class="bi bi-geo-alt"></i> ' + (report.location || 'Location not specified') + '</span>' +
                                    '<span><i class="bi bi-clock"></i> ' + new Date(report.created_at).toLocaleString() + '</span>' +
                                '</div>' +
                                confidenceHtml +
                            '</div>' +
                            '<div class="text-right">' +
                                '<div class="text-sm text-gray-500">Priority</div>' +
                                '<div class="font-semibold text-' + getPriorityColor(report.priority) + '">' + (typeof report.priority === 'string' ? report.priority.toUpperCase() : 'MEDIUM') + '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                }).join('');
            } catch (error) {
                console.error('Failed to load reports:', error);
                const reportsList = document.getElementById('reportsList');
                reportsList.innerHTML = 
                    '<div class="text-center text-gray-500 py-8">' +
                        '<div class="text-4xl mb-4"><i class="bi bi-clipboard"></i></div>' +
                        '<p>No reports available at the moment</p>' +
                        '<p class="text-sm text-gray-400 mt-2">Reports will appear here once submitted</p>' +
                    '</div>';
            }
        }

        // Utility functions
        function getEmergencyIcon(type) {
            const icons = {
                fire: 'üî•',
                medical: 'üè•',
                accident: 'üöó',
                flood: 'üåä',
                earthquake: 'üåç',
                storm: '‚õàÔ∏è',
                other: '‚ö†Ô∏è'
            };
            return icons[type] || '‚ö†Ô∏è';
        }

        function getPriorityColor(priority) {
            const colors = {
                high: 'red-600',
                medium: 'yellow-600',
                low: 'green-600'
            };
            // Handle both string and non-string priorities
            const priorityStr = typeof priority === 'string' ? priority.toLowerCase() : 'medium';
            return colors[priorityStr] || 'yellow-600';
        }

        // Check user role and redirect if necessary
        function checkUserRole() {
            if (!emergencySystem.user) {
                window.location.href = 'login.html';
                return false;
            }
            
            const userRole = emergencySystem.user?.user_metadata?.role || 'citizen';
            
            if (userRole !== 'citizen') {
                // Redirect to appropriate dashboard
                if (userRole === 'responder') {
                    window.location.href = 'responder.html';
                } else if (userRole === 'admin' || userRole === 'super_user') {
                    window.location.href = 'admin.html';
                }
                return false;
            }
            
            return true;
        }


        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for system initialization
            await new Promise(resolve => {
                const checkInit = () => {
                    if (emergencySystem.isInitialized) {
                        resolve();
                    } else {
                        setTimeout(checkInit, 100);
                    }
                };
                checkInit();
            });


            // Check user role
            if (!checkUserRole()) {
                return;
            }

            // Auto-fill user information from login
            if (emergencySystem.user) {
                const user = emergencySystem.user;
                const userMetadata = user.user_metadata || {};
                
                // Set user name and contact from user data
                document.getElementById('reporterName').value = userMetadata.full_name || user.email || 'User';
                document.getElementById('contactNumber').value = userMetadata.phone || '';
                
                // Populate profile dropdown
                document.getElementById('profileUserName').textContent = userMetadata.full_name || user.email || 'User';
                document.getElementById('profileUserEmail').textContent = user.email || '';
                
                console.log('‚úÖ User info auto-filled:', {
                    name: userMetadata.full_name || user.email,
                    email: user.email,
                    role: userMetadata.role
                });
            }

            // Load weather data
            await loadWeatherData();
            
            // Load learning modules (if function exists)
            if (typeof loadLearningModules === 'function') {
                await loadLearningModules();
            } else {
                console.log('‚ÑπÔ∏è Learning modules loader not available');
            }

            // Set up real-time subscription for notifications
            try {
                await setupAnnouncementsSubscription();
            } catch (error) {
                console.warn('‚ö†Ô∏è Real-time subscription failed, but notifications will still work');
            }

            // Try to get location automatically
            try {
                const position = await emergencySystem.getCurrentPosition();
                const address = await emergencySystem.getAddressFromCoordinates(
                    position.coords.latitude, 
                    position.coords.longitude
                );
                
                document.getElementById('location').value = address;
                document.getElementById('locationStatus').textContent = '‚úÖ Location auto-detected';
                document.getElementById('locationStatus').className = 'text-sm text-green-600 mt-2';
            } catch (error) {
                console.log('Auto-location failed:', error);
                document.getElementById('locationStatus').textContent = 'üìç Click "Get Location" to detect your location';
                document.getElementById('locationStatus').className = 'text-sm text-gray-600 mt-2';
            }
        });




        // Notification system
        let notifications = [];
        let unreadCount = 0;

        // Load notifications from localStorage or initialize
        function loadNotifications() {
            const savedNotifications = localStorage.getItem('emergency_notifications');
            if (savedNotifications) {
                notifications = JSON.parse(savedNotifications);
                updateNotificationBadge();
            }
        }

        // Update notification badge count
        function updateNotificationBadge() {
            unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                badge.textContent = unreadCount;
                badge.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        }

        // Add new notification (legacy function for backward compatibility)
        function addNotification(title, message, type = 'info', announcementId = null) {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false,
                announcementId: announcementId // Store announcement ID if provided
            };
            
            notifications.unshift(notification);
            
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            // Save to localStorage
            localStorage.setItem('emergency_notifications', JSON.stringify(notifications));
            
            // Update badge
            updateNotificationBadge();
            
            // Show toast notification
            showToastNotification(notification);
        }

        // Show toast notification
        function showToastNotification(notification) {
            const toast = document.createElement('div');
            toast.className = 'notification-toast';
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: white;
                border-left: 4px solid ${getNotificationColor(notification.type)};
                border-radius: 8px;
                padding: 16px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.3s ease;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <i class="bi bi-${getNotificationIcon(notification.type)}" style="color: ${getNotificationColor(notification.type)}; margin-right: 8px;"></i>
                    <strong style="font-size: 0.9rem;">${notification.title}</strong>
                </div>
                <p style="margin: 0; font-size: 0.8rem; color: #666;">${notification.message}</p>
            `;
            
            document.body.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 5000);
        }

        // Get notification color by type
        function getNotificationColor(type) {
            const colors = {
                'emergency': '#dc2626',
                'warning': '#f59e0b',
                'info': '#3b82f6',
                'success': '#10b981'
            };
            return colors[type] || '#6b7280';
        }

        // Get notification icon by type
        function getNotificationIcon(type) {
            const icons = {
                'emergency': 'exclamation-triangle-fill',
                'warning': 'exclamation-circle-fill',
                'info': 'info-circle-fill',
                'success': 'check-circle-fill'
            };
            return icons[type] || 'bell-fill';
        }

        // Toggle notifications dropdown
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            } else {
                createNotificationsDropdown();
            }
        }

        // Create notifications dropdown
        function createNotificationsDropdown() {
            const dropdown = document.createElement('div');
            dropdown.id = 'notificationsDropdown';
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                width: 350px;
                max-height: 400px;
                overflow-y: auto;
                z-index: 1000;
            `;
            
            dropdown.innerHTML = `
                <div style="padding: 16px; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.1rem; color: #374151;">Latest Announcements & Alerts</h3>
                        <button onclick="refreshNotifications()" style="background: none; border: none; color: #6b7280; cursor: pointer; padding: 4px;" title="Refresh">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </div>
                <div id="notificationsList" style="max-height: 300px; overflow-y: auto;">
                    ${renderNotificationsList()}
                </div>
                <div style="padding: 12px; border-top: 1px solid #e5e7eb; text-align: center;">
                    <button onclick="markAllAsRead()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 8px;">
                        Mark All as Read
                    </button>
                    <button onclick="viewAllAnnouncements()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        View All
                    </button>
                </div>
            `;
            
            const container = document.querySelector('.notification-container');
            container.appendChild(dropdown);
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!container.contains(e.target)) {
                    dropdown.style.display = 'none';
                }
            });
        }

        // Render notifications list
        function renderNotificationsList() {
            if (notifications.length === 0) {
                return '<div style="padding: 20px; text-align: center; color: #6b7280;">No notifications yet</div>';
            }
            
            return notifications.map(notification => `
                <div class="notification-item" style="padding: 12px; border-bottom: 1px solid #f3f4f6; cursor: pointer; ${!notification.read ? 'background: #f8fafc;' : ''}" onclick="markAsRead(${notification.id})">
                    <div style="display: flex; align-items: flex-start;">
                        <i class="bi bi-${getNotificationIcon(notification.type)}" style="color: ${getNotificationColor(notification.type)}; margin-right: 8px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 500; font-size: 0.9rem; margin-bottom: 4px;">${notification.title}</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">${notification.message}</div>
                            <div style="font-size: 0.7rem; color: #9ca3af;">${new Date(notification.timestamp).toLocaleString()}</div>
                        </div>
                        ${!notification.read ? '<div style="width: 8px; height: 8px; background: #3b82f6; border-radius: 50%; margin-left: 8px;"></div>' : ''}
                    </div>
                </div>
            `).join('');
        }

        // Mark notification as read
        function markAsRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                localStorage.setItem('emergency_notifications', JSON.stringify(notifications));
                updateNotificationBadge();
                
                // Update the dropdown if it exists
                const dropdown = document.getElementById('notificationsDropdown');
                if (dropdown) {
                    const list = document.getElementById('notificationsList');
                    if (list) {
                        list.innerHTML = renderNotificationsList();
                    }
                }
            }
        }

        // Mark all notifications as read
        function markAllAsRead() {
            notifications.forEach(notification => {
                notification.read = true;
            });
            localStorage.setItem('emergency_notifications', JSON.stringify(notifications));
            updateNotificationBadge();
            
            // Update the dropdown if it exists
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                const list = document.getElementById('notificationsList');
                if (list) {
                    list.innerHTML = renderNotificationsList();
                }
            }
        }

        // Refresh notifications
        async function refreshNotifications() {
            try {
                await loadAnnouncementsAsNotifications();
                const dropdown = document.getElementById('notificationsDropdown');
                if (dropdown) {
                    const list = document.getElementById('notificationsList');
                    if (list) {
                        list.innerHTML = renderNotificationsList();
                    }
                }
                emergencySystem.showSuccess('Notifications refreshed!');
            } catch (error) {
                console.error('Failed to refresh notifications:', error);
                emergencySystem.showError('Failed to refresh notifications');
            }
        }

        // View all announcements
        function viewAllAnnouncements() {
            // Redirect to announcements page or show a message
            emergencySystem.showInfo('üì¢ All announcements are now available in the notification dropdown. Click the bell icon to view them.');
            
            // Close dropdown
            const dropdown = document.getElementById('notificationsDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        // Initialize notifications on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadNotifications();
            loadAnnouncementsAsNotifications();
            
            // Add some demo notifications (remove in production)
            if (notifications.length === 0) {
                addNotification('Welcome!', 'Welcome to Kapiyu Emergency System', 'info');
            }
        });

        // Load announcements as notifications
        async function loadAnnouncementsAsNotifications() {
            try {
                if (!emergencySystem || !emergencySystem.supabase) {
                    console.log('Emergency system not available for notifications');
                    return;
                }

                const { data: announcements, error } = await emergencySystem.supabase
                    .from('announcements')
                    .select('*')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) {
                    console.error('Error loading announcements for notifications:', error);
                    return;
                }

                if (announcements && announcements.length > 0) {
                    // Check if we already have these announcements as notifications
                    const existingNotificationIds = notifications.map(n => n.announcementId).filter(Boolean);
                    
                    announcements.forEach(announcement => {
                        // Only add if not already in notifications
                        if (!existingNotificationIds.includes(announcement.id)) {
                            const notificationType = getAnnouncementNotificationType(announcement.type);
                            const notificationTitle = `${getAnnouncementIcon(announcement.type)} ${announcement.title}`;
                            
                            addNotification(
                                notificationTitle,
                                announcement.message,
                                notificationType,
                                announcement.id // Store announcement ID for reference
                            );
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to load announcements as notifications:', error);
            }
        }

        // Get notification type based on announcement type
        function getAnnouncementNotificationType(announcementType) {
            const typeMap = {
                'emergency': 'emergency',
                'weather': 'warning',
                'general': 'info',
                'maintenance': 'warning',
                'safety': 'info'
            };
            return typeMap[announcementType] || 'info';
        }

        // Get announcement icon
        function getAnnouncementIcon(type) {
            const icons = {
                'emergency': 'üö®',
                'weather': 'üå§Ô∏è',
                'general': 'üì¢',
                'maintenance': 'üîß',
                'safety': 'üõ°Ô∏è'
            };
            return icons[type] || 'üì¢';
        }

        // Enhanced add notification function to support announcement ID
        function addNotification(title, message, type = 'info', announcementId = null) {
            const notification = {
                id: Date.now(),
                title: title,
                message: message,
                type: type,
                timestamp: new Date().toISOString(),
                read: false,
                announcementId: announcementId // Store announcement ID if provided
            };
            
            notifications.unshift(notification);
            
            // Keep only last 50 notifications
            if (notifications.length > 50) {
                notifications = notifications.slice(0, 50);
            }
            
            // Save to localStorage
            localStorage.setItem('emergency_notifications', JSON.stringify(notifications));
            
            // Update badge
            updateNotificationBadge();
            
            // Show toast notification
            showToastNotification(notification);
        }
    </script>

    <style>
        /* Notification animations */
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Notification button hover effect */
        .notification-btn:hover {
            transform: scale(1.1);
            transition: transform 0.2s ease;
        }

        /* Profile button hover effect */
        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            transform: scale(1.05);
        }

        /* Profile dropdown hover effects */
        .profile-dropdown button:hover {
            background: #f3f4f6 !important;
        }

        .profile-dropdown button:active {
            background: #e5e7eb !important;
        }

        /* Override navbar-nav flex-direction for notification area */
        .navbar-nav [data-auth="required"] {
            display: flex !important;
            flex-direction: row !important;
            align-items: center !important;
            gap: 15px !important;
        }

        /* Weather Dashboard Styles */
        .weather-metric-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .weather-metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .weather-metric-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .weather-metric-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #6b7280;
            margin: 0;
            letter-spacing: 0.05em;
        }

        .weather-metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
        }

        .weather-metric-status {
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
            color: #6b7280;
        }

        /* Color-coded status backgrounds */
        .text-green-600.bg-green-100 {
            color: #059669 !important;
            background-color: #dcfce7 !important;
        }

        .text-yellow-600.bg-yellow-100 {
            color: #d97706 !important;
            background-color: #fef3c7 !important;
        }

        .text-red-600.bg-red-100 {
            color: #dc2626 !important;
            background-color: #fee2e2 !important;
        }

        /* Grid responsive layout */
        .grid {
            display: grid;
            gap: 1rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }

        @media (min-width: 768px) {
            .md\:grid-cols-4 {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .col-span-2 {
            grid-column: span 2;
        }

        @media (min-width: 768px) {
            .md\:col-span-4 {
                grid-column: span 4;
            }
        }

        /* Safety Tips Modal */
        .modal-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(2px);
        }
        
        .modal-overlay.hidden { 
            display: none !important; 
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 95%;
            max-width: 1200px;
            max-height: 90vh;
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            z-index: 10001;
            animation: modalSlideIn 0.3s ease-out;
            overflow-y: auto;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -52%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            border-bottom: 2px solid #e5e7eb;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            border-radius: 16px 16px 0 0;
        }
        
        .modal-header h2 {
            color: white !important;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }
        
        .modal-header i {
            color: white;
        }
        
        .modal-body {
            padding: 2rem;
            background: #f9fafb;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            cursor: pointer;
            color: white;
            transition: all 0.2s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg);
        }

        /* Reused evacuation styles */
        .safety-instruction {
            background: linear-gradient(135deg, #f0f9ff 0%, #ffffff 100%);
            border-left: 4px solid #3b82f6;
            padding: 1rem 1.25rem;
            margin: 0.75rem 0;
            border-radius: 10px;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
            transition: all 0.2s ease;
        }
        
        .safety-instruction:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .emergency-contact {
            background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%);
            border: 2px solid #f59e0b;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.1);
            transition: all 0.2s ease;
        }
        
        .emergency-contact:hover {
            box-shadow: 0 4px 16px rgba(245, 158, 11, 0.2);
            transform: translateY(-2px);
        }
        
        .evacuation-route {
            background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%);
            border: 2px solid #10b981;
            padding: 1.25rem;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
            transition: all 0.2s ease;
        }
        
        .evacuation-route:hover {
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }
        
        /* Enhanced card styling for modal */
        .modal-body .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            margin-bottom: 1.5rem;
        }
        
        .modal-body .card-header {
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
            border-bottom: 2px solid #e5e7eb;
            padding: 1.25rem 1.5rem;
        }
        
        .modal-body .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #111827;
            margin: 0;
        }
        
        .modal-body .card-body {
            padding: 1.5rem;
        }
        
        /* Video container styling */
        .modal-body iframe {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
    </style>
</body>
</html>
